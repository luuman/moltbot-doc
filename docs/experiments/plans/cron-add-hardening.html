<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-experiments/plans/cron-add-hardening" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Cron Add Hardening &amp; Schema Alignment | Moltbot Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://luuman.github.io/moltbot-doc/docs/experiments/plans/cron-add-hardening"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Cron Add Hardening &amp; Schema Alignment | Moltbot Docs"><meta data-rh="true" name="description" content="Context"><meta data-rh="true" property="og:description" content="Context"><link data-rh="true" rel="icon" href="/moltbot-doc/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luuman.github.io/moltbot-doc/docs/experiments/plans/cron-add-hardening"><link data-rh="true" rel="alternate" href="https://luuman.github.io/moltbot-doc/docs/experiments/plans/cron-add-hardening" hreflang="zh"><link data-rh="true" rel="alternate" href="https://luuman.github.io/moltbot-doc/docs/experiments/plans/cron-add-hardening" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/moltbot-doc/blog/rss.xml" title="Moltbot Docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/moltbot-doc/blog/atom.xml" title="Moltbot Docs Atom Feed"><link rel="stylesheet" href="/moltbot-doc/assets/css/styles.484b4c98.css">
<script src="/moltbot-doc/assets/js/runtime~main.6cf495cf.js" defer="defer"></script>
<script src="/moltbot-doc/assets/js/main.f9205183.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"dark"),document.documentElement.setAttribute("data-theme-choice",t||"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav class="navbar navbar--fixed-top navbar_MONK" role="navigation" aria-label="Main"><div class="navbarInner_ASTH"><div class="navbarLeft_pUmY"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="brand_SXL9" href="/moltbot-doc/"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="var(--ifm-color-primary)"></rect><path d="M7 8.5h10M7 12h7M7 15.5h10" stroke="white" stroke-width="1.8" stroke-linecap="round"></path></svg><span class="brandTitle_XbyU">Moltbot</span></a><div class="dropdown_GrgZ"><button class="dropdownToggle_Nf_z">全部站点<svg class="dropdownArrow_Eka8" viewBox="0 0 12 12" fill="none"><path d="M2 4l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></button><ul class="dropdownMenu_zsxH"><li><a href="https://luuman.github.io/docs-workspace/docs" class="dropdownMenuItem_VBaP">Workspace</a></li><li><a href="https://luuman.github.io/claude-doc/docs" class="dropdownMenuItem_VBaP">Claude</a></li><li><a href="https://luuman.github.io/electron-doc/docs" class="dropdownMenuItem_VBaP">Electron</a></li><li><a href="https://luuman.github.io/tauri-doc/docs" class="dropdownMenuItem_VBaP">Tauri</a></li><li><a href="https://luuman.github.io/matrx-doc/docs" class="dropdownMenuItem_VBaP">Matrx</a></li><li><a href="https://luuman.github.io/brainboard-doc/docs" class="dropdownMenuItem_VBaP">Brainboard</a></li><li><a href="https://luuman.github.io/synology-doc/docs" class="dropdownMenuItem_VBaP">Synology</a></li><li><a href="https://luuman.github.io/codex-doc/docs" class="dropdownMenuItem_VBaP">Codex</a></li><li><a href="https://luuman.github.io/ai-doc/docs" class="dropdownMenuItem_VBaP">AI</a></li></ul></div></div><div class="navbarCenter_Zdr3"><div class="root_OF3s"><span class="icon_UcOK" aria-hidden="true"><svg viewBox="0 0 24 24" fill="currentColor" width="15" height="15"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg></span><div class="slot__FGx"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="搜索" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div class="navbarRight_q16u"><a class="navLink_RnnM" href="/moltbot-doc/docs">Docs</a><a class="navLink_RnnM" href="/moltbot-doc/blog">Blog</a><button class="themeToggle_zD_x" aria-label="Switch to light theme" title="Light"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"></path></svg></button></div></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Cron Add Hardening &amp; Schema Alignment</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="context">Context<a href="#context" class="hash-link" aria-label="Context的直接链接" title="Context的直接链接" translate="no">​</a></h2>
<p>Recent gateway logs show repeated <code>cron.add</code> failures with invalid parameters (missing <code>sessionTarget</code>, <code>wakeMode</code>, <code>payload</code>, and malformed <code>schedule</code>). This indicates that at least one client (likely the agent tool call path) is sending wrapped or partially specified job payloads. Separately, there is drift between cron provider enums in TypeScript, gateway schema, CLI flags, and UI form types, plus a UI mismatch for <code>cron.status</code> (expects <code>jobCount</code> while gateway returns <code>jobs</code>).</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Goals的直接链接" title="Goals的直接链接" translate="no">​</a></h2>
<ul>
<li class="">Stop <code>cron.add</code> INVALID_REQUEST spam by normalizing common wrapper payloads and inferring missing <code>kind</code> fields.</li>
<li class="">Align cron provider lists across gateway schema, cron types, CLI docs, and UI forms.</li>
<li class="">Make agent cron tool schema explicit so the LLM produces correct job payloads.</li>
<li class="">Fix the Control UI cron status job count display.</li>
<li class="">Add tests to cover normalization and tool behavior.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="non-goals">Non-goals<a href="#non-goals" class="hash-link" aria-label="Non-goals的直接链接" title="Non-goals的直接链接" translate="no">​</a></h2>
<ul>
<li class="">Change cron scheduling semantics or job execution behavior.</li>
<li class="">Add new schedule kinds or cron expression parsing.</li>
<li class="">Overhaul the UI/UX for cron beyond the necessary field fixes.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="findings-current-gaps">Findings (current gaps)<a href="#findings-current-gaps" class="hash-link" aria-label="Findings (current gaps)的直接链接" title="Findings (current gaps)的直接链接" translate="no">​</a></h2>
<ul>
<li class=""><code>CronPayloadSchema</code> in gateway excludes <code>signal</code> + <code>imessage</code>, while TS types include them.</li>
<li class="">Control UI CronStatus expects <code>jobCount</code>, but gateway returns <code>jobs</code>.</li>
<li class="">Agent cron tool schema allows arbitrary <code>job</code> objects, enabling malformed inputs.</li>
<li class="">Gateway strictly validates <code>cron.add</code> with no normalization, so wrapped payloads fail.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-changed">What changed<a href="#what-changed" class="hash-link" aria-label="What changed的直接链接" title="What changed的直接链接" translate="no">​</a></h2>
<ul>
<li class=""><code>cron.add</code> and <code>cron.update</code> now normalize common wrapper shapes and infer missing <code>kind</code> fields.</li>
<li class="">Agent cron tool schema matches the gateway schema, which reduces invalid payloads.</li>
<li class="">Provider enums are aligned across gateway, CLI, UI, and macOS picker.</li>
<li class="">Control UI uses the gateway’s <code>jobs</code> count field for status.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="current-behavior">Current behavior<a href="#current-behavior" class="hash-link" aria-label="Current behavior的直接链接" title="Current behavior的直接链接" translate="no">​</a></h2>
<ul>
<li class=""><strong>Normalization:</strong> wrapped <code>data</code>/<code>job</code> payloads are unwrapped; <code>schedule.kind</code> and <code>payload.kind</code> are inferred when safe.</li>
<li class=""><strong>Defaults:</strong> safe defaults are applied for <code>wakeMode</code> and <code>sessionTarget</code> when missing.</li>
<li class=""><strong>Providers:</strong> Discord/Slack/Signal/iMessage are now consistently surfaced across CLI/UI.</li>
</ul>
<p>See <a class="" href="/moltbot-doc/automation/cron-jobs">Cron jobs</a> for the normalized shape and examples.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="verification">Verification<a href="#verification" class="hash-link" aria-label="Verification的直接链接" title="Verification的直接链接" translate="no">​</a></h2>
<ul>
<li class="">Watch gateway logs for reduced <code>cron.add</code> INVALID_REQUEST errors.</li>
<li class="">Confirm Control UI cron status shows job count after refresh.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="optional-follow-ups">Optional Follow-ups<a href="#optional-follow-ups" class="hash-link" aria-label="Optional Follow-ups的直接链接" title="Optional Follow-ups的直接链接" translate="no">​</a></h2>
<ul>
<li class="">Manual Control UI smoke: add a cron job per provider + verify status job count.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="open-questions">Open Questions<a href="#open-questions" class="hash-link" aria-label="Open Questions的直接链接" title="Open Questions的直接链接" translate="no">​</a></h2>
<ul>
<li class="">Should <code>cron.add</code> accept explicit <code>state</code> from clients (currently disallowed by schema)?</li>
<li class="">Should we allow <code>webchat</code> as an explicit delivery provider (currently filtered in delivery resolution)?</li>
</ul></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"></nav></div></div><div class="col col--3"><div class="tocWrapper_xKoj"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a></li><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#non-goals" class="table-of-contents__link toc-highlight">Non-goals</a></li><li><a href="#findings-current-gaps" class="table-of-contents__link toc-highlight">Findings (current gaps)</a></li><li><a href="#what-changed" class="table-of-contents__link toc-highlight">What changed</a></li><li><a href="#current-behavior" class="table-of-contents__link toc-highlight">Current behavior</a></li><li><a href="#verification" class="table-of-contents__link toc-highlight">Verification</a></li><li><a href="#optional-follow-ups" class="table-of-contents__link toc-highlight">Optional Follow-ups</a></li><li><a href="#open-questions" class="table-of-contents__link toc-highlight">Open Questions</a></li></ul></div><div class="tocFooter_Fu2z"><div class="themeGroup_RzWV" role="group" aria-label="Theme"><button class="themeBtn_tGr6" aria-label="Light theme" title="Light"><svg viewBox="0 0 24 24" width="15" height="15" fill="currentColor" aria-hidden="true"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"></path></svg></button><button class="themeBtn_tGr6 themeBtnActive_A6tm" aria-label="Dark theme" title="Dark"><svg viewBox="0 0 24 24" width="15" height="15" fill="currentColor" aria-hidden="true"><path d="M11.38 2.019a7.5 7.5 0 1 0 10.6 10.6C21.83 17.963 17.315 22 12.002 22 6.477 22 2 17.523 2 12c0-5.314 4.038-9.827 9.38-10.28z"></path></svg></button></div></div></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Moltbot Docs.</div></div></div></footer></div>
</body>
</html>