<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-refactor/exec-host" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Exec host refactor plan | Moltbot Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://luuman.github.io/moltbot-doc/docs/refactor/exec-host"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Exec host refactor plan | Moltbot Docs"><meta data-rh="true" name="description" content="Goals"><meta data-rh="true" property="og:description" content="Goals"><link data-rh="true" rel="icon" href="/moltbot-doc/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luuman.github.io/moltbot-doc/docs/refactor/exec-host"><link data-rh="true" rel="alternate" href="https://luuman.github.io/moltbot-doc/docs/refactor/exec-host" hreflang="zh"><link data-rh="true" rel="alternate" href="https://luuman.github.io/moltbot-doc/docs/refactor/exec-host" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/moltbot-doc/blog/rss.xml" title="Moltbot Docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/moltbot-doc/blog/atom.xml" title="Moltbot Docs Atom Feed"><link rel="stylesheet" href="/moltbot-doc/assets/css/styles.484b4c98.css">
<script src="/moltbot-doc/assets/js/runtime~main.6cf495cf.js" defer="defer"></script>
<script src="/moltbot-doc/assets/js/main.f9205183.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"dark"),document.documentElement.setAttribute("data-theme-choice",t||"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav class="navbar navbar--fixed-top navbar_MONK" role="navigation" aria-label="Main"><div class="navbarInner_ASTH"><div class="navbarLeft_pUmY"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="brand_SXL9" href="/moltbot-doc/"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="var(--ifm-color-primary)"></rect><path d="M7 8.5h10M7 12h7M7 15.5h10" stroke="white" stroke-width="1.8" stroke-linecap="round"></path></svg><span class="brandTitle_XbyU">Moltbot</span></a><div class="dropdown_GrgZ"><button class="dropdownToggle_Nf_z">全部站点<svg class="dropdownArrow_Eka8" viewBox="0 0 12 12" fill="none"><path d="M2 4l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></button><ul class="dropdownMenu_zsxH"><li><a href="https://luuman.github.io/docs-workspace/docs" class="dropdownMenuItem_VBaP">Workspace</a></li><li><a href="https://luuman.github.io/claude-doc/docs" class="dropdownMenuItem_VBaP">Claude</a></li><li><a href="https://luuman.github.io/electron-doc/docs" class="dropdownMenuItem_VBaP">Electron</a></li><li><a href="https://luuman.github.io/tauri-doc/docs" class="dropdownMenuItem_VBaP">Tauri</a></li><li><a href="https://luuman.github.io/matrx-doc/docs" class="dropdownMenuItem_VBaP">Matrx</a></li><li><a href="https://luuman.github.io/brainboard-doc/docs" class="dropdownMenuItem_VBaP">Brainboard</a></li><li><a href="https://luuman.github.io/synology-doc/docs" class="dropdownMenuItem_VBaP">Synology</a></li><li><a href="https://luuman.github.io/codex-doc/docs" class="dropdownMenuItem_VBaP">Codex</a></li><li><a href="https://luuman.github.io/ai-doc/docs" class="dropdownMenuItem_VBaP">AI</a></li></ul></div></div><div class="navbarCenter_Zdr3"><div class="root_OF3s"><span class="icon_UcOK" aria-hidden="true"><svg viewBox="0 0 24 24" fill="currentColor" width="15" height="15"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg></span><div class="slot__FGx"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="搜索" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div class="navbarRight_q16u"><a class="navLink_RnnM" href="/moltbot-doc/docs">Docs</a><a class="navLink_RnnM" href="/moltbot-doc/blog">Blog</a><button class="themeToggle_zD_x" aria-label="Switch to light theme" title="Light"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"></path></svg></button></div></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Exec host refactor plan</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Goals的直接链接" title="Goals的直接链接" translate="no">​</a></h2>
<ul>
<li class="">Add <code>exec.host</code> + <code>exec.security</code> to route execution across <strong>sandbox</strong>, <strong>gateway</strong>, and <strong>node</strong>.</li>
<li class="">Keep defaults <strong>safe</strong>: no cross-host execution unless explicitly enabled.</li>
<li class="">Split execution into a <strong>headless runner service</strong> with optional UI (macOS app) via local IPC.</li>
<li class="">Provide <strong>per-agent</strong> policy, allowlist, ask mode, and node binding.</li>
<li class="">Support <strong>ask modes</strong> that work <em>with</em> or <em>without</em> allowlists.</li>
<li class="">Cross-platform: Unix socket + token auth (macOS/Linux/Windows parity).</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="non-goals">Non-goals<a href="#non-goals" class="hash-link" aria-label="Non-goals的直接链接" title="Non-goals的直接链接" translate="no">​</a></h2>
<ul>
<li class="">No legacy allowlist migration or legacy schema support.</li>
<li class="">No PTY/streaming for node exec (aggregated output only).</li>
<li class="">No new network layer beyond the existing Bridge + Gateway.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="decisions-locked">Decisions (locked)<a href="#decisions-locked" class="hash-link" aria-label="Decisions (locked)的直接链接" title="Decisions (locked)的直接链接" translate="no">​</a></h2>
<ul>
<li class=""><strong>Config keys:</strong> <code>exec.host</code> + <code>exec.security</code> (per-agent override allowed).</li>
<li class=""><strong>Elevation:</strong> keep <code>/elevated</code> as an alias for gateway full access.</li>
<li class=""><strong>Ask default:</strong> <code>on-miss</code>.</li>
<li class=""><strong>Approvals store:</strong> <code>~/.clawdbot/exec-approvals.json</code> (JSON, no legacy migration).</li>
<li class=""><strong>Runner:</strong> headless system service; UI app hosts a Unix socket for approvals.</li>
<li class=""><strong>Node identity:</strong> use existing <code>nodeId</code>.</li>
<li class=""><strong>Socket auth:</strong> Unix socket + token (cross-platform); split later if needed.</li>
<li class=""><strong>Node host state:</strong> <code>~/.clawdbot/node.json</code> (node id + pairing token).</li>
<li class=""><strong>macOS exec host:</strong> run <code>system.run</code> inside the macOS app; node host service forwards requests over local IPC.</li>
<li class=""><strong>No XPC helper:</strong> stick to Unix socket + token + peer checks.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="key-concepts">Key concepts<a href="#key-concepts" class="hash-link" aria-label="Key concepts的直接链接" title="Key concepts的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="host">Host<a href="#host" class="hash-link" aria-label="Host的直接链接" title="Host的直接链接" translate="no">​</a></h3>
<ul>
<li class=""><code>sandbox</code>: Docker exec (current behavior).</li>
<li class=""><code>gateway</code>: exec on gateway host.</li>
<li class=""><code>node</code>: exec on node runner via Bridge (<code>system.run</code>).</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="security-mode">Security mode<a href="#security-mode" class="hash-link" aria-label="Security mode的直接链接" title="Security mode的直接链接" translate="no">​</a></h3>
<ul>
<li class=""><code>deny</code>: always block.</li>
<li class=""><code>allowlist</code>: allow only matches.</li>
<li class=""><code>full</code>: allow everything (equivalent to elevated).</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="ask-mode">Ask mode<a href="#ask-mode" class="hash-link" aria-label="Ask mode的直接链接" title="Ask mode的直接链接" translate="no">​</a></h3>
<ul>
<li class=""><code>off</code>: never ask.</li>
<li class=""><code>on-miss</code>: ask only when allowlist does not match.</li>
<li class=""><code>always</code>: ask every time.</li>
</ul>
<p>Ask is <strong>independent</strong> of allowlist; allowlist can be used with <code>always</code> or <code>on-miss</code>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="policy-resolution-per-exec">Policy resolution (per exec)<a href="#policy-resolution-per-exec" class="hash-link" aria-label="Policy resolution (per exec)的直接链接" title="Policy resolution (per exec)的直接链接" translate="no">​</a></h3>
<ol>
<li class="">Resolve <code>exec.host</code> (tool param → agent override → global default).</li>
<li class="">Resolve <code>exec.security</code> and <code>exec.ask</code> (same precedence).</li>
<li class="">If host is <code>sandbox</code>, proceed with local sandbox exec.</li>
<li class="">If host is <code>gateway</code> or <code>node</code>, apply security + ask policy on that host.</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="default-safety">Default safety<a href="#default-safety" class="hash-link" aria-label="Default safety的直接链接" title="Default safety的直接链接" translate="no">​</a></h2>
<ul>
<li class="">Default <code>exec.host = sandbox</code>.</li>
<li class="">Default <code>exec.security = deny</code> for <code>gateway</code> and <code>node</code>.</li>
<li class="">Default <code>exec.ask = on-miss</code> (only relevant if security allows).</li>
<li class="">If no node binding is set, <strong>agent may target any node</strong>, but only if policy allows it.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="config-surface">Config surface<a href="#config-surface" class="hash-link" aria-label="Config surface的直接链接" title="Config surface的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="tool-parameters">Tool parameters<a href="#tool-parameters" class="hash-link" aria-label="Tool parameters的直接链接" title="Tool parameters的直接链接" translate="no">​</a></h3>
<ul>
<li class=""><code>exec.host</code> (optional): <code>sandbox | gateway | node</code>.</li>
<li class=""><code>exec.security</code> (optional): <code>deny | allowlist | full</code>.</li>
<li class=""><code>exec.ask</code> (optional): <code>off | on-miss | always</code>.</li>
<li class=""><code>exec.node</code> (optional): node id/name to use when <code>host=node</code>.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="config-keys-global">Config keys (global)<a href="#config-keys-global" class="hash-link" aria-label="Config keys (global)的直接链接" title="Config keys (global)的直接链接" translate="no">​</a></h3>
<ul>
<li class=""><code>tools.exec.host</code></li>
<li class=""><code>tools.exec.security</code></li>
<li class=""><code>tools.exec.ask</code></li>
<li class=""><code>tools.exec.node</code> (default node binding)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="config-keys-per-agent">Config keys (per agent)<a href="#config-keys-per-agent" class="hash-link" aria-label="Config keys (per agent)的直接链接" title="Config keys (per agent)的直接链接" translate="no">​</a></h3>
<ul>
<li class=""><code>agents.list[].tools.exec.host</code></li>
<li class=""><code>agents.list[].tools.exec.security</code></li>
<li class=""><code>agents.list[].tools.exec.ask</code></li>
<li class=""><code>agents.list[].tools.exec.node</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="alias">Alias<a href="#alias" class="hash-link" aria-label="Alias的直接链接" title="Alias的直接链接" translate="no">​</a></h3>
<ul>
<li class=""><code>/elevated on</code> = set <code>tools.exec.host=gateway</code>, <code>tools.exec.security=full</code> for the agent session.</li>
<li class=""><code>/elevated off</code> = restore previous exec settings for the agent session.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="approvals-store-json">Approvals store (JSON)<a href="#approvals-store-json" class="hash-link" aria-label="Approvals store (JSON)的直接链接" title="Approvals store (JSON)的直接链接" translate="no">​</a></h2>
<p>Path: <code>~/.clawdbot/exec-approvals.json</code></p>
<p>Purpose:</p>
<ul>
<li class="">Local policy + allowlists for the <strong>execution host</strong> (gateway or node runner).</li>
<li class="">Ask fallback when no UI is available.</li>
<li class="">IPC credentials for UI clients.</li>
</ul>
<p>Proposed schema (v1):</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D6DEEB;--prism-background-color:#001122"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#D6DEEB;background-color:#001122"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D6DEEB"><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token property" style="color:#F78C6C">&quot;version&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">1</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token property" style="color:#F78C6C">&quot;socket&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token property" style="color:#F78C6C">&quot;path&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&quot;~/.clawdbot/exec-approvals.sock&quot;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token property" style="color:#F78C6C">&quot;token&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&quot;base64-opaque-token&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token property" style="color:#F78C6C">&quot;defaults&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token property" style="color:#F78C6C">&quot;security&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&quot;deny&quot;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token property" style="color:#F78C6C">&quot;ask&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&quot;on-miss&quot;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token property" style="color:#F78C6C">&quot;askFallback&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&quot;deny&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token property" style="color:#F78C6C">&quot;agents&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token property" style="color:#F78C6C">&quot;agent-id-1&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token property" style="color:#F78C6C">&quot;security&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&quot;allowlist&quot;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token property" style="color:#F78C6C">&quot;ask&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&quot;on-miss&quot;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token property" style="color:#F78C6C">&quot;allowlist&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token property" style="color:#F78C6C">&quot;pattern&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&quot;~/Projects/**/bin/rg&quot;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token property" style="color:#F78C6C">&quot;lastUsedAt&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">0</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token property" style="color:#F78C6C">&quot;lastUsedCommand&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&quot;rg -n TODO&quot;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token property" style="color:#F78C6C">&quot;lastResolvedPath&quot;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&quot;/Users/user/Projects/.../bin/rg&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><br></span></code></pre></div></div>
<p>Notes:</p>
<ul>
<li class="">No legacy allowlist formats.</li>
<li class=""><code>askFallback</code> applies only when <code>ask</code> is required and no UI is reachable.</li>
<li class="">File permissions: <code>0600</code>.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="runner-service-headless">Runner service (headless)<a href="#runner-service-headless" class="hash-link" aria-label="Runner service (headless)的直接链接" title="Runner service (headless)的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="role">Role<a href="#role" class="hash-link" aria-label="Role的直接链接" title="Role的直接链接" translate="no">​</a></h3>
<ul>
<li class="">Enforce <code>exec.security</code> + <code>exec.ask</code> locally.</li>
<li class="">Execute system commands and return output.</li>
<li class="">Emit Bridge events for exec lifecycle (optional but recommended).</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="service-lifecycle">Service lifecycle<a href="#service-lifecycle" class="hash-link" aria-label="Service lifecycle的直接链接" title="Service lifecycle的直接链接" translate="no">​</a></h3>
<ul>
<li class="">Launchd/daemon on macOS; system service on Linux/Windows.</li>
<li class="">Approvals JSON is local to the execution host.</li>
<li class="">UI hosts a local Unix socket; runners connect on demand.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="ui-integration-macos-app">UI integration (macOS app)<a href="#ui-integration-macos-app" class="hash-link" aria-label="UI integration (macOS app)的直接链接" title="UI integration (macOS app)的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="ipc">IPC<a href="#ipc" class="hash-link" aria-label="IPC的直接链接" title="IPC的直接链接" translate="no">​</a></h3>
<ul>
<li class="">Unix socket at <code>~/.clawdbot/exec-approvals.sock</code> (0600).</li>
<li class="">Token stored in <code>exec-approvals.json</code> (0600).</li>
<li class="">Peer checks: same-UID only.</li>
<li class="">Challenge/response: nonce + HMAC(token, request-hash) to prevent replay.</li>
<li class="">Short TTL (e.g., 10s) + max payload + rate limit.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="ask-flow-macos-app-exec-host">Ask flow (macOS app exec host)<a href="#ask-flow-macos-app-exec-host" class="hash-link" aria-label="Ask flow (macOS app exec host)的直接链接" title="Ask flow (macOS app exec host)的直接链接" translate="no">​</a></h3>
<ol>
<li class="">Node service receives <code>system.run</code> from gateway.</li>
<li class="">Node service connects to the local socket and sends the prompt/exec request.</li>
<li class="">App validates peer + token + HMAC + TTL, then shows dialog if needed.</li>
<li class="">App executes the command in UI context and returns output.</li>
<li class="">Node service returns output to gateway.</li>
</ol>
<p>If UI missing:</p>
<ul>
<li class="">Apply <code>askFallback</code> (<code>deny|allowlist|full</code>).</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="diagram-sci">Diagram (SCI)<a href="#diagram-sci" class="hash-link" aria-label="Diagram (SCI)的直接链接" title="Diagram (SCI)的直接链接" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D6DEEB;--prism-background-color:#001122"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#D6DEEB;background-color:#001122"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D6DEEB"><span class="token plain">Agent -&gt; Gateway -&gt; Bridge -&gt; Node Service (TS)</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">                         |  IPC (UDS + token + HMAC + TTL)</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">                         v</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">                     Mac App (UI + TCC + system.run)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="node-identity--binding">Node identity + binding<a href="#node-identity--binding" class="hash-link" aria-label="Node identity + binding的直接链接" title="Node identity + binding的直接链接" translate="no">​</a></h2>
<ul>
<li class="">Use existing <code>nodeId</code> from Bridge pairing.</li>
<li class="">Binding model:
<ul>
<li class=""><code>tools.exec.node</code> restricts the agent to a specific node.</li>
<li class="">If unset, agent can pick any node (policy still enforces defaults).</li>
</ul>
</li>
<li class="">Node selection resolution:
<ul>
<li class=""><code>nodeId</code> exact match</li>
<li class=""><code>displayName</code> (normalized)</li>
<li class=""><code>remoteIp</code></li>
<li class=""><code>nodeId</code> prefix (&gt;= 6 chars)</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="eventing">Eventing<a href="#eventing" class="hash-link" aria-label="Eventing的直接链接" title="Eventing的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="who-sees-events">Who sees events<a href="#who-sees-events" class="hash-link" aria-label="Who sees events的直接链接" title="Who sees events的直接链接" translate="no">​</a></h3>
<ul>
<li class="">System events are <strong>per session</strong> and shown to the agent on the next prompt.</li>
<li class="">Stored in the gateway in-memory queue (<code>enqueueSystemEvent</code>).</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="event-text">Event text<a href="#event-text" class="hash-link" aria-label="Event text的直接链接" title="Event text的直接链接" translate="no">​</a></h3>
<ul>
<li class=""><code>Exec started (node=&lt;id&gt;, id=&lt;runId&gt;)</code></li>
<li class=""><code>Exec finished (node=&lt;id&gt;, id=&lt;runId&gt;, code=&lt;code&gt;)</code> + optional output tail</li>
<li class=""><code>Exec denied (node=&lt;id&gt;, id=&lt;runId&gt;, &lt;reason&gt;)</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="transport">Transport<a href="#transport" class="hash-link" aria-label="Transport的直接链接" title="Transport的直接链接" translate="no">​</a></h3>
<p>Option A (recommended):</p>
<ul>
<li class="">Runner sends Bridge <code>event</code> frames <code>exec.started</code> / <code>exec.finished</code>.</li>
<li class="">Gateway <code>handleBridgeEvent</code> maps these into <code>enqueueSystemEvent</code>.</li>
</ul>
<p>Option B:</p>
<ul>
<li class="">Gateway <code>exec</code> tool handles lifecycle directly (synchronous only).</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="exec-flows">Exec flows<a href="#exec-flows" class="hash-link" aria-label="Exec flows的直接链接" title="Exec flows的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="sandbox-host">Sandbox host<a href="#sandbox-host" class="hash-link" aria-label="Sandbox host的直接链接" title="Sandbox host的直接链接" translate="no">​</a></h3>
<ul>
<li class="">Existing <code>exec</code> behavior (Docker or host when unsandboxed).</li>
<li class="">PTY supported in non-sandbox mode only.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="gateway-host">Gateway host<a href="#gateway-host" class="hash-link" aria-label="Gateway host的直接链接" title="Gateway host的直接链接" translate="no">​</a></h3>
<ul>
<li class="">Gateway process executes on its own machine.</li>
<li class="">Enforces local <code>exec-approvals.json</code> (security/ask/allowlist).</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="node-host">Node host<a href="#node-host" class="hash-link" aria-label="Node host的直接链接" title="Node host的直接链接" translate="no">​</a></h3>
<ul>
<li class="">Gateway calls <code>node.invoke</code> with <code>system.run</code>.</li>
<li class="">Runner enforces local approvals.</li>
<li class="">Runner returns aggregated stdout/stderr.</li>
<li class="">Optional Bridge events for start/finish/deny.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="output-caps">Output caps<a href="#output-caps" class="hash-link" aria-label="Output caps的直接链接" title="Output caps的直接链接" translate="no">​</a></h2>
<ul>
<li class="">Cap combined stdout+stderr at <strong>200k</strong>; keep <strong>tail 20k</strong> for events.</li>
<li class="">Truncate with a clear suffix (e.g., <code>&quot;… (truncated)&quot;</code>).</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="slash-commands">Slash commands<a href="#slash-commands" class="hash-link" aria-label="Slash commands的直接链接" title="Slash commands的直接链接" translate="no">​</a></h2>
<ul>
<li class=""><code>/exec host=&lt;sandbox|gateway|node&gt; security=&lt;deny|allowlist|full&gt; ask=&lt;off|on-miss|always&gt; node=&lt;id&gt;</code></li>
<li class="">Per-agent, per-session overrides; non-persistent unless saved via config.</li>
<li class=""><code>/elevated on|off|ask|full</code> remains a shortcut for <code>host=gateway security=full</code> (with <code>full</code> skipping approvals).</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="cross-platform-story">Cross-platform story<a href="#cross-platform-story" class="hash-link" aria-label="Cross-platform story的直接链接" title="Cross-platform story的直接链接" translate="no">​</a></h2>
<ul>
<li class="">The runner service is the portable execution target.</li>
<li class="">UI is optional; if missing, <code>askFallback</code> applies.</li>
<li class="">Windows/Linux support the same approvals JSON + socket protocol.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="implementation-phases">Implementation phases<a href="#implementation-phases" class="hash-link" aria-label="Implementation phases的直接链接" title="Implementation phases的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="phase-1-config--exec-routing">Phase 1: config + exec routing<a href="#phase-1-config--exec-routing" class="hash-link" aria-label="Phase 1: config + exec routing的直接链接" title="Phase 1: config + exec routing的直接链接" translate="no">​</a></h3>
<ul>
<li class="">Add config schema for <code>exec.host</code>, <code>exec.security</code>, <code>exec.ask</code>, <code>exec.node</code>.</li>
<li class="">Update tool plumbing to respect <code>exec.host</code>.</li>
<li class="">Add <code>/exec</code> slash command and keep <code>/elevated</code> alias.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="phase-2-approvals-store--gateway-enforcement">Phase 2: approvals store + gateway enforcement<a href="#phase-2-approvals-store--gateway-enforcement" class="hash-link" aria-label="Phase 2: approvals store + gateway enforcement的直接链接" title="Phase 2: approvals store + gateway enforcement的直接链接" translate="no">​</a></h3>
<ul>
<li class="">Implement <code>exec-approvals.json</code> reader/writer.</li>
<li class="">Enforce allowlist + ask modes for <code>gateway</code> host.</li>
<li class="">Add output caps.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="phase-3-node-runner-enforcement">Phase 3: node runner enforcement<a href="#phase-3-node-runner-enforcement" class="hash-link" aria-label="Phase 3: node runner enforcement的直接链接" title="Phase 3: node runner enforcement的直接链接" translate="no">​</a></h3>
<ul>
<li class="">Update node runner to enforce allowlist + ask.</li>
<li class="">Add Unix socket prompt bridge to macOS app UI.</li>
<li class="">Wire <code>askFallback</code>.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="phase-4-events">Phase 4: events<a href="#phase-4-events" class="hash-link" aria-label="Phase 4: events的直接链接" title="Phase 4: events的直接链接" translate="no">​</a></h3>
<ul>
<li class="">Add node → gateway Bridge events for exec lifecycle.</li>
<li class="">Map to <code>enqueueSystemEvent</code> for agent prompts.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="phase-5-ui-polish">Phase 5: UI polish<a href="#phase-5-ui-polish" class="hash-link" aria-label="Phase 5: UI polish的直接链接" title="Phase 5: UI polish的直接链接" translate="no">​</a></h3>
<ul>
<li class="">Mac app: allowlist editor, per-agent switcher, ask policy UI.</li>
<li class="">Node binding controls (optional).</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="testing-plan">Testing plan<a href="#testing-plan" class="hash-link" aria-label="Testing plan的直接链接" title="Testing plan的直接链接" translate="no">​</a></h2>
<ul>
<li class="">Unit tests: allowlist matching (glob + case-insensitive).</li>
<li class="">Unit tests: policy resolution precedence (tool param → agent override → global).</li>
<li class="">Integration tests: node runner deny/allow/ask flows.</li>
<li class="">Bridge event tests: node event → system event routing.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="open-risks">Open risks<a href="#open-risks" class="hash-link" aria-label="Open risks的直接链接" title="Open risks的直接链接" translate="no">​</a></h2>
<ul>
<li class="">UI unavailability: ensure <code>askFallback</code> is respected.</li>
<li class="">Long-running commands: rely on timeout + output caps.</li>
<li class="">Multi-node ambiguity: error unless node binding or explicit node param.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="related-docs">Related docs<a href="#related-docs" class="hash-link" aria-label="Related docs的直接链接" title="Related docs的直接链接" translate="no">​</a></h2>
<ul>
<li class=""><a class="" href="/moltbot-doc/tools/exec">Exec tool</a></li>
<li class=""><a class="" href="/moltbot-doc/tools/exec-approvals">Exec approvals</a></li>
<li class=""><a class="" href="/moltbot-doc/nodes">Nodes</a></li>
<li class=""><a class="" href="/moltbot-doc/tools/elevated">Elevated mode</a></li>
</ul></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"></nav></div></div><div class="col col--3"><div class="tocWrapper_xKoj"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#non-goals" class="table-of-contents__link toc-highlight">Non-goals</a></li><li><a href="#decisions-locked" class="table-of-contents__link toc-highlight">Decisions (locked)</a></li><li><a href="#key-concepts" class="table-of-contents__link toc-highlight">Key concepts</a><ul><li><a href="#host" class="table-of-contents__link toc-highlight">Host</a></li><li><a href="#security-mode" class="table-of-contents__link toc-highlight">Security mode</a></li><li><a href="#ask-mode" class="table-of-contents__link toc-highlight">Ask mode</a></li><li><a href="#policy-resolution-per-exec" class="table-of-contents__link toc-highlight">Policy resolution (per exec)</a></li></ul></li><li><a href="#default-safety" class="table-of-contents__link toc-highlight">Default safety</a></li><li><a href="#config-surface" class="table-of-contents__link toc-highlight">Config surface</a><ul><li><a href="#tool-parameters" class="table-of-contents__link toc-highlight">Tool parameters</a></li><li><a href="#config-keys-global" class="table-of-contents__link toc-highlight">Config keys (global)</a></li><li><a href="#config-keys-per-agent" class="table-of-contents__link toc-highlight">Config keys (per agent)</a></li><li><a href="#alias" class="table-of-contents__link toc-highlight">Alias</a></li></ul></li><li><a href="#approvals-store-json" class="table-of-contents__link toc-highlight">Approvals store (JSON)</a></li><li><a href="#runner-service-headless" class="table-of-contents__link toc-highlight">Runner service (headless)</a><ul><li><a href="#role" class="table-of-contents__link toc-highlight">Role</a></li><li><a href="#service-lifecycle" class="table-of-contents__link toc-highlight">Service lifecycle</a></li></ul></li><li><a href="#ui-integration-macos-app" class="table-of-contents__link toc-highlight">UI integration (macOS app)</a><ul><li><a href="#ipc" class="table-of-contents__link toc-highlight">IPC</a></li><li><a href="#ask-flow-macos-app-exec-host" class="table-of-contents__link toc-highlight">Ask flow (macOS app exec host)</a></li><li><a href="#diagram-sci" class="table-of-contents__link toc-highlight">Diagram (SCI)</a></li></ul></li><li><a href="#node-identity--binding" class="table-of-contents__link toc-highlight">Node identity + binding</a></li><li><a href="#eventing" class="table-of-contents__link toc-highlight">Eventing</a><ul><li><a href="#who-sees-events" class="table-of-contents__link toc-highlight">Who sees events</a></li><li><a href="#event-text" class="table-of-contents__link toc-highlight">Event text</a></li><li><a href="#transport" class="table-of-contents__link toc-highlight">Transport</a></li></ul></li><li><a href="#exec-flows" class="table-of-contents__link toc-highlight">Exec flows</a><ul><li><a href="#sandbox-host" class="table-of-contents__link toc-highlight">Sandbox host</a></li><li><a href="#gateway-host" class="table-of-contents__link toc-highlight">Gateway host</a></li><li><a href="#node-host" class="table-of-contents__link toc-highlight">Node host</a></li></ul></li><li><a href="#output-caps" class="table-of-contents__link toc-highlight">Output caps</a></li><li><a href="#slash-commands" class="table-of-contents__link toc-highlight">Slash commands</a></li><li><a href="#cross-platform-story" class="table-of-contents__link toc-highlight">Cross-platform story</a></li><li><a href="#implementation-phases" class="table-of-contents__link toc-highlight">Implementation phases</a><ul><li><a href="#phase-1-config--exec-routing" class="table-of-contents__link toc-highlight">Phase 1: config + exec routing</a></li><li><a href="#phase-2-approvals-store--gateway-enforcement" class="table-of-contents__link toc-highlight">Phase 2: approvals store + gateway enforcement</a></li><li><a href="#phase-3-node-runner-enforcement" class="table-of-contents__link toc-highlight">Phase 3: node runner enforcement</a></li><li><a href="#phase-4-events" class="table-of-contents__link toc-highlight">Phase 4: events</a></li><li><a href="#phase-5-ui-polish" class="table-of-contents__link toc-highlight">Phase 5: UI polish</a></li></ul></li><li><a href="#testing-plan" class="table-of-contents__link toc-highlight">Testing plan</a></li><li><a href="#open-risks" class="table-of-contents__link toc-highlight">Open risks</a></li><li><a href="#related-docs" class="table-of-contents__link toc-highlight">Related docs</a></li></ul></div><div class="tocFooter_Fu2z"><div class="themeGroup_RzWV" role="group" aria-label="Theme"><button class="themeBtn_tGr6" aria-label="Light theme" title="Light"><svg viewBox="0 0 24 24" width="15" height="15" fill="currentColor" aria-hidden="true"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"></path></svg></button><button class="themeBtn_tGr6 themeBtnActive_A6tm" aria-label="Dark theme" title="Dark"><svg viewBox="0 0 24 24" width="15" height="15" fill="currentColor" aria-hidden="true"><path d="M11.38 2.019a7.5 7.5 0 1 0 10.6 10.6C21.83 17.963 17.315 22 12.002 22 6.477 22 2 17.523 2 12c0-5.314 4.038-9.827 9.38-10.28z"></path></svg></button></div></div></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Moltbot Docs.</div></div></div></footer></div>
</body>
</html>