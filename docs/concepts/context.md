---
summary: "上下文：模型看到的内容、构建方式和检查方法"
read_when:
  - 您想了解“上下文”在 Moltbot 中的含义时
  - 您正在调试模型为什么“知道”某些内容（或忘记了它）时
  - 您想减少上下文开销（/context、/status、/compact）时
---
# 上下文

“上下文”是 **Moltbot 发送给模型进行运行的所有内容**。它受模型的 **上下文窗口**（token 限制）限制。

初学者心智模型：
- **系统提示**（Moltbot 构建）：规则、工具、技能列表、时间/运行时和注入的工作区文件。
- **对话历史**：您的消息 + 此会话的助手消息。
- **工具调用/结果 + 附件**：命令输出、文件读取、图像/音频等。

上下文与“记忆”*不是同一回事*：记忆可以存储在磁盘上并稍后重新加载；上下文是模型当前窗口内的内容。

## 快速入门（检查上下文）

- `/status` → 快速“我的窗口有多满？”视图 + 会话设置。
- `/context list` → 注入的内容 + 大致大小（每个文件 + 总计）。
- `/context detail` → 更深入的分解：每个文件、每个工具架构大小、每个技能条目大小和系统提示大小。
- `/usage tokens` → 将每个回复使用情况页脚附加到正常回复。
- `/compact` → 将较旧的历史汇总为紧凑条目以释放窗口空间。

另见：[斜杠命令](/tools/slash-commands)，[Token 使用和成本](/token-use)，[压缩](/concepts/compaction)。

## 示例输出

值因模型、提供商、工具策略和工作区中的内容而异。

### `/context list`

```
🧠 上下文分解
工作区：<workspaceDir>
引导最大/文件：20,000 字符
沙盒：模式=非主 沙盒=false
系统提示（运行）：38,412 字符（~9,603 tok）（项目上下文 23,901 字符（~5,976 tok））

注入的工作区文件：
- AGENTS.md：OK | 原始 1,742 字符（~436 tok）| 注入 1,742 字符（~436 tok）
- SOUL.md：OK | 原始 912 字符（~228 tok）| 注入 912 字符（~228 tok）
- TOOLS.md：截断 | 原始 54,210 字符（~13,553 tok）| 注入 20,962 字符（~5,241 tok）
- IDENTITY.md：OK | 原始 211 字符（~53 tok）| 注入 211 字符（~53 tok）
- USER.md：OK | 原始 388 字符（~97 tok）| 注入 388 字符（~97 tok）
- HEARTBEAT.md：缺失 | 原始 0 | 注入 0
- BOOTSTRAP.md：OK | 原始 0 字符（~0 tok）| 注入 0 字符（~0 tok）

技能列表（系统提示文本）：2,184 字符（~546 tok）（12 项技能）
工具：read, edit, write, exec, process, browser, message, sessions_send, …
工具列表（系统提示文本）：1,032 字符（~258 tok）
工具架构（JSON）：31,988 字符（~7,997 tok）（计入上下文；不显示为文本）
工具：（与上述相同）

会话令牌（缓存）：总计 14,250 / ctx=32,000
```

### `/context detail`

```
🧠 上下文分解（详细）
…
顶级技能（提示条目大小）：
- frontend-design：412 字符（~103 tok）
- oracle：401 字符（~101 tok）
…（+10 个更多技能）

顶级工具（架构大小）：
- browser：9,812 字符（~2,453 tok）
- exec：6,240 字符（~1,560 tok）
…（+N 个更多工具）
```

## 什么计入上下文窗口

模型接收的所有内容都计入，包括：
- 系统提示（所有部分）。
- 对话历史。
- 工具调用 + 工具结果。
- 附件/记录（图像/音频/文件）。
- 压缩摘要和修剪工件。
- 提供商“包装器”或隐藏标头（不可见，仍会计入）。

## Moltbot 如何构建系统提示

系统提示是 **Moltbot 拥有的**，并在每次运行时重建。它包括：
- 工具列表 + 简短描述。
- 技能列表（仅元数据；见下文）。
- 工作区位置。
- 时间（UTC + 配置时转换的用户时间）。
- 运行时元数据（主机/操作系统/模型/思考）。
- 在 **项目上下文** 下注入的工作区引导文件。

完整分解：[系统提示](/concepts/system-prompt)。

## 注入的工作区文件（项目上下文）

默认情况下，Moltbot 注入一组固定的工区文件（如果存在）：
- `AGENTS.md`
- `SOUL.md`
- `TOOLS.md`
- `IDENTITY.md`
- `USER.md`
- `HEARTBEAT.md`
- `BOOTSTRAP.md`（仅首次运行）

大型文件按文件截断，使用 `agents.defaults.bootstrapMaxChars`（默认 `20000` 字符）。`/context` 显示 **原始 vs 注入** 大小和是否发生截断。

## 技能：注入的内容 vs 按需加载

系统提示包括一个紧凑的 **技能列表**（名称 + 描述 + 位置）。此列表有实际开销。

技能说明默认不包含。模型应该只在需要时 `read` 技能的 `SKILL.md`。

## 工具：有两种成本

工具以两种方式影响上下文：
1) 系统提示中的 **工具列表文本**（您看到的“工具”）。
2) **工具架构**（JSON）。这些被发送给模型，以便它可以调用工具。即使您看不到它们作为纯文本，它们也会计入上下文。

`/context detail` 分解最大的工具架构，以便您可以看到主导的是什么。

## 命令、指令和“内联快捷方式”

斜杠命令由网关处理。有几种不同的行为：
- **独立命令**：仅 `/...` 的消息作为命令运行。
- **指令**：`/think`、`/verbose`、`/reasoning`、`/elevated`、`/model`、`/queue` 在模型看到消息之前被移除。
  - 仅指令消息保持会话设置。
  - 正常消息中的内联指令作为每消息提示。
- **内联快捷方式**（仅允许列表发送者）：正常消息中的某些 `/...` 标记可以立即运行（示例：“嘿 /status”），并在模型看到剩余文本之前被移除。

详情：[斜杠命令](/tools/slash-commands)。

## 会话、压缩和修剪（持久化的内容）

消息间持久化的内容取决于机制：
- **普通历史** 在会话记录中持久化，直到按策略压缩/修剪。
- **压缩** 将摘要持久化到记录中并保持最近消息不变。
- **修剪** 从运行的 *内存中* 提示中删除旧工具结果，但不会重写记录。

文档：[会话](/concepts/session)，[压缩](/concepts/compaction)，[会话修剪](/concepts/session-pruning)。

## `/context` 实际报告的内容

`/context` 优先使用最新的 **运行构建** 系统提示报告（如果可用）：
- `系统提示（运行）` = 从最后一个嵌入（具有工具能力）运行捕获并保留在会话存储中。
- `系统提示（估计）` = 在没有运行报告时（或在不生成报告的 CLI 后端运行时）动态计算。

无论哪种方式，它都报告大小和主要贡献者；它 **不** 转储完整的系统提示或工具架构。