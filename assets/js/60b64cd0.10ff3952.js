"use strict";(globalThis.webpackChunkdocs_workspace=globalThis.webpackChunkdocs_workspace||[]).push([[5470],{83884(e,n,s){s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"concepts/agent-loop","title":"Agent Loop (Moltbot)","description":"An agentic loop is the full \u201creal\u201d run of an agent: intake \u2192 context assembly \u2192 model inference \u2192","source":"@site/content/moltbot/docs/concepts/agent-loop.md","sourceDirName":"concepts","slug":"/concepts/agent-loop","permalink":"/moltbot-doc/docs/concepts/agent-loop","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"summary":"Agent loop lifecycle, streams, and wait semantics","read_when":["You need an exact walkthrough of the agent loop or lifecycle events"]},"sidebar":"tutorialSidebar","previous":{"title":"\u4ee3\u7406","permalink":"/moltbot-doc/docs/concepts/agent"},"next":{"title":"\u4ee3\u7406\u5de5\u4f5c\u7a7a\u95f4","permalink":"/moltbot-doc/docs/concepts/agent-workspace"}}');var t=s(74848),o=s(28453);const l={summary:"Agent loop lifecycle, streams, and wait semantics",read_when:["You need an exact walkthrough of the agent loop or lifecycle events"]},r="Agent Loop (Moltbot)",a={},c=[{value:"Entry points",id:"entry-points",level:2},{value:"How it works (high-level)",id:"how-it-works-high-level",level:2},{value:"Queueing + concurrency",id:"queueing--concurrency",level:2},{value:"Session + workspace preparation",id:"session--workspace-preparation",level:2},{value:"Prompt assembly + system prompt",id:"prompt-assembly--system-prompt",level:2},{value:"Hook points (where you can intercept)",id:"hook-points-where-you-can-intercept",level:2},{value:"Internal hooks (Gateway hooks)",id:"internal-hooks-gateway-hooks",level:3},{value:"Plugin hooks (agent + gateway lifecycle)",id:"plugin-hooks-agent--gateway-lifecycle",level:3},{value:"Streaming + partial replies",id:"streaming--partial-replies",level:2},{value:"Tool execution + messaging tools",id:"tool-execution--messaging-tools",level:2},{value:"Reply shaping + suppression",id:"reply-shaping--suppression",level:2},{value:"Compaction + retries",id:"compaction--retries",level:2},{value:"Event streams (today)",id:"event-streams-today",level:2},{value:"Chat channel handling",id:"chat-channel-handling",level:2},{value:"Timeouts",id:"timeouts",level:2},{value:"Where things can end early",id:"where-things-can-end-early",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"agent-loop-moltbot",children:"Agent Loop (Moltbot)"})}),"\n",(0,t.jsx)(n.p,{children:"An agentic loop is the full \u201creal\u201d run of an agent: intake \u2192 context assembly \u2192 model inference \u2192\ntool execution \u2192 streaming replies \u2192 persistence. It\u2019s the authoritative path that turns a message\ninto actions and a final reply, while keeping session state consistent."}),"\n",(0,t.jsx)(n.p,{children:"In Moltbot, a loop is a single, serialized run per session that emits lifecycle and stream events\nas the model thinks, calls tools, and streams output. This doc explains how that authentic loop is\nwired end-to-end."}),"\n",(0,t.jsx)(n.h2,{id:"entry-points",children:"Entry points"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Gateway RPC: ",(0,t.jsx)(n.code,{children:"agent"})," and ",(0,t.jsx)(n.code,{children:"agent.wait"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["CLI: ",(0,t.jsx)(n.code,{children:"agent"})," command."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"how-it-works-high-level",children:"How it works (high-level)"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"agent"})," RPC validates params, resolves session (sessionKey/sessionId), persists session metadata, returns ",(0,t.jsx)(n.code,{children:"{ runId, acceptedAt }"})," immediately."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"agentCommand"})," runs the agent:\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"resolves model + thinking/verbose defaults"}),"\n",(0,t.jsx)(n.li,{children:"loads skills snapshot"}),"\n",(0,t.jsxs)(n.li,{children:["calls ",(0,t.jsx)(n.code,{children:"runEmbeddedPiAgent"})," (pi-agent-core runtime)"]}),"\n",(0,t.jsxs)(n.li,{children:["emits ",(0,t.jsx)(n.strong,{children:"lifecycle end/error"})," if the embedded loop does not emit one"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"runEmbeddedPiAgent"}),":\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"serializes runs via per-session + global queues"}),"\n",(0,t.jsx)(n.li,{children:"resolves model + auth profile and builds the pi session"}),"\n",(0,t.jsx)(n.li,{children:"subscribes to pi events and streams assistant/tool deltas"}),"\n",(0,t.jsx)(n.li,{children:"enforces timeout -> aborts run if exceeded"}),"\n",(0,t.jsx)(n.li,{children:"returns payloads + usage metadata"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"subscribeEmbeddedPiSession"})," bridges pi-agent-core events to Moltbot ",(0,t.jsx)(n.code,{children:"agent"})," stream:\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["tool events => ",(0,t.jsx)(n.code,{children:'stream: "tool"'})]}),"\n",(0,t.jsxs)(n.li,{children:["assistant deltas => ",(0,t.jsx)(n.code,{children:'stream: "assistant"'})]}),"\n",(0,t.jsxs)(n.li,{children:["lifecycle events => ",(0,t.jsx)(n.code,{children:'stream: "lifecycle"'})," (",(0,t.jsx)(n.code,{children:'phase: "start" | "end" | "error"'}),")"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"agent.wait"})," uses ",(0,t.jsx)(n.code,{children:"waitForAgentJob"}),":\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["waits for ",(0,t.jsx)(n.strong,{children:"lifecycle end/error"})," for ",(0,t.jsx)(n.code,{children:"runId"})]}),"\n",(0,t.jsxs)(n.li,{children:["returns ",(0,t.jsx)(n.code,{children:"{ status: ok|error|timeout, startedAt, endedAt, error? }"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"queueing--concurrency",children:"Queueing + concurrency"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Runs are serialized per session key (session lane) and optionally through a global lane."}),"\n",(0,t.jsx)(n.li,{children:"This prevents tool/session races and keeps session history consistent."}),"\n",(0,t.jsxs)(n.li,{children:["Messaging channels can choose queue modes (collect/steer/followup) that feed this lane system.\nSee ",(0,t.jsx)(n.a,{href:"/concepts/queue",children:"Command Queue"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"session--workspace-preparation",children:"Session + workspace preparation"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Workspace is resolved and created; sandboxed runs may redirect to a sandbox workspace root."}),"\n",(0,t.jsx)(n.li,{children:"Skills are loaded (or reused from a snapshot) and injected into env and prompt."}),"\n",(0,t.jsx)(n.li,{children:"Bootstrap/context files are resolved and injected into the system prompt report."}),"\n",(0,t.jsxs)(n.li,{children:["A session write lock is acquired; ",(0,t.jsx)(n.code,{children:"SessionManager"})," is opened and prepared before streaming."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"prompt-assembly--system-prompt",children:"Prompt assembly + system prompt"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"System prompt is built from Moltbot\u2019s base prompt, skills prompt, bootstrap context, and per-run overrides."}),"\n",(0,t.jsx)(n.li,{children:"Model-specific limits and compaction reserve tokens are enforced."}),"\n",(0,t.jsxs)(n.li,{children:["See ",(0,t.jsx)(n.a,{href:"/concepts/system-prompt",children:"System prompt"})," for what the model sees."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"hook-points-where-you-can-intercept",children:"Hook points (where you can intercept)"}),"\n",(0,t.jsx)(n.p,{children:"Moltbot has two hook systems:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Internal hooks"})," (Gateway hooks): event-driven scripts for commands and lifecycle events."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Plugin hooks"}),": extension points inside the agent/tool lifecycle and gateway pipeline."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"internal-hooks-gateway-hooks",children:"Internal hooks (Gateway hooks)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"agent:bootstrap"})}),": runs while building bootstrap files before the system prompt is finalized.\nUse this to add/remove bootstrap context files."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Command hooks"}),": ",(0,t.jsx)(n.code,{children:"/new"}),", ",(0,t.jsx)(n.code,{children:"/reset"}),", ",(0,t.jsx)(n.code,{children:"/stop"}),", and other command events (see Hooks doc)."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["See ",(0,t.jsx)(n.a,{href:"/hooks",children:"Hooks"})," for setup and examples."]}),"\n",(0,t.jsx)(n.h3,{id:"plugin-hooks-agent--gateway-lifecycle",children:"Plugin hooks (agent + gateway lifecycle)"}),"\n",(0,t.jsx)(n.p,{children:"These run inside the agent loop or gateway pipeline:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"before_agent_start"})}),": inject context or override system prompt before the run starts."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"agent_end"})}),": inspect the final message list and run metadata after completion."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"before_compaction"})," / ",(0,t.jsx)(n.code,{children:"after_compaction"})]}),": observe or annotate compaction cycles."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"before_tool_call"})," / ",(0,t.jsx)(n.code,{children:"after_tool_call"})]}),": intercept tool params/results."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"tool_result_persist"})}),": synchronously transform tool results before they are written to the session transcript."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"message_received"})," / ",(0,t.jsx)(n.code,{children:"message_sending"})," / ",(0,t.jsx)(n.code,{children:"message_sent"})]}),": inbound + outbound message hooks."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"session_start"})," / ",(0,t.jsx)(n.code,{children:"session_end"})]}),": session lifecycle boundaries."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"gateway_start"})," / ",(0,t.jsx)(n.code,{children:"gateway_stop"})]}),": gateway lifecycle events."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["See ",(0,t.jsx)(n.a,{href:"/plugin#plugin-hooks",children:"Plugins"})," for the hook API and registration details."]}),"\n",(0,t.jsx)(n.h2,{id:"streaming--partial-replies",children:"Streaming + partial replies"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Assistant deltas are streamed from pi-agent-core and emitted as ",(0,t.jsx)(n.code,{children:"assistant"})," events."]}),"\n",(0,t.jsxs)(n.li,{children:["Block streaming can emit partial replies either on ",(0,t.jsx)(n.code,{children:"text_end"})," or ",(0,t.jsx)(n.code,{children:"message_end"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"Reasoning streaming can be emitted as a separate stream or as block replies."}),"\n",(0,t.jsxs)(n.li,{children:["See ",(0,t.jsx)(n.a,{href:"/concepts/streaming",children:"Streaming"})," for chunking and block reply behavior."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"tool-execution--messaging-tools",children:"Tool execution + messaging tools"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Tool start/update/end events are emitted on the ",(0,t.jsx)(n.code,{children:"tool"})," stream."]}),"\n",(0,t.jsx)(n.li,{children:"Tool results are sanitized for size and image payloads before logging/emitting."}),"\n",(0,t.jsx)(n.li,{children:"Messaging tool sends are tracked to suppress duplicate assistant confirmations."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"reply-shaping--suppression",children:"Reply shaping + suppression"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Final payloads are assembled from:\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"assistant text (and optional reasoning)"}),"\n",(0,t.jsx)(n.li,{children:"inline tool summaries (when verbose + allowed)"}),"\n",(0,t.jsx)(n.li,{children:"assistant error text when the model errors"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"NO_REPLY"})," is treated as a silent token and filtered from outgoing payloads."]}),"\n",(0,t.jsx)(n.li,{children:"Messaging tool duplicates are removed from the final payload list."}),"\n",(0,t.jsx)(n.li,{children:"If no renderable payloads remain and a tool errored, a fallback tool error reply is emitted\n(unless a messaging tool already sent a user-visible reply)."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"compaction--retries",children:"Compaction + retries"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Auto-compaction emits ",(0,t.jsx)(n.code,{children:"compaction"})," stream events and can trigger a retry."]}),"\n",(0,t.jsx)(n.li,{children:"On retry, in-memory buffers and tool summaries are reset to avoid duplicate output."}),"\n",(0,t.jsxs)(n.li,{children:["See ",(0,t.jsx)(n.a,{href:"/concepts/compaction",children:"Compaction"})," for the compaction pipeline."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"event-streams-today",children:"Event streams (today)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"lifecycle"}),": emitted by ",(0,t.jsx)(n.code,{children:"subscribeEmbeddedPiSession"})," (and as a fallback by ",(0,t.jsx)(n.code,{children:"agentCommand"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"assistant"}),": streamed deltas from pi-agent-core"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"tool"}),": streamed tool events from pi-agent-core"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"chat-channel-handling",children:"Chat channel handling"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Assistant deltas are buffered into chat ",(0,t.jsx)(n.code,{children:"delta"})," messages."]}),"\n",(0,t.jsxs)(n.li,{children:["A chat ",(0,t.jsx)(n.code,{children:"final"})," is emitted on ",(0,t.jsx)(n.strong,{children:"lifecycle end/error"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"timeouts",children:"Timeouts"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"agent.wait"})," default: 30s (just the wait). ",(0,t.jsx)(n.code,{children:"timeoutMs"})," param overrides."]}),"\n",(0,t.jsxs)(n.li,{children:["Agent runtime: ",(0,t.jsx)(n.code,{children:"agents.defaults.timeoutSeconds"})," default 600s; enforced in ",(0,t.jsx)(n.code,{children:"runEmbeddedPiAgent"})," abort timer."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"where-things-can-end-early",children:"Where things can end early"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Agent timeout (abort)"}),"\n",(0,t.jsx)(n.li,{children:"AbortSignal (cancel)"}),"\n",(0,t.jsx)(n.li,{children:"Gateway disconnect or RPC timeout"}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"agent.wait"})," timeout (wait-only, does not stop agent)"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453(e,n,s){s.d(n,{R:()=>l,x:()=>r});var i=s(96540);const t={},o=i.createContext(t);function l(e){const n=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);