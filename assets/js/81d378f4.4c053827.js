"use strict";(globalThis.webpackChunkdocs_workspace=globalThis.webpackChunkdocs_workspace||[]).push([[4906],{90568(e,n,s){s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"gateway/protocol","title":"Gateway protocol (WebSocket)","description":"The Gateway WS protocol is the single control plane + node transport for","source":"@site/content/moltbot/docs/gateway/protocol.md","sourceDirName":"gateway","slug":"/gateway/protocol","permalink":"/moltbot-doc/docs/gateway/protocol","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"summary":"Gateway WebSocket protocol: handshake, frames, versioning","read_when":["Implementing or updating gateway WS clients","Debugging protocol mismatches or connect failures","Regenerating protocol schema/models"]}}');var r=s(74848),c=s(28453);const i={summary:"Gateway WebSocket protocol: handshake, frames, versioning",read_when:["Implementing or updating gateway WS clients","Debugging protocol mismatches or connect failures","Regenerating protocol schema/models"]},l="Gateway protocol (WebSocket)",t={},d=[{value:"Transport",id:"transport",level:2},{value:"Handshake (connect)",id:"handshake-connect",level:2},{value:"Node example",id:"node-example",level:3},{value:"Framing",id:"framing",level:2},{value:"Roles + scopes",id:"roles--scopes",level:2},{value:"Roles",id:"roles",level:3},{value:"Scopes (operator)",id:"scopes-operator",level:3},{value:"Caps/commands/permissions (node)",id:"capscommandspermissions-node",level:3},{value:"Presence",id:"presence",level:2},{value:"Node helper methods",id:"node-helper-methods",level:3},{value:"Exec approvals",id:"exec-approvals",level:2},{value:"Versioning",id:"versioning",level:2},{value:"Auth",id:"auth",level:2},{value:"Device identity + pairing",id:"device-identity--pairing",level:2},{value:"TLS + pinning",id:"tls--pinning",level:2},{value:"Scope",id:"scope",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"gateway-protocol-websocket",children:"Gateway protocol (WebSocket)"})}),"\n",(0,r.jsxs)(n.p,{children:["The Gateway WS protocol is the ",(0,r.jsx)(n.strong,{children:"single control plane + node transport"})," for\nMoltbot. All clients (CLI, web UI, macOS app, iOS/Android nodes, headless\nnodes) connect over WebSocket and declare their ",(0,r.jsx)(n.strong,{children:"role"})," + ",(0,r.jsx)(n.strong,{children:"scope"})," at\nhandshake time."]}),"\n",(0,r.jsx)(n.h2,{id:"transport",children:"Transport"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"WebSocket, text frames with JSON payloads."}),"\n",(0,r.jsxs)(n.li,{children:["First frame ",(0,r.jsx)(n.strong,{children:"must"})," be a ",(0,r.jsx)(n.code,{children:"connect"})," request."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"handshake-connect",children:"Handshake (connect)"}),"\n",(0,r.jsx)(n.p,{children:"Gateway \u2192 Client (pre-connect challenge):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "type": "event",\n  "event": "connect.challenge",\n  "payload": { "nonce": "\u2026", "ts": 1737264000000 }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Client \u2192 Gateway:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "type": "req",\n  "id": "\u2026",\n  "method": "connect",\n  "params": {\n    "minProtocol": 3,\n    "maxProtocol": 3,\n    "client": {\n      "id": "cli",\n      "version": "1.2.3",\n      "platform": "macos",\n      "mode": "operator"\n    },\n    "role": "operator",\n    "scopes": ["operator.read", "operator.write"],\n    "caps": [],\n    "commands": [],\n    "permissions": {},\n    "auth": { "token": "\u2026" },\n    "locale": "en-US",\n    "userAgent": "moltbot-cli/1.2.3",\n    "device": {\n      "id": "device_fingerprint",\n      "publicKey": "\u2026",\n      "signature": "\u2026",\n      "signedAt": 1737264000000,\n      "nonce": "\u2026"\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Gateway \u2192 Client:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "type": "res",\n  "id": "\u2026",\n  "ok": true,\n  "payload": { "type": "hello-ok", "protocol": 3, "policy": { "tickIntervalMs": 15000 } }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["When a device token is issued, ",(0,r.jsx)(n.code,{children:"hello-ok"})," also includes:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "auth": {\n    "deviceToken": "\u2026",\n    "role": "operator",\n    "scopes": ["operator.read", "operator.write"]\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"node-example",children:"Node example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "type": "req",\n  "id": "\u2026",\n  "method": "connect",\n  "params": {\n    "minProtocol": 3,\n    "maxProtocol": 3,\n    "client": {\n      "id": "ios-node",\n      "version": "1.2.3",\n      "platform": "ios",\n      "mode": "node"\n    },\n    "role": "node",\n    "scopes": [],\n    "caps": ["camera", "canvas", "screen", "location", "voice"],\n    "commands": ["camera.snap", "canvas.navigate", "screen.record", "location.get"],\n    "permissions": { "camera.capture": true, "screen.record": false },\n    "auth": { "token": "\u2026" },\n    "locale": "en-US",\n    "userAgent": "moltbot-ios/1.2.3",\n    "device": {\n      "id": "device_fingerprint",\n      "publicKey": "\u2026",\n      "signature": "\u2026",\n      "signedAt": 1737264000000,\n      "nonce": "\u2026"\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"framing",children:"Framing"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Request"}),": ",(0,r.jsx)(n.code,{children:'{type:"req", id, method, params}'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Response"}),": ",(0,r.jsx)(n.code,{children:'{type:"res", id, ok, payload|error}'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Event"}),": ",(0,r.jsx)(n.code,{children:'{type:"event", event, payload, seq?, stateVersion?}'})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Side-effecting methods require ",(0,r.jsx)(n.strong,{children:"idempotency keys"})," (see schema)."]}),"\n",(0,r.jsx)(n.h2,{id:"roles--scopes",children:"Roles + scopes"}),"\n",(0,r.jsx)(n.h3,{id:"roles",children:"Roles"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"operator"})," = control plane client (CLI/UI/automation)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"node"})," = capability host (camera/screen/canvas/system.run)."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"scopes-operator",children:"Scopes (operator)"}),"\n",(0,r.jsx)(n.p,{children:"Common scopes:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"operator.read"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"operator.write"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"operator.admin"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"operator.approvals"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"operator.pairing"})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"capscommandspermissions-node",children:"Caps/commands/permissions (node)"}),"\n",(0,r.jsx)(n.p,{children:"Nodes declare capability claims at connect time:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"caps"}),": high-level capability categories."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"commands"}),": command allowlist for invoke."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"permissions"}),": granular toggles (e.g. ",(0,r.jsx)(n.code,{children:"screen.record"}),", ",(0,r.jsx)(n.code,{children:"camera.capture"}),")."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The Gateway treats these as ",(0,r.jsx)(n.strong,{children:"claims"})," and enforces server-side allowlists."]}),"\n",(0,r.jsx)(n.h2,{id:"presence",children:"Presence"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"system-presence"})," returns entries keyed by device identity."]}),"\n",(0,r.jsxs)(n.li,{children:["Presence entries include ",(0,r.jsx)(n.code,{children:"deviceId"}),", ",(0,r.jsx)(n.code,{children:"roles"}),", and ",(0,r.jsx)(n.code,{children:"scopes"})," so UIs can show a single row per device\neven when it connects as both ",(0,r.jsx)(n.strong,{children:"operator"})," and ",(0,r.jsx)(n.strong,{children:"node"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"node-helper-methods",children:"Node helper methods"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Nodes may call ",(0,r.jsx)(n.code,{children:"skills.bins"})," to fetch the current list of skill executables\nfor auto-allow checks."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"exec-approvals",children:"Exec approvals"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["When an exec request needs approval, the gateway broadcasts ",(0,r.jsx)(n.code,{children:"exec.approval.requested"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Operator clients resolve by calling ",(0,r.jsx)(n.code,{children:"exec.approval.resolve"})," (requires ",(0,r.jsx)(n.code,{children:"operator.approvals"})," scope)."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"versioning",children:"Versioning"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"PROTOCOL_VERSION"})," lives in ",(0,r.jsx)(n.code,{children:"src/gateway/protocol/schema.ts"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Clients send ",(0,r.jsx)(n.code,{children:"minProtocol"})," + ",(0,r.jsx)(n.code,{children:"maxProtocol"}),"; the server rejects mismatches."]}),"\n",(0,r.jsxs)(n.li,{children:["Schemas + models are generated from TypeBox definitions:\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"pnpm protocol:gen"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"pnpm protocol:gen:swift"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"pnpm protocol:check"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"auth",children:"Auth"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["If ",(0,r.jsx)(n.code,{children:"CLAWDBOT_GATEWAY_TOKEN"})," (or ",(0,r.jsx)(n.code,{children:"--token"}),") is set, ",(0,r.jsx)(n.code,{children:"connect.params.auth.token"}),"\nmust match or the socket is closed."]}),"\n",(0,r.jsxs)(n.li,{children:["After pairing, the Gateway issues a ",(0,r.jsx)(n.strong,{children:"device token"})," scoped to the connection\nrole + scopes. It is returned in ",(0,r.jsx)(n.code,{children:"hello-ok.auth.deviceToken"})," and should be\npersisted by the client for future connects."]}),"\n",(0,r.jsxs)(n.li,{children:["Device tokens can be rotated/revoked via ",(0,r.jsx)(n.code,{children:"device.token.rotate"})," and\n",(0,r.jsx)(n.code,{children:"device.token.revoke"})," (requires ",(0,r.jsx)(n.code,{children:"operator.pairing"})," scope)."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"device-identity--pairing",children:"Device identity + pairing"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Nodes should include a stable device identity (",(0,r.jsx)(n.code,{children:"device.id"}),") derived from a\nkeypair fingerprint."]}),"\n",(0,r.jsx)(n.li,{children:"Gateways issue tokens per device + role."}),"\n",(0,r.jsx)(n.li,{children:"Pairing approvals are required for new device IDs unless local auto-approval\nis enabled."}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Local"})," connects include loopback and the gateway host\u2019s own tailnet address\n(so same\u2011host tailnet binds can still auto\u2011approve)."]}),"\n",(0,r.jsxs)(n.li,{children:["All WS clients must include ",(0,r.jsx)(n.code,{children:"device"})," identity during ",(0,r.jsx)(n.code,{children:"connect"})," (operator + node).\nControl UI can omit it ",(0,r.jsx)(n.strong,{children:"only"})," when ",(0,r.jsx)(n.code,{children:"gateway.controlUi.allowInsecureAuth"})," is enabled\n(or ",(0,r.jsx)(n.code,{children:"gateway.controlUi.dangerouslyDisableDeviceAuth"})," for break-glass use)."]}),"\n",(0,r.jsxs)(n.li,{children:["Non-local connections must sign the server-provided ",(0,r.jsx)(n.code,{children:"connect.challenge"})," nonce."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"tls--pinning",children:"TLS + pinning"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"TLS is supported for WS connections."}),"\n",(0,r.jsxs)(n.li,{children:["Clients may optionally pin the gateway cert fingerprint (see ",(0,r.jsx)(n.code,{children:"gateway.tls"}),"\nconfig plus ",(0,r.jsx)(n.code,{children:"gateway.remote.tlsFingerprint"})," or CLI ",(0,r.jsx)(n.code,{children:"--tls-fingerprint"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"scope",children:"Scope"}),"\n",(0,r.jsxs)(n.p,{children:["This protocol exposes the ",(0,r.jsx)(n.strong,{children:"full gateway API"})," (status, channels, models, chat,\nagent, sessions, nodes, approvals, etc.). The exact surface is defined by the\nTypeBox schemas in ",(0,r.jsx)(n.code,{children:"src/gateway/protocol/schema.ts"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},28453(e,n,s){s.d(n,{R:()=>i,x:()=>l});var o=s(96540);const r={},c=o.createContext(r);function i(e){const n=o.useContext(c);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),o.createElement(c.Provider,{value:n},e.children)}}}]);