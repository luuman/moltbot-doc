"use strict";(globalThis.webpackChunkdocs_workspace=globalThis.webpackChunkdocs_workspace||[]).push([[1952],{67206(e,s,n){n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>c,default:()=>a,frontMatter:()=>t,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"reference/session-management-compaction","title":"Session Management & Compaction (Deep Dive)","description":"This document explains how Moltbot manages sessions end-to-end:","source":"@site/content/moltbot/docs/reference/session-management-compaction.md","sourceDirName":"reference","slug":"/reference/session-management-compaction","permalink":"/moltbot-doc/docs/reference/session-management-compaction","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"summary":"Deep dive: session store + transcripts, lifecycle, and (auto)compaction internals","read_when":["You need to debug session ids, transcript JSONL, or sessions.json fields","You are changing auto-compaction behavior or adding \u201cpre-compaction\u201d housekeeping","You want to implement memory flushes or silent system turns"]}}');var o=n(74848),r=n(28453);const t={summary:"Deep dive: session store + transcripts, lifecycle, and (auto)compaction internals",read_when:["You need to debug session ids, transcript JSONL, or sessions.json fields","You are changing auto-compaction behavior or adding \u201cpre-compaction\u201d housekeeping","You want to implement memory flushes or silent system turns"]},c="Session Management & Compaction (Deep Dive)",l={},d=[{value:"Source of truth: the Gateway",id:"source-of-truth-the-gateway",level:2},{value:"Two persistence layers",id:"two-persistence-layers",level:2},{value:"On-disk locations",id:"on-disk-locations",level:2},{value:"Session keys (<code>sessionKey</code>)",id:"session-keys-sessionkey",level:2},{value:"Session ids (<code>sessionId</code>)",id:"session-ids-sessionid",level:2},{value:"Session store schema (<code>sessions.json</code>)",id:"session-store-schema-sessionsjson",level:2},{value:"Transcript structure (<code>*.jsonl</code>)",id:"transcript-structure-jsonl",level:2},{value:"Context windows vs tracked tokens",id:"context-windows-vs-tracked-tokens",level:2},{value:"Compaction: what it is",id:"compaction-what-it-is",level:2},{value:"When auto-compaction happens (Pi runtime)",id:"when-auto-compaction-happens-pi-runtime",level:2},{value:"Compaction settings (<code>reserveTokens</code>, <code>keepRecentTokens</code>)",id:"compaction-settings-reservetokens-keeprecenttokens",level:2},{value:"User-visible surfaces",id:"user-visible-surfaces",level:2},{value:"Silent housekeeping (<code>NO_REPLY</code>)",id:"silent-housekeeping-no_reply",level:2},{value:"Pre-compaction \u201cmemory flush\u201d (implemented)",id:"pre-compaction-memory-flush-implemented",level:2},{value:"Troubleshooting checklist",id:"troubleshooting-checklist",level:2}];function h(e){const s={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(s.header,{children:(0,o.jsx)(s.h1,{id:"session-management--compaction-deep-dive",children:"Session Management & Compaction (Deep Dive)"})}),"\n",(0,o.jsx)(s.p,{children:"This document explains how Moltbot manages sessions end-to-end:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Session routing"})," (how inbound messages map to a ",(0,o.jsx)(s.code,{children:"sessionKey"}),")"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Session store"})," (",(0,o.jsx)(s.code,{children:"sessions.json"}),") and what it tracks"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Transcript persistence"})," (",(0,o.jsx)(s.code,{children:"*.jsonl"}),") and its structure"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Transcript hygiene"})," (provider-specific fixups before runs)"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Context limits"})," (context window vs tracked tokens)"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Compaction"})," (manual + auto-compaction) and where to hook pre-compaction work"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Silent housekeeping"})," (e.g. memory writes that shouldn\u2019t produce user-visible output)"]}),"\n"]}),"\n",(0,o.jsx)(s.p,{children:"If you want a higher-level overview first, start with:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsx)(s.li,{children:(0,o.jsx)(s.a,{href:"/concepts/session",children:"/concepts/session"})}),"\n",(0,o.jsx)(s.li,{children:(0,o.jsx)(s.a,{href:"/concepts/compaction",children:"/concepts/compaction"})}),"\n",(0,o.jsx)(s.li,{children:(0,o.jsx)(s.a,{href:"/concepts/session-pruning",children:"/concepts/session-pruning"})}),"\n",(0,o.jsx)(s.li,{children:(0,o.jsx)(s.a,{href:"/reference/transcript-hygiene",children:"/reference/transcript-hygiene"})}),"\n"]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsx)(s.h2,{id:"source-of-truth-the-gateway",children:"Source of truth: the Gateway"}),"\n",(0,o.jsxs)(s.p,{children:["Moltbot is designed around a single ",(0,o.jsx)(s.strong,{children:"Gateway process"})," that owns session state."]}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsx)(s.li,{children:"UIs (macOS app, web Control UI, TUI) should query the Gateway for session lists and token counts."}),"\n",(0,o.jsx)(s.li,{children:"In remote mode, session files are on the remote host; \u201cchecking your local Mac files\u201d won\u2019t reflect what the Gateway is using."}),"\n"]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsx)(s.h2,{id:"two-persistence-layers",children:"Two persistence layers"}),"\n",(0,o.jsx)(s.p,{children:"Moltbot persists sessions in two layers:"}),"\n",(0,o.jsxs)(s.ol,{children:["\n",(0,o.jsxs)(s.li,{children:["\n",(0,o.jsx)(s.p,{children:(0,o.jsxs)(s.strong,{children:["Session store (",(0,o.jsx)(s.code,{children:"sessions.json"}),")"]})}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["Key/value map: ",(0,o.jsx)(s.code,{children:"sessionKey -> SessionEntry"})]}),"\n",(0,o.jsx)(s.li,{children:"Small, mutable, safe to edit (or delete entries)"}),"\n",(0,o.jsx)(s.li,{children:"Tracks session metadata (current session id, last activity, toggles, token counters, etc.)"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(s.li,{children:["\n",(0,o.jsx)(s.p,{children:(0,o.jsxs)(s.strong,{children:["Transcript (",(0,o.jsx)(s.code,{children:"<sessionId>.jsonl"}),")"]})}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["Append-only transcript with tree structure (entries have ",(0,o.jsx)(s.code,{children:"id"})," + ",(0,o.jsx)(s.code,{children:"parentId"}),")"]}),"\n",(0,o.jsx)(s.li,{children:"Stores the actual conversation + tool calls + compaction summaries"}),"\n",(0,o.jsx)(s.li,{children:"Used to rebuild the model context for future turns"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsx)(s.h2,{id:"on-disk-locations",children:"On-disk locations"}),"\n",(0,o.jsx)(s.p,{children:"Per agent, on the Gateway host:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["Store: ",(0,o.jsx)(s.code,{children:"~/.clawdbot/agents/<agentId>/sessions/sessions.json"})]}),"\n",(0,o.jsxs)(s.li,{children:["Transcripts: ",(0,o.jsx)(s.code,{children:"~/.clawdbot/agents/<agentId>/sessions/<sessionId>.jsonl"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["Telegram topic sessions: ",(0,o.jsx)(s.code,{children:".../<sessionId>-topic-<threadId>.jsonl"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["Moltbot resolves these via ",(0,o.jsx)(s.code,{children:"src/config/sessions.ts"}),"."]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsxs)(s.h2,{id:"session-keys-sessionkey",children:["Session keys (",(0,o.jsx)(s.code,{children:"sessionKey"}),")"]}),"\n",(0,o.jsxs)(s.p,{children:["A ",(0,o.jsx)(s.code,{children:"sessionKey"})," identifies ",(0,o.jsx)(s.em,{children:"which conversation bucket"})," you\u2019re in (routing + isolation)."]}),"\n",(0,o.jsx)(s.p,{children:"Common patterns:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["Main/direct chat (per agent): ",(0,o.jsx)(s.code,{children:"agent:<agentId>:<mainKey>"})," (default ",(0,o.jsx)(s.code,{children:"main"}),")"]}),"\n",(0,o.jsxs)(s.li,{children:["Group: ",(0,o.jsx)(s.code,{children:"agent:<agentId>:<channel>:group:<id>"})]}),"\n",(0,o.jsxs)(s.li,{children:["Room/channel (Discord/Slack): ",(0,o.jsx)(s.code,{children:"agent:<agentId>:<channel>:channel:<id>"})," or ",(0,o.jsx)(s.code,{children:"...:room:<id>"})]}),"\n",(0,o.jsxs)(s.li,{children:["Cron: ",(0,o.jsx)(s.code,{children:"cron:<job.id>"})]}),"\n",(0,o.jsxs)(s.li,{children:["Webhook: ",(0,o.jsx)(s.code,{children:"hook:<uuid>"})," (unless overridden)"]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["The canonical rules are documented at ",(0,o.jsx)(s.a,{href:"/concepts/session",children:"/concepts/session"}),"."]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsxs)(s.h2,{id:"session-ids-sessionid",children:["Session ids (",(0,o.jsx)(s.code,{children:"sessionId"}),")"]}),"\n",(0,o.jsxs)(s.p,{children:["Each ",(0,o.jsx)(s.code,{children:"sessionKey"})," points at a current ",(0,o.jsx)(s.code,{children:"sessionId"})," (the transcript file that continues the conversation)."]}),"\n",(0,o.jsx)(s.p,{children:"Rules of thumb:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Reset"})," (",(0,o.jsx)(s.code,{children:"/new"}),", ",(0,o.jsx)(s.code,{children:"/reset"}),") creates a new ",(0,o.jsx)(s.code,{children:"sessionId"})," for that ",(0,o.jsx)(s.code,{children:"sessionKey"}),"."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Daily reset"})," (default 4:00 AM local time on the gateway host) creates a new ",(0,o.jsx)(s.code,{children:"sessionId"})," on the next message after the reset boundary."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Idle expiry"})," (",(0,o.jsx)(s.code,{children:"session.reset.idleMinutes"})," or legacy ",(0,o.jsx)(s.code,{children:"session.idleMinutes"}),") creates a new ",(0,o.jsx)(s.code,{children:"sessionId"})," when a message arrives after the idle window. When daily + idle are both configured, whichever expires first wins."]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["Implementation detail: the decision happens in ",(0,o.jsx)(s.code,{children:"initSessionState()"})," in ",(0,o.jsx)(s.code,{children:"src/auto-reply/reply/session.ts"}),"."]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsxs)(s.h2,{id:"session-store-schema-sessionsjson",children:["Session store schema (",(0,o.jsx)(s.code,{children:"sessions.json"}),")"]}),"\n",(0,o.jsxs)(s.p,{children:["The store\u2019s value type is ",(0,o.jsx)(s.code,{children:"SessionEntry"})," in ",(0,o.jsx)(s.code,{children:"src/config/sessions.ts"}),"."]}),"\n",(0,o.jsx)(s.p,{children:"Key fields (not exhaustive):"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"sessionId"}),": current transcript id (filename is derived from this unless ",(0,o.jsx)(s.code,{children:"sessionFile"})," is set)"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"updatedAt"}),": last activity timestamp"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"sessionFile"}),": optional explicit transcript path override"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"chatType"}),": ",(0,o.jsx)(s.code,{children:"direct | group | room"})," (helps UIs and send policy)"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"provider"}),", ",(0,o.jsx)(s.code,{children:"subject"}),", ",(0,o.jsx)(s.code,{children:"room"}),", ",(0,o.jsx)(s.code,{children:"space"}),", ",(0,o.jsx)(s.code,{children:"displayName"}),": metadata for group/channel labeling"]}),"\n",(0,o.jsxs)(s.li,{children:["Toggles:\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"thinkingLevel"}),", ",(0,o.jsx)(s.code,{children:"verboseLevel"}),", ",(0,o.jsx)(s.code,{children:"reasoningLevel"}),", ",(0,o.jsx)(s.code,{children:"elevatedLevel"})]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"sendPolicy"})," (per-session override)"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(s.li,{children:["Model selection:\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"providerOverride"}),", ",(0,o.jsx)(s.code,{children:"modelOverride"}),", ",(0,o.jsx)(s.code,{children:"authProfileOverride"})]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(s.li,{children:["Token counters (best-effort / provider-dependent):\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"inputTokens"}),", ",(0,o.jsx)(s.code,{children:"outputTokens"}),", ",(0,o.jsx)(s.code,{children:"totalTokens"}),", ",(0,o.jsx)(s.code,{children:"contextTokens"})]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"compactionCount"}),": how often auto-compaction completed for this session key"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"memoryFlushAt"}),": timestamp for the last pre-compaction memory flush"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"memoryFlushCompactionCount"}),": compaction count when the last flush ran"]}),"\n"]}),"\n",(0,o.jsx)(s.p,{children:"The store is safe to edit, but the Gateway is the authority: it may rewrite or rehydrate entries as sessions run."}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsxs)(s.h2,{id:"transcript-structure-jsonl",children:["Transcript structure (",(0,o.jsx)(s.code,{children:"*.jsonl"}),")"]}),"\n",(0,o.jsxs)(s.p,{children:["Transcripts are managed by ",(0,o.jsx)(s.code,{children:"@mariozechner/pi-coding-agent"}),"\u2019s ",(0,o.jsx)(s.code,{children:"SessionManager"}),"."]}),"\n",(0,o.jsx)(s.p,{children:"The file is JSONL:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["First line: session header (",(0,o.jsx)(s.code,{children:'type: "session"'}),", includes ",(0,o.jsx)(s.code,{children:"id"}),", ",(0,o.jsx)(s.code,{children:"cwd"}),", ",(0,o.jsx)(s.code,{children:"timestamp"}),", optional ",(0,o.jsx)(s.code,{children:"parentSession"}),")"]}),"\n",(0,o.jsxs)(s.li,{children:["Then: session entries with ",(0,o.jsx)(s.code,{children:"id"})," + ",(0,o.jsx)(s.code,{children:"parentId"})," (tree)"]}),"\n"]}),"\n",(0,o.jsx)(s.p,{children:"Notable entry types:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"message"}),": user/assistant/toolResult messages"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"custom_message"}),": extension-injected messages that ",(0,o.jsx)(s.em,{children:"do"})," enter model context (can be hidden from UI)"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"custom"}),": extension state that does ",(0,o.jsx)(s.em,{children:"not"})," enter model context"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"compaction"}),": persisted compaction summary with ",(0,o.jsx)(s.code,{children:"firstKeptEntryId"})," and ",(0,o.jsx)(s.code,{children:"tokensBefore"})]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"branch_summary"}),": persisted summary when navigating a tree branch"]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["Moltbot intentionally does ",(0,o.jsx)(s.strong,{children:"not"})," \u201cfix up\u201d transcripts; the Gateway uses ",(0,o.jsx)(s.code,{children:"SessionManager"})," to read/write them."]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsx)(s.h2,{id:"context-windows-vs-tracked-tokens",children:"Context windows vs tracked tokens"}),"\n",(0,o.jsx)(s.p,{children:"Two different concepts matter:"}),"\n",(0,o.jsxs)(s.ol,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Model context window"}),": hard cap per model (tokens visible to the model)"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Session store counters"}),": rolling stats written into ",(0,o.jsx)(s.code,{children:"sessions.json"})," (used for /status and dashboards)"]}),"\n"]}),"\n",(0,o.jsx)(s.p,{children:"If you\u2019re tuning limits:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsx)(s.li,{children:"The context window comes from the model catalog (and can be overridden via config)."}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"contextTokens"})," in the store is a runtime estimate/reporting value; don\u2019t treat it as a strict guarantee."]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["For more, see ",(0,o.jsx)(s.a,{href:"/token-use",children:"/token-use"}),"."]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsx)(s.h2,{id:"compaction-what-it-is",children:"Compaction: what it is"}),"\n",(0,o.jsxs)(s.p,{children:["Compaction summarizes older conversation into a persisted ",(0,o.jsx)(s.code,{children:"compaction"})," entry in the transcript and keeps recent messages intact."]}),"\n",(0,o.jsx)(s.p,{children:"After compaction, future turns see:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsx)(s.li,{children:"The compaction summary"}),"\n",(0,o.jsxs)(s.li,{children:["Messages after ",(0,o.jsx)(s.code,{children:"firstKeptEntryId"})]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["Compaction is ",(0,o.jsx)(s.strong,{children:"persistent"})," (unlike session pruning). See ",(0,o.jsx)(s.a,{href:"/concepts/session-pruning",children:"/concepts/session-pruning"}),"."]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsx)(s.h2,{id:"when-auto-compaction-happens-pi-runtime",children:"When auto-compaction happens (Pi runtime)"}),"\n",(0,o.jsx)(s.p,{children:"In the embedded Pi agent, auto-compaction triggers in two cases:"}),"\n",(0,o.jsxs)(s.ol,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Overflow recovery"}),": the model returns a context overflow error \u2192 compact \u2192 retry."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.strong,{children:"Threshold maintenance"}),": after a successful turn, when:"]}),"\n"]}),"\n",(0,o.jsx)(s.p,{children:(0,o.jsx)(s.code,{children:"contextTokens > contextWindow - reserveTokens"})}),"\n",(0,o.jsx)(s.p,{children:"Where:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"contextWindow"})," is the model\u2019s context window"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"reserveTokens"})," is headroom reserved for prompts + the next model output"]}),"\n"]}),"\n",(0,o.jsx)(s.p,{children:"These are Pi runtime semantics (Moltbot consumes the events, but Pi decides when to compact)."}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsxs)(s.h2,{id:"compaction-settings-reservetokens-keeprecenttokens",children:["Compaction settings (",(0,o.jsx)(s.code,{children:"reserveTokens"}),", ",(0,o.jsx)(s.code,{children:"keepRecentTokens"}),")"]}),"\n",(0,o.jsx)(s.p,{children:"Pi\u2019s compaction settings live in Pi settings:"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-json5",children:"{\n  compaction: {\n    enabled: true,\n    reserveTokens: 16384,\n    keepRecentTokens: 20000\n  }\n}\n"})}),"\n",(0,o.jsx)(s.p,{children:"Moltbot also enforces a safety floor for embedded runs:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["If ",(0,o.jsx)(s.code,{children:"compaction.reserveTokens < reserveTokensFloor"}),", Moltbot bumps it."]}),"\n",(0,o.jsxs)(s.li,{children:["Default floor is ",(0,o.jsx)(s.code,{children:"20000"})," tokens."]}),"\n",(0,o.jsxs)(s.li,{children:["Set ",(0,o.jsx)(s.code,{children:"agents.defaults.compaction.reserveTokensFloor: 0"})," to disable the floor."]}),"\n",(0,o.jsx)(s.li,{children:"If it\u2019s already higher, Moltbot leaves it alone."}),"\n"]}),"\n",(0,o.jsx)(s.p,{children:"Why: leave enough headroom for multi-turn \u201chousekeeping\u201d (like memory writes) before compaction becomes unavoidable."}),"\n",(0,o.jsxs)(s.p,{children:["Implementation: ",(0,o.jsx)(s.code,{children:"ensurePiCompactionReserveTokens()"})," in ",(0,o.jsx)(s.code,{children:"src/agents/pi-settings.ts"}),"\n(called from ",(0,o.jsx)(s.code,{children:"src/agents/pi-embedded-runner.ts"}),")."]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsx)(s.h2,{id:"user-visible-surfaces",children:"User-visible surfaces"}),"\n",(0,o.jsx)(s.p,{children:"You can observe compaction and session state via:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"/status"})," (in any chat session)"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"moltbot status"})," (CLI)"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"moltbot sessions"})," / ",(0,o.jsx)(s.code,{children:"sessions --json"})]}),"\n",(0,o.jsxs)(s.li,{children:["Verbose mode: ",(0,o.jsx)(s.code,{children:"\ud83e\uddf9 Auto-compaction complete"})," + compaction count"]}),"\n"]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsxs)(s.h2,{id:"silent-housekeeping-no_reply",children:["Silent housekeeping (",(0,o.jsx)(s.code,{children:"NO_REPLY"}),")"]}),"\n",(0,o.jsx)(s.p,{children:"Moltbot supports \u201csilent\u201d turns for background tasks where the user should not see intermediate output."}),"\n",(0,o.jsx)(s.p,{children:"Convention:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["The assistant starts its output with ",(0,o.jsx)(s.code,{children:"NO_REPLY"})," to indicate \u201cdo not deliver a reply to the user\u201d."]}),"\n",(0,o.jsx)(s.li,{children:"Moltbot strips/suppresses this in the delivery layer."}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["As of ",(0,o.jsx)(s.code,{children:"2026.1.10"}),", Moltbot also suppresses ",(0,o.jsx)(s.strong,{children:"draft/typing streaming"})," when a partial chunk begins with ",(0,o.jsx)(s.code,{children:"NO_REPLY"}),", so silent operations don\u2019t leak partial output mid-turn."]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsx)(s.h2,{id:"pre-compaction-memory-flush-implemented",children:"Pre-compaction \u201cmemory flush\u201d (implemented)"}),"\n",(0,o.jsxs)(s.p,{children:["Goal: before auto-compaction happens, run a silent agentic turn that writes durable\nstate to disk (e.g. ",(0,o.jsx)(s.code,{children:"memory/YYYY-MM-DD.md"})," in the agent workspace) so compaction can\u2019t\nerase critical context."]}),"\n",(0,o.jsxs)(s.p,{children:["Moltbot uses the ",(0,o.jsx)(s.strong,{children:"pre-threshold flush"})," approach:"]}),"\n",(0,o.jsxs)(s.ol,{children:["\n",(0,o.jsx)(s.li,{children:"Monitor session context usage."}),"\n",(0,o.jsx)(s.li,{children:"When it crosses a \u201csoft threshold\u201d (below Pi\u2019s compaction threshold), run a silent\n\u201cwrite memory now\u201d directive to the agent."}),"\n",(0,o.jsxs)(s.li,{children:["Use ",(0,o.jsx)(s.code,{children:"NO_REPLY"})," so the user sees nothing."]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["Config (",(0,o.jsx)(s.code,{children:"agents.defaults.compaction.memoryFlush"}),"):"]}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"enabled"})," (default: ",(0,o.jsx)(s.code,{children:"true"}),")"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"softThresholdTokens"})," (default: ",(0,o.jsx)(s.code,{children:"4000"}),")"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"prompt"})," (user message for the flush turn)"]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"systemPrompt"})," (extra system prompt appended for the flush turn)"]}),"\n"]}),"\n",(0,o.jsx)(s.p,{children:"Notes:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["The default prompt/system prompt include a ",(0,o.jsx)(s.code,{children:"NO_REPLY"})," hint to suppress delivery."]}),"\n",(0,o.jsxs)(s.li,{children:["The flush runs once per compaction cycle (tracked in ",(0,o.jsx)(s.code,{children:"sessions.json"}),")."]}),"\n",(0,o.jsx)(s.li,{children:"The flush runs only for embedded Pi sessions (CLI backends skip it)."}),"\n",(0,o.jsxs)(s.li,{children:["The flush is skipped when the session workspace is read-only (",(0,o.jsx)(s.code,{children:'workspaceAccess: "ro"'})," or ",(0,o.jsx)(s.code,{children:'"none"'}),")."]}),"\n",(0,o.jsxs)(s.li,{children:["See ",(0,o.jsx)(s.a,{href:"/concepts/memory",children:"Memory"})," for the workspace file layout and write patterns."]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["Pi also exposes a ",(0,o.jsx)(s.code,{children:"session_before_compact"})," hook in the extension API, but Moltbot\u2019s\nflush logic lives on the Gateway side today."]}),"\n",(0,o.jsx)(s.hr,{}),"\n",(0,o.jsx)(s.h2,{id:"troubleshooting-checklist",children:"Troubleshooting checklist"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["Session key wrong? Start with ",(0,o.jsx)(s.a,{href:"/concepts/session",children:"/concepts/session"})," and confirm the ",(0,o.jsx)(s.code,{children:"sessionKey"})," in ",(0,o.jsx)(s.code,{children:"/status"}),"."]}),"\n",(0,o.jsxs)(s.li,{children:["Store vs transcript mismatch? Confirm the Gateway host and the store path from ",(0,o.jsx)(s.code,{children:"moltbot status"}),"."]}),"\n",(0,o.jsxs)(s.li,{children:["Compaction spam? Check:\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsx)(s.li,{children:"model context window (too small)"}),"\n",(0,o.jsxs)(s.li,{children:["compaction settings (",(0,o.jsx)(s.code,{children:"reserveTokens"})," too high for the model window can cause earlier compaction)"]}),"\n",(0,o.jsx)(s.li,{children:"tool-result bloat: enable/tune session pruning"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(s.li,{children:["Silent turns leaking? Confirm the reply starts with ",(0,o.jsx)(s.code,{children:"NO_REPLY"})," (exact token) and you\u2019re on a build that includes the streaming suppression fix."]}),"\n"]})]})}function a(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,o.jsx)(s,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},28453(e,s,n){n.d(s,{R:()=>t,x:()=>c});var i=n(96540);const o={},r=i.createContext(o);function t(e){const s=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:t(e.components),i.createElement(r.Provider,{value:s},e.children)}}}]);