"use strict";(globalThis.webpackChunkdocs_workspace=globalThis.webpackChunkdocs_workspace||[]).push([[8505],{56543(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"refactor/plugin-sdk","title":"Plugin SDK + Runtime Refactor Plan","description":"Goal: every messaging connector is a plugin (bundled or external) using one stable API.","source":"@site/content/moltbot/docs/refactor/plugin-sdk.md","sourceDirName":"refactor","slug":"/refactor/plugin-sdk","permalink":"/moltbot-doc/docs/refactor/plugin-sdk","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"summary":"Plan: one clean plugin SDK + runtime for all messaging connectors","read_when":["Defining or refactoring the plugin architecture","Migrating channel connectors to the plugin SDK/runtime"]}}');var s=i(74848),l=i(28453);const t={summary:"Plan: one clean plugin SDK + runtime for all messaging connectors",read_when:["Defining or refactoring the plugin architecture","Migrating channel connectors to the plugin SDK/runtime"]},o="Plugin SDK + Runtime Refactor Plan",c={},a=[{value:"Why now",id:"why-now",level:2},{value:"Target architecture (two layers)",id:"target-architecture-two-layers",level:2},{value:"1) Plugin SDK (compile-time, stable, publishable)",id:"1-plugin-sdk-compile-time-stable-publishable",level:3},{value:"2) Plugin Runtime (execution surface, injected)",id:"2-plugin-runtime-execution-surface-injected",level:3},{value:"Migration plan (phased, safe)",id:"migration-plan-phased-safe",level:2},{value:"Phase 0: scaffolding",id:"phase-0-scaffolding",level:3},{value:"Phase 1: bridge cleanup (low risk)",id:"phase-1-bridge-cleanup-low-risk",level:3},{value:"Phase 2: light direct-import plugins",id:"phase-2-light-direct-import-plugins",level:3},{value:"Phase 3: heavy direct-import plugins",id:"phase-3-heavy-direct-import-plugins",level:3},{value:"Phase 4: iMessage pluginization",id:"phase-4-imessage-pluginization",level:3},{value:"Phase 5: enforcement",id:"phase-5-enforcement",level:3},{value:"Compatibility and versioning",id:"compatibility-and-versioning",level:2},{value:"Testing strategy",id:"testing-strategy",level:2},{value:"Open questions",id:"open-questions",level:2},{value:"Success criteria",id:"success-criteria",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"plugin-sdk--runtime-refactor-plan",children:"Plugin SDK + Runtime Refactor Plan"})}),"\n",(0,s.jsxs)(n.p,{children:["Goal: every messaging connector is a plugin (bundled or external) using one stable API.\nNo plugin imports from ",(0,s.jsx)(n.code,{children:"src/**"})," directly. All dependencies go through the SDK or runtime."]}),"\n",(0,s.jsx)(n.h2,{id:"why-now",children:"Why now"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Current connectors mix patterns: direct core imports, dist-only bridges, and custom helpers."}),"\n",(0,s.jsx)(n.li,{children:"This makes upgrades brittle and blocks a clean external plugin surface."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"target-architecture-two-layers",children:"Target architecture (two layers)"}),"\n",(0,s.jsx)(n.h3,{id:"1-plugin-sdk-compile-time-stable-publishable",children:"1) Plugin SDK (compile-time, stable, publishable)"}),"\n",(0,s.jsx)(n.p,{children:"Scope: types, helpers, and config utilities. No runtime state, no side effects."}),"\n",(0,s.jsx)(n.p,{children:"Contents (examples):"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Types: ",(0,s.jsx)(n.code,{children:"ChannelPlugin"}),", adapters, ",(0,s.jsx)(n.code,{children:"ChannelMeta"}),", ",(0,s.jsx)(n.code,{children:"ChannelCapabilities"}),", ",(0,s.jsx)(n.code,{children:"ChannelDirectoryEntry"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Config helpers: ",(0,s.jsx)(n.code,{children:"buildChannelConfigSchema"}),", ",(0,s.jsx)(n.code,{children:"setAccountEnabledInConfigSection"}),", ",(0,s.jsx)(n.code,{children:"deleteAccountFromConfigSection"}),",\n",(0,s.jsx)(n.code,{children:"applyAccountNameToChannelSection"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Pairing helpers: ",(0,s.jsx)(n.code,{children:"PAIRING_APPROVED_MESSAGE"}),", ",(0,s.jsx)(n.code,{children:"formatPairingApproveHint"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Onboarding helpers: ",(0,s.jsx)(n.code,{children:"promptChannelAccessConfig"}),", ",(0,s.jsx)(n.code,{children:"addWildcardAllowFrom"}),", onboarding types."]}),"\n",(0,s.jsxs)(n.li,{children:["Tool param helpers: ",(0,s.jsx)(n.code,{children:"createActionGate"}),", ",(0,s.jsx)(n.code,{children:"readStringParam"}),", ",(0,s.jsx)(n.code,{children:"readNumberParam"}),", ",(0,s.jsx)(n.code,{children:"readReactionParams"}),", ",(0,s.jsx)(n.code,{children:"jsonResult"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Docs link helper: ",(0,s.jsx)(n.code,{children:"formatDocsLink"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Delivery:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Publish as ",(0,s.jsx)(n.code,{children:"@clawdbot/plugin-sdk"})," (or export from core under ",(0,s.jsx)(n.code,{children:"clawdbot/plugin-sdk"}),")."]}),"\n",(0,s.jsx)(n.li,{children:"Semver with explicit stability guarantees."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"2-plugin-runtime-execution-surface-injected",children:"2) Plugin Runtime (execution surface, injected)"}),"\n",(0,s.jsxs)(n.p,{children:["Scope: everything that touches core runtime behavior.\nAccessed via ",(0,s.jsx)(n.code,{children:"MoltbotPluginApi.runtime"})," so plugins never import ",(0,s.jsx)(n.code,{children:"src/**"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Proposed surface (minimal but complete):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'export type PluginRuntime = {\n  channel: {\n    text: {\n      chunkMarkdownText(text: string, limit: number): string[];\n      resolveTextChunkLimit(cfg: MoltbotConfig, channel: string, accountId?: string): number;\n      hasControlCommand(text: string, cfg: MoltbotConfig): boolean;\n    };\n    reply: {\n      dispatchReplyWithBufferedBlockDispatcher(params: {\n        ctx: unknown;\n        cfg: unknown;\n        dispatcherOptions: {\n          deliver: (payload: { text?: string; mediaUrls?: string[]; mediaUrl?: string }) =>\n            void | Promise<void>;\n          onError?: (err: unknown, info: { kind: string }) => void;\n        };\n      }): Promise<void>;\n      createReplyDispatcherWithTyping?: unknown; // adapter for Teams-style flows\n    };\n    routing: {\n      resolveAgentRoute(params: {\n        cfg: unknown;\n        channel: string;\n        accountId: string;\n        peer: { kind: "dm" | "group" | "channel"; id: string };\n      }): { sessionKey: string; accountId: string };\n    };\n    pairing: {\n      buildPairingReply(params: { channel: string; idLine: string; code: string }): string;\n      readAllowFromStore(channel: string): Promise<string[]>;\n      upsertPairingRequest(params: {\n        channel: string;\n        id: string;\n        meta?: { name?: string };\n      }): Promise<{ code: string; created: boolean }>;\n    };\n    media: {\n      fetchRemoteMedia(params: { url: string }): Promise<{ buffer: Buffer; contentType?: string }>;\n      saveMediaBuffer(\n        buffer: Uint8Array,\n        contentType: string | undefined,\n        direction: "inbound" | "outbound",\n        maxBytes: number,\n      ): Promise<{ path: string; contentType?: string }>;\n    };\n    mentions: {\n      buildMentionRegexes(cfg: MoltbotConfig, agentId?: string): RegExp[];\n      matchesMentionPatterns(text: string, regexes: RegExp[]): boolean;\n    };\n    groups: {\n      resolveGroupPolicy(cfg: MoltbotConfig, channel: string, accountId: string, groupId: string): {\n        allowlistEnabled: boolean;\n        allowed: boolean;\n        groupConfig?: unknown;\n        defaultConfig?: unknown;\n      };\n      resolveRequireMention(\n        cfg: MoltbotConfig,\n        channel: string,\n        accountId: string,\n        groupId: string,\n        override?: boolean,\n      ): boolean;\n    };\n    debounce: {\n      createInboundDebouncer<T>(opts: {\n        debounceMs: number;\n        buildKey: (v: T) => string | null;\n        shouldDebounce: (v: T) => boolean;\n        onFlush: (entries: T[]) => Promise<void>;\n        onError?: (err: unknown) => void;\n      }): { push: (v: T) => void; flush: () => Promise<void> };\n      resolveInboundDebounceMs(cfg: MoltbotConfig, channel: string): number;\n    };\n    commands: {\n      resolveCommandAuthorizedFromAuthorizers(params: {\n        useAccessGroups: boolean;\n        authorizers: Array<{ configured: boolean; allowed: boolean }>;\n      }): boolean;\n    };\n  };\n  logging: {\n    shouldLogVerbose(): boolean;\n    getChildLogger(name: string): PluginLogger;\n  };\n  state: {\n    resolveStateDir(cfg: MoltbotConfig): string;\n  };\n};\n'})}),"\n",(0,s.jsx)(n.p,{children:"Notes:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Runtime is the only way to access core behavior."}),"\n",(0,s.jsx)(n.li,{children:"SDK is intentionally small and stable."}),"\n",(0,s.jsx)(n.li,{children:"Each runtime method maps to an existing core implementation (no duplication)."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"migration-plan-phased-safe",children:"Migration plan (phased, safe)"}),"\n",(0,s.jsx)(n.h3,{id:"phase-0-scaffolding",children:"Phase 0: scaffolding"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Introduce ",(0,s.jsx)(n.code,{children:"@clawdbot/plugin-sdk"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Add ",(0,s.jsx)(n.code,{children:"api.runtime"})," to ",(0,s.jsx)(n.code,{children:"MoltbotPluginApi"})," with the surface above."]}),"\n",(0,s.jsx)(n.li,{children:"Maintain existing imports during a transition window (deprecation warnings)."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-1-bridge-cleanup-low-risk",children:"Phase 1: bridge cleanup (low risk)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Replace per-extension ",(0,s.jsx)(n.code,{children:"core-bridge.ts"})," with ",(0,s.jsx)(n.code,{children:"api.runtime"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Migrate BlueBubbles, Zalo, Zalo Personal first (already close)."}),"\n",(0,s.jsx)(n.li,{children:"Remove duplicated bridge code."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-2-light-direct-import-plugins",children:"Phase 2: light direct-import plugins"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Migrate Matrix to SDK + runtime."}),"\n",(0,s.jsx)(n.li,{children:"Validate onboarding, directory, group mention logic."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-3-heavy-direct-import-plugins",children:"Phase 3: heavy direct-import plugins"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Migrate MS Teams (largest set of runtime helpers)."}),"\n",(0,s.jsx)(n.li,{children:"Ensure reply/typing semantics match current behavior."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-4-imessage-pluginization",children:"Phase 4: iMessage pluginization"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Move iMessage into ",(0,s.jsx)(n.code,{children:"extensions/imessage"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Replace direct core calls with ",(0,s.jsx)(n.code,{children:"api.runtime"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Keep config keys, CLI behavior, and docs intact."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-5-enforcement",children:"Phase 5: enforcement"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Add lint rule / CI check: no ",(0,s.jsx)(n.code,{children:"extensions/**"})," imports from ",(0,s.jsx)(n.code,{children:"src/**"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Add plugin SDK/version compatibility checks (runtime + SDK semver)."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"compatibility-and-versioning",children:"Compatibility and versioning"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"SDK: semver, published, documented changes."}),"\n",(0,s.jsxs)(n.li,{children:["Runtime: versioned per core release. Add ",(0,s.jsx)(n.code,{children:"api.runtime.version"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Plugins declare a required runtime range (e.g., ",(0,s.jsx)(n.code,{children:'moltbotRuntime: ">=2026.2.0"'}),")."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"testing-strategy",children:"Testing strategy"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Adapter-level unit tests (runtime functions exercised with real core implementation)."}),"\n",(0,s.jsx)(n.li,{children:"Golden tests per plugin: ensure no behavior drift (routing, pairing, allowlist, mention gating)."}),"\n",(0,s.jsx)(n.li,{children:"A single end-to-end plugin sample used in CI (install + run + smoke)."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"open-questions",children:"Open questions"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Where to host SDK types: separate package or core export?"}),"\n",(0,s.jsx)(n.li,{children:"Runtime type distribution: in SDK (types only) or in core?"}),"\n",(0,s.jsx)(n.li,{children:"How to expose docs links for bundled vs external plugins?"}),"\n",(0,s.jsx)(n.li,{children:"Do we allow limited direct core imports for in-repo plugins during transition?"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"success-criteria",children:"Success criteria"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"All channel connectors are plugins using SDK + runtime."}),"\n",(0,s.jsxs)(n.li,{children:["No ",(0,s.jsx)(n.code,{children:"extensions/**"})," imports from ",(0,s.jsx)(n.code,{children:"src/**"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"New connector templates depend only on SDK + runtime."}),"\n",(0,s.jsx)(n.li,{children:"External plugins can be developed and updated without core source access."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Related docs: ",(0,s.jsx)(n.a,{href:"/plugin",children:"Plugins"}),", ",(0,s.jsx)(n.a,{href:"/channels/index",children:"Channels"}),", ",(0,s.jsx)(n.a,{href:"/gateway/configuration",children:"Configuration"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453(e,n,i){i.d(n,{R:()=>t,x:()=>o});var r=i(96540);const s={},l=r.createContext(s);function t(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);