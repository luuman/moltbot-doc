"use strict";(globalThis.webpackChunkdocs_workspace=globalThis.webpackChunkdocs_workspace||[]).push([[8593],{77289(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>i,metadata:()=>c,toc:()=>l});const c=JSON.parse('{"id":"concepts/presence","title":"Presence","description":"Moltbot \u201cpresence\u201d is a lightweight, best\u2011effort view of:","source":"@site/content/moltbot/docs/concepts/presence.md","sourceDirName":"concepts","slug":"/concepts/presence","permalink":"/moltbot-doc/docs/concepts/presence","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"summary":"How Moltbot presence entries are produced, merged, and displayed","read_when":["Debugging the Instances tab","Investigating duplicate or stale instance rows","Changing gateway WS connect or system-event beacons"]}}');var t=s(74848),r=s(28453);const i={summary:"How Moltbot presence entries are produced, merged, and displayed",read_when:["Debugging the Instances tab","Investigating duplicate or stale instance rows","Changing gateway WS connect or system-event beacons"]},d="Presence",o={},l=[{value:"Presence fields (what shows up)",id:"presence-fields-what-shows-up",level:2},{value:"Producers (where presence comes from)",id:"producers-where-presence-comes-from",level:2},{value:"1) Gateway self entry",id:"1-gateway-self-entry",level:3},{value:"2) WebSocket connect",id:"2-websocket-connect",level:3},{value:"Why one\u2011off CLI commands don\u2019t show up",id:"why-oneoff-cli-commands-dont-show-up",level:4},{value:"3) <code>system-event</code> beacons",id:"3-system-event-beacons",level:3},{value:"4) Node connects (role: node)",id:"4-node-connects-role-node",level:3},{value:"Merge + dedupe rules (why <code>instanceId</code> matters)",id:"merge--dedupe-rules-why-instanceid-matters",level:2},{value:"TTL and bounded size",id:"ttl-and-bounded-size",level:2},{value:"Remote/tunnel caveat (loopback IPs)",id:"remotetunnel-caveat-loopback-ips",level:2},{value:"Consumers",id:"consumers",level:2},{value:"macOS Instances tab",id:"macos-instances-tab",level:3},{value:"Debugging tips",id:"debugging-tips",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"presence",children:"Presence"})}),"\n",(0,t.jsx)(n.p,{children:"Moltbot \u201cpresence\u201d is a lightweight, best\u2011effort view of:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["the ",(0,t.jsx)(n.strong,{children:"Gateway"})," itself, and"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"clients connected to the Gateway"})," (mac app, WebChat, CLI, etc.)"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Presence is used primarily to render the macOS app\u2019s ",(0,t.jsx)(n.strong,{children:"Instances"})," tab and to\nprovide quick operator visibility."]}),"\n",(0,t.jsx)(n.h2,{id:"presence-fields-what-shows-up",children:"Presence fields (what shows up)"}),"\n",(0,t.jsx)(n.p,{children:"Presence entries are structured objects with fields like:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"instanceId"})," (optional but strongly recommended): stable client identity (usually ",(0,t.jsx)(n.code,{children:"connect.client.instanceId"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"host"}),": human\u2011friendly host name"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"ip"}),": best\u2011effort IP address"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"version"}),": client version string"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"deviceFamily"})," / ",(0,t.jsx)(n.code,{children:"modelIdentifier"}),": hardware hints"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"mode"}),": ",(0,t.jsx)(n.code,{children:"ui"}),", ",(0,t.jsx)(n.code,{children:"webchat"}),", ",(0,t.jsx)(n.code,{children:"cli"}),", ",(0,t.jsx)(n.code,{children:"backend"}),", ",(0,t.jsx)(n.code,{children:"probe"}),", ",(0,t.jsx)(n.code,{children:"test"}),", ",(0,t.jsx)(n.code,{children:"node"}),", ..."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"lastInputSeconds"}),": \u201cseconds since last user input\u201d (if known)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"reason"}),": ",(0,t.jsx)(n.code,{children:"self"}),", ",(0,t.jsx)(n.code,{children:"connect"}),", ",(0,t.jsx)(n.code,{children:"node-connected"}),", ",(0,t.jsx)(n.code,{children:"periodic"}),", ..."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"ts"}),": last update timestamp (ms since epoch)"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"producers-where-presence-comes-from",children:"Producers (where presence comes from)"}),"\n",(0,t.jsxs)(n.p,{children:["Presence entries are produced by multiple sources and ",(0,t.jsx)(n.strong,{children:"merged"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"1-gateway-self-entry",children:"1) Gateway self entry"}),"\n",(0,t.jsx)(n.p,{children:"The Gateway always seeds a \u201cself\u201d entry at startup so UIs show the gateway host\neven before any clients connect."}),"\n",(0,t.jsx)(n.h3,{id:"2-websocket-connect",children:"2) WebSocket connect"}),"\n",(0,t.jsxs)(n.p,{children:["Every WS client begins with a ",(0,t.jsx)(n.code,{children:"connect"})," request. On successful handshake the\nGateway upserts a presence entry for that connection."]}),"\n",(0,t.jsx)(n.h4,{id:"why-oneoff-cli-commands-dont-show-up",children:"Why one\u2011off CLI commands don\u2019t show up"}),"\n",(0,t.jsxs)(n.p,{children:["The CLI often connects for short, one\u2011off commands. To avoid spamming the\nInstances list, ",(0,t.jsx)(n.code,{children:'client.mode === "cli"'})," is ",(0,t.jsx)(n.strong,{children:"not"})," turned into a presence entry."]}),"\n",(0,t.jsxs)(n.h3,{id:"3-system-event-beacons",children:["3) ",(0,t.jsx)(n.code,{children:"system-event"})," beacons"]}),"\n",(0,t.jsxs)(n.p,{children:["Clients can send richer periodic beacons via the ",(0,t.jsx)(n.code,{children:"system-event"})," method. The mac\napp uses this to report host name, IP, and ",(0,t.jsx)(n.code,{children:"lastInputSeconds"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"4-node-connects-role-node",children:"4) Node connects (role: node)"}),"\n",(0,t.jsxs)(n.p,{children:["When a node connects over the Gateway WebSocket with ",(0,t.jsx)(n.code,{children:"role: node"}),", the Gateway\nupserts a presence entry for that node (same flow as other WS clients)."]}),"\n",(0,t.jsxs)(n.h2,{id:"merge--dedupe-rules-why-instanceid-matters",children:["Merge + dedupe rules (why ",(0,t.jsx)(n.code,{children:"instanceId"})," matters)"]}),"\n",(0,t.jsx)(n.p,{children:"Presence entries are stored in a single in\u2011memory map:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Entries are keyed by a ",(0,t.jsx)(n.strong,{children:"presence key"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["The best key is a stable ",(0,t.jsx)(n.code,{children:"instanceId"})," (from ",(0,t.jsx)(n.code,{children:"connect.client.instanceId"}),") that survives restarts."]}),"\n",(0,t.jsx)(n.li,{children:"Keys are case\u2011insensitive."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["If a client reconnects without a stable ",(0,t.jsx)(n.code,{children:"instanceId"}),", it may show up as a\n",(0,t.jsx)(n.strong,{children:"duplicate"})," row."]}),"\n",(0,t.jsx)(n.h2,{id:"ttl-and-bounded-size",children:"TTL and bounded size"}),"\n",(0,t.jsx)(n.p,{children:"Presence is intentionally ephemeral:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"TTL:"})," entries older than 5 minutes are pruned"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Max entries:"})," 200 (oldest dropped first)"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"This keeps the list fresh and avoids unbounded memory growth."}),"\n",(0,t.jsx)(n.h2,{id:"remotetunnel-caveat-loopback-ips",children:"Remote/tunnel caveat (loopback IPs)"}),"\n",(0,t.jsxs)(n.p,{children:["When a client connects over an SSH tunnel / local port forward, the Gateway may\nsee the remote address as ",(0,t.jsx)(n.code,{children:"127.0.0.1"}),". To avoid overwriting a good client\u2011reported\nIP, loopback remote addresses are ignored."]}),"\n",(0,t.jsx)(n.h2,{id:"consumers",children:"Consumers"}),"\n",(0,t.jsx)(n.h3,{id:"macos-instances-tab",children:"macOS Instances tab"}),"\n",(0,t.jsxs)(n.p,{children:["The macOS app renders the output of ",(0,t.jsx)(n.code,{children:"system-presence"})," and applies a small status\nindicator (Active/Idle/Stale) based on the age of the last update."]}),"\n",(0,t.jsx)(n.h2,{id:"debugging-tips",children:"Debugging tips"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["To see the raw list, call ",(0,t.jsx)(n.code,{children:"system-presence"})," against the Gateway."]}),"\n",(0,t.jsxs)(n.li,{children:["If you see duplicates:\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["confirm clients send a stable ",(0,t.jsx)(n.code,{children:"client.instanceId"})," in the handshake"]}),"\n",(0,t.jsxs)(n.li,{children:["confirm periodic beacons use the same ",(0,t.jsx)(n.code,{children:"instanceId"})]}),"\n",(0,t.jsxs)(n.li,{children:["check whether the connection\u2011derived entry is missing ",(0,t.jsx)(n.code,{children:"instanceId"})," (duplicates are expected)"]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},28453(e,n,s){s.d(n,{R:()=>i,x:()=>d});var c=s(96540);const t={},r=c.createContext(t);function i(e){const n=c.useContext(r);return c.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),c.createElement(r.Provider,{value:n},e.children)}}}]);