"use strict";(globalThis.webpackChunkdocs_workspace=globalThis.webpackChunkdocs_workspace||[]).push([[6011],{76175(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>t});const s=JSON.parse('{"id":"gateway/bridge-protocol","title":"Bridge protocol (legacy node transport)","description":"The Bridge protocol is a legacy node transport (TCP JSONL). New node clients","source":"@site/content/moltbot/docs/gateway/bridge-protocol.md","sourceDirName":"gateway","slug":"/gateway/bridge-protocol","permalink":"/moltbot-doc/docs/gateway/bridge-protocol","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"summary":"Bridge protocol (legacy nodes): TCP JSONL, pairing, scoped RPC","read_when":["Building or debugging node clients (iOS/Android/macOS node mode)","Investigating pairing or bridge auth failures","Auditing the node surface exposed by the gateway"]}}');var r=i(74848),o=i(28453);const d={summary:"Bridge protocol (legacy nodes): TCP JSONL, pairing, scoped RPC",read_when:["Building or debugging node clients (iOS/Android/macOS node mode)","Investigating pairing or bridge auth failures","Auditing the node surface exposed by the gateway"]},l="Bridge protocol (legacy node transport)",c={},t=[{value:"Why we have both",id:"why-we-have-both",level:2},{value:"Transport",id:"transport",level:2},{value:"Handshake + pairing",id:"handshake--pairing",level:2},{value:"Frames",id:"frames",level:2},{value:"Exec lifecycle events",id:"exec-lifecycle-events",level:2},{value:"Tailnet usage",id:"tailnet-usage",level:2},{value:"Versioning",id:"versioning",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"bridge-protocol-legacy-node-transport",children:"Bridge protocol (legacy node transport)"})}),"\n",(0,r.jsxs)(n.p,{children:["The Bridge protocol is a ",(0,r.jsx)(n.strong,{children:"legacy"})," node transport (TCP JSONL). New node clients\nshould use the unified Gateway WebSocket protocol instead."]}),"\n",(0,r.jsxs)(n.p,{children:["If you are building an operator or node client, use the\n",(0,r.jsx)(n.a,{href:"/gateway/protocol",children:"Gateway protocol"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note:"})," Current Moltbot builds no longer ship the TCP bridge listener; this document is kept for historical reference.\nLegacy ",(0,r.jsx)(n.code,{children:"bridge.*"})," config keys are no longer part of the config schema."]}),"\n",(0,r.jsx)(n.h2,{id:"why-we-have-both",children:"Why we have both"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Security boundary"}),": the bridge exposes a small allowlist instead of the\nfull gateway API surface."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Pairing + node identity"}),": node admission is owned by the gateway and tied\nto a per-node token."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Discovery UX"}),": nodes can discover gateways via Bonjour on LAN, or connect\ndirectly over a tailnet."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Loopback WS"}),": the full WS control plane stays local unless tunneled via SSH."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"transport",children:"Transport"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"TCP, one JSON object per line (JSONL)."}),"\n",(0,r.jsxs)(n.li,{children:["Optional TLS (when ",(0,r.jsx)(n.code,{children:"bridge.tls.enabled"})," is true)."]}),"\n",(0,r.jsxs)(n.li,{children:["Legacy default listener port was ",(0,r.jsx)(n.code,{children:"18790"})," (current builds do not start a TCP bridge)."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["When TLS is enabled, discovery TXT records include ",(0,r.jsx)(n.code,{children:"bridgeTls=1"})," plus\n",(0,r.jsx)(n.code,{children:"bridgeTlsSha256"})," so nodes can pin the certificate."]}),"\n",(0,r.jsx)(n.h2,{id:"handshake--pairing",children:"Handshake + pairing"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Client sends ",(0,r.jsx)(n.code,{children:"hello"})," with node metadata + token (if already paired)."]}),"\n",(0,r.jsxs)(n.li,{children:["If not paired, gateway replies ",(0,r.jsx)(n.code,{children:"error"})," (",(0,r.jsx)(n.code,{children:"NOT_PAIRED"}),"/",(0,r.jsx)(n.code,{children:"UNAUTHORIZED"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Client sends ",(0,r.jsx)(n.code,{children:"pair-request"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Gateway waits for approval, then sends ",(0,r.jsx)(n.code,{children:"pair-ok"})," and ",(0,r.jsx)(n.code,{children:"hello-ok"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"hello-ok"})," returns ",(0,r.jsx)(n.code,{children:"serverName"})," and may include ",(0,r.jsx)(n.code,{children:"canvasHostUrl"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"frames",children:"Frames"}),"\n",(0,r.jsx)(n.p,{children:"Client \u2192 Gateway:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"req"})," / ",(0,r.jsx)(n.code,{children:"res"}),": scoped gateway RPC (chat, sessions, config, health, voicewake, skills.bins)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"event"}),": node signals (voice transcript, agent request, chat subscribe, exec lifecycle)"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Gateway \u2192 Client:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"invoke"})," / ",(0,r.jsx)(n.code,{children:"invoke-res"}),": node commands (",(0,r.jsx)(n.code,{children:"canvas.*"}),", ",(0,r.jsx)(n.code,{children:"camera.*"}),", ",(0,r.jsx)(n.code,{children:"screen.record"}),",\n",(0,r.jsx)(n.code,{children:"location.get"}),", ",(0,r.jsx)(n.code,{children:"sms.send"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"event"}),": chat updates for subscribed sessions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ping"})," / ",(0,r.jsx)(n.code,{children:"pong"}),": keepalive"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Legacy allowlist enforcement lived in ",(0,r.jsx)(n.code,{children:"src/gateway/server-bridge.ts"})," (removed)."]}),"\n",(0,r.jsx)(n.h2,{id:"exec-lifecycle-events",children:"Exec lifecycle events"}),"\n",(0,r.jsxs)(n.p,{children:["Nodes can emit ",(0,r.jsx)(n.code,{children:"exec.finished"})," or ",(0,r.jsx)(n.code,{children:"exec.denied"})," events to surface system.run activity.\nThese are mapped to system events in the gateway. (Legacy nodes may still emit ",(0,r.jsx)(n.code,{children:"exec.started"}),".)"]}),"\n",(0,r.jsx)(n.p,{children:"Payload fields (all optional unless noted):"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"sessionKey"})," (required): agent session to receive the system event."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"runId"}),": unique exec id for grouping."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"command"}),": raw or formatted command string."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"exitCode"}),", ",(0,r.jsx)(n.code,{children:"timedOut"}),", ",(0,r.jsx)(n.code,{children:"success"}),", ",(0,r.jsx)(n.code,{children:"output"}),": completion details (finished only)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"reason"}),": denial reason (denied only)."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"tailnet-usage",children:"Tailnet usage"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Bind the bridge to a tailnet IP: ",(0,r.jsx)(n.code,{children:'bridge.bind: "tailnet"'})," in\n",(0,r.jsx)(n.code,{children:"~/.clawdbot/moltbot.json"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Clients connect via MagicDNS name or tailnet IP."}),"\n",(0,r.jsxs)(n.li,{children:["Bonjour does ",(0,r.jsx)(n.strong,{children:"not"})," cross networks; use manual host/port or wide-area DNS\u2011SD\nwhen needed."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"versioning",children:"Versioning"}),"\n",(0,r.jsxs)(n.p,{children:["Bridge is currently ",(0,r.jsx)(n.strong,{children:"implicit v1"})," (no min/max negotiation). Backward\u2011compat\nis expected; add a bridge protocol version field before any breaking changes."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},28453(e,n,i){i.d(n,{R:()=>d,x:()=>l});var s=i(96540);const r={},o=s.createContext(r);function d(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);