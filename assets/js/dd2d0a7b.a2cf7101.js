"use strict";(globalThis.webpackChunkdocs_workspace=globalThis.webpackChunkdocs_workspace||[]).push([[999],{81925(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"gateway/index","title":"Gateway service runbook","description":"Last updated: 2025-12-09","source":"@site/content/moltbot/docs/gateway/index.md","sourceDirName":"gateway","slug":"/gateway/","permalink":"/moltbot-doc/docs/gateway/","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"summary":"Runbook for the Gateway service, lifecycle, and operations","read_when":["Running or debugging the gateway process"]}}');var l=s(74848),t=s(28453);const r={summary:"Runbook for the Gateway service, lifecycle, and operations",read_when:["Running or debugging the gateway process"]},o="Gateway service runbook",c={},d=[{value:"What it is",id:"what-it-is",level:2},{value:"How to run (local)",id:"how-to-run-local",level:2},{value:"Remote access",id:"remote-access",level:2},{value:"Multiple gateways (same host)",id:"multiple-gateways-same-host",level:2},{value:"Dev profile (<code>--dev</code>)",id:"dev-profile---dev",level:3},{value:"Protocol (operator view)",id:"protocol-operator-view",level:2},{value:"Methods (initial set)",id:"methods-initial-set",level:2},{value:"Events",id:"events",level:2},{value:"WebChat integration",id:"webchat-integration",level:2},{value:"Typing and validation",id:"typing-and-validation",level:2},{value:"Connection snapshot",id:"connection-snapshot",level:2},{value:"Error codes (res.error shape)",id:"error-codes-reserror-shape",level:2},{value:"Keepalive behavior",id:"keepalive-behavior",level:2},{value:"Replay / gaps",id:"replay--gaps",level:2},{value:"Supervision (macOS example)",id:"supervision-macos-example",level:2},{value:"Gateway service management (CLI)",id:"gateway-service-management-cli",level:2},{value:"Supervision (systemd user unit)",id:"supervision-systemd-user-unit",level:2},{value:"Windows (WSL2)",id:"windows-wsl2",level:2},{value:"Operational checks",id:"operational-checks",level:2},{value:"Safety guarantees",id:"safety-guarantees",level:2},{value:"CLI helpers",id:"cli-helpers",level:2},{value:"Migration guidance",id:"migration-guidance",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"gateway-service-runbook",children:"Gateway service runbook"})}),"\n",(0,l.jsx)(n.p,{children:"Last updated: 2025-12-09"}),"\n",(0,l.jsx)(n.h2,{id:"what-it-is",children:"What it is"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"The always-on process that owns the single Baileys/Telegram connection and the control/event plane."}),"\n",(0,l.jsxs)(n.li,{children:["Replaces the legacy ",(0,l.jsx)(n.code,{children:"gateway"})," command. CLI entry point: ",(0,l.jsx)(n.code,{children:"moltbot gateway"}),"."]}),"\n",(0,l.jsx)(n.li,{children:"Runs until stopped; exits non-zero on fatal errors so the supervisor restarts it."}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"how-to-run-local",children:"How to run (local)"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"moltbot gateway --port 18789\n# for full debug/trace logs in stdio:\nmoltbot gateway --port 18789 --verbose\n# if the port is busy, terminate listeners then start:\nmoltbot gateway --force\n# dev loop (auto-reload on TS changes):\npnpm gateway:watch\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Config hot reload watches ",(0,l.jsx)(n.code,{children:"~/.clawdbot/moltbot.json"})," (or ",(0,l.jsx)(n.code,{children:"CLAWDBOT_CONFIG_PATH"}),").\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Default mode: ",(0,l.jsx)(n.code,{children:'gateway.reload.mode="hybrid"'})," (hot-apply safe changes, restart on critical)."]}),"\n",(0,l.jsxs)(n.li,{children:["Hot reload uses in-process restart via ",(0,l.jsx)(n.strong,{children:"SIGUSR1"})," when needed."]}),"\n",(0,l.jsxs)(n.li,{children:["Disable with ",(0,l.jsx)(n.code,{children:'gateway.reload.mode="off"'}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["Binds WebSocket control plane to ",(0,l.jsx)(n.code,{children:"127.0.0.1:<port>"})," (default 18789)."]}),"\n",(0,l.jsxs)(n.li,{children:["The same port also serves HTTP (control UI, hooks, A2UI). Single-port multiplex.\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["OpenAI Chat Completions (HTTP): ",(0,l.jsx)(n.a,{href:"/gateway/openai-http-api",children:(0,l.jsx)(n.code,{children:"/v1/chat/completions"})}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["OpenResponses (HTTP): ",(0,l.jsx)(n.a,{href:"/gateway/openresponses-http-api",children:(0,l.jsx)(n.code,{children:"/v1/responses"})}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["Tools Invoke (HTTP): ",(0,l.jsx)(n.a,{href:"/gateway/tools-invoke-http-api",children:(0,l.jsx)(n.code,{children:"/tools/invoke"})}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["Starts a Canvas file server by default on ",(0,l.jsx)(n.code,{children:"canvasHost.port"})," (default ",(0,l.jsx)(n.code,{children:"18793"}),"), serving ",(0,l.jsx)(n.code,{children:"http://<gateway-host>:18793/__moltbot__/canvas/"})," from ",(0,l.jsx)(n.code,{children:"~/clawd/canvas"}),". Disable with ",(0,l.jsx)(n.code,{children:"canvasHost.enabled=false"})," or ",(0,l.jsx)(n.code,{children:"CLAWDBOT_SKIP_CANVAS_HOST=1"}),"."]}),"\n",(0,l.jsx)(n.li,{children:"Logs to stdout; use launchd/systemd to keep it alive and rotate logs."}),"\n",(0,l.jsxs)(n.li,{children:["Pass ",(0,l.jsx)(n.code,{children:"--verbose"})," to mirror debug logging (handshakes, req/res, events) from the log file into stdio when troubleshooting."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"--force"})," uses ",(0,l.jsx)(n.code,{children:"lsof"})," to find listeners on the chosen port, sends SIGTERM, logs what it killed, then starts the gateway (fails fast if ",(0,l.jsx)(n.code,{children:"lsof"})," is missing)."]}),"\n",(0,l.jsxs)(n.li,{children:["If you run under a supervisor (launchd/systemd/mac app child-process mode), a stop/restart typically sends ",(0,l.jsx)(n.strong,{children:"SIGTERM"}),"; older builds may surface this as ",(0,l.jsx)(n.code,{children:"pnpm"})," ",(0,l.jsx)(n.code,{children:"ELIFECYCLE"})," exit code ",(0,l.jsx)(n.strong,{children:"143"})," (SIGTERM), which is a normal shutdown, not a crash."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"SIGUSR1"})," triggers an in-process restart when authorized (gateway tool/config apply/update, or enable ",(0,l.jsx)(n.code,{children:"commands.restart"})," for manual restarts)."]}),"\n",(0,l.jsxs)(n.li,{children:["Gateway auth is required by default: set ",(0,l.jsx)(n.code,{children:"gateway.auth.token"})," (or ",(0,l.jsx)(n.code,{children:"CLAWDBOT_GATEWAY_TOKEN"}),") or ",(0,l.jsx)(n.code,{children:"gateway.auth.password"}),". Clients must send ",(0,l.jsx)(n.code,{children:"connect.params.auth.token/password"})," unless using Tailscale Serve identity."]}),"\n",(0,l.jsx)(n.li,{children:"The wizard now generates a token by default, even on loopback."}),"\n",(0,l.jsxs)(n.li,{children:["Port precedence: ",(0,l.jsx)(n.code,{children:"--port"})," > ",(0,l.jsx)(n.code,{children:"CLAWDBOT_GATEWAY_PORT"})," > ",(0,l.jsx)(n.code,{children:"gateway.port"})," > default ",(0,l.jsx)(n.code,{children:"18789"}),"."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"remote-access",children:"Remote access"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Tailscale/VPN preferred; otherwise SSH tunnel:\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"ssh -N -L 18789:127.0.0.1:18789 user@host\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["Clients then connect to ",(0,l.jsx)(n.code,{children:"ws://127.0.0.1:18789"})," through the tunnel."]}),"\n",(0,l.jsxs)(n.li,{children:["If a token is configured, clients must include it in ",(0,l.jsx)(n.code,{children:"connect.params.auth.token"})," even over the tunnel."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"multiple-gateways-same-host",children:"Multiple gateways (same host)"}),"\n",(0,l.jsx)(n.p,{children:"Usually unnecessary: one Gateway can serve multiple messaging channels and agents. Use multiple Gateways only for redundancy or strict isolation (ex: rescue bot)."}),"\n",(0,l.jsxs)(n.p,{children:["Supported if you isolate state + config and use unique ports. Full guide: ",(0,l.jsx)(n.a,{href:"/gateway/multiple-gateways",children:"Multiple gateways"}),"."]}),"\n",(0,l.jsx)(n.p,{children:"Service names are profile-aware:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["macOS: ",(0,l.jsx)(n.code,{children:"bot.molt.<profile>"})," (legacy ",(0,l.jsx)(n.code,{children:"com.clawdbot.*"})," may still exist)"]}),"\n",(0,l.jsxs)(n.li,{children:["Linux: ",(0,l.jsx)(n.code,{children:"moltbot-gateway-<profile>.service"})]}),"\n",(0,l.jsxs)(n.li,{children:["Windows: ",(0,l.jsx)(n.code,{children:"Moltbot Gateway (<profile>)"})]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Install metadata is embedded in the service config:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"CLAWDBOT_SERVICE_MARKER=moltbot"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"CLAWDBOT_SERVICE_KIND=gateway"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"CLAWDBOT_SERVICE_VERSION=<version>"})}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["Rescue-Bot Pattern: keep a second Gateway isolated with its own profile, state dir, workspace, and base port spacing. Full guide: ",(0,l.jsx)(n.a,{href:"/gateway/multiple-gateways#rescue-bot-guide",children:"Rescue-bot guide"}),"."]}),"\n",(0,l.jsxs)(n.h3,{id:"dev-profile---dev",children:["Dev profile (",(0,l.jsx)(n.code,{children:"--dev"}),")"]}),"\n",(0,l.jsx)(n.p,{children:"Fast path: run a fully-isolated dev instance (config/state/workspace) without touching your primary setup."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"moltbot --dev setup\nmoltbot --dev gateway --allow-unconfigured\n# then target the dev instance:\nmoltbot --dev status\nmoltbot --dev health\n"})}),"\n",(0,l.jsx)(n.p,{children:"Defaults (can be overridden via env/flags/config):"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"CLAWDBOT_STATE_DIR=~/.clawdbot-dev"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"CLAWDBOT_CONFIG_PATH=~/.clawdbot-dev/moltbot.json"})}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"CLAWDBOT_GATEWAY_PORT=19001"})," (Gateway WS + HTTP)"]}),"\n",(0,l.jsxs)(n.li,{children:["browser control service port = ",(0,l.jsx)(n.code,{children:"19003"})," (derived: ",(0,l.jsx)(n.code,{children:"gateway.port+2"}),", loopback only)"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"canvasHost.port=19005"})," (derived: ",(0,l.jsx)(n.code,{children:"gateway.port+4"}),")"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"agents.defaults.workspace"})," default becomes ",(0,l.jsx)(n.code,{children:"~/clawd-dev"})," when you run ",(0,l.jsx)(n.code,{children:"setup"}),"/",(0,l.jsx)(n.code,{children:"onboard"})," under ",(0,l.jsx)(n.code,{children:"--dev"}),"."]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Derived ports (rules of thumb):"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Base port = ",(0,l.jsx)(n.code,{children:"gateway.port"})," (or ",(0,l.jsx)(n.code,{children:"CLAWDBOT_GATEWAY_PORT"})," / ",(0,l.jsx)(n.code,{children:"--port"}),")"]}),"\n",(0,l.jsx)(n.li,{children:"browser control service port = base + 2 (loopback only)"}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"canvasHost.port = base + 4"})," (or ",(0,l.jsx)(n.code,{children:"CLAWDBOT_CANVAS_HOST_PORT"})," / config override)"]}),"\n",(0,l.jsxs)(n.li,{children:["Browser profile CDP ports auto-allocate from ",(0,l.jsx)(n.code,{children:"browser.controlPort + 9 .. + 108"})," (persisted per profile)."]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Checklist per instance:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["unique ",(0,l.jsx)(n.code,{children:"gateway.port"})]}),"\n",(0,l.jsxs)(n.li,{children:["unique ",(0,l.jsx)(n.code,{children:"CLAWDBOT_CONFIG_PATH"})]}),"\n",(0,l.jsxs)(n.li,{children:["unique ",(0,l.jsx)(n.code,{children:"CLAWDBOT_STATE_DIR"})]}),"\n",(0,l.jsxs)(n.li,{children:["unique ",(0,l.jsx)(n.code,{children:"agents.defaults.workspace"})]}),"\n",(0,l.jsx)(n.li,{children:"separate WhatsApp numbers (if using WA)"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Service install per profile:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"moltbot --profile main gateway install\nmoltbot --profile rescue gateway install\n"})}),"\n",(0,l.jsx)(n.p,{children:"Example:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"CLAWDBOT_CONFIG_PATH=~/.clawdbot/a.json CLAWDBOT_STATE_DIR=~/.clawdbot-a moltbot gateway --port 19001\nCLAWDBOT_CONFIG_PATH=~/.clawdbot/b.json CLAWDBOT_STATE_DIR=~/.clawdbot-b moltbot gateway --port 19002\n"})}),"\n",(0,l.jsx)(n.h2,{id:"protocol-operator-view",children:"Protocol (operator view)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Full docs: ",(0,l.jsx)(n.a,{href:"/gateway/protocol",children:"Gateway protocol"})," and ",(0,l.jsx)(n.a,{href:"/gateway/bridge-protocol",children:"Bridge protocol (legacy)"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["Mandatory first frame from client: ",(0,l.jsx)(n.code,{children:'req {type:"req", id, method:"connect", params:{minProtocol,maxProtocol,client:{id,displayName?,version,platform,deviceFamily?,modelIdentifier?,mode,instanceId?}, caps, auth?, locale?, userAgent? } }'}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["Gateway replies ",(0,l.jsx)(n.code,{children:'res {type:"res", id, ok:true, payload:hello-ok }'})," (or ",(0,l.jsx)(n.code,{children:"ok:false"})," with an error, then closes)."]}),"\n",(0,l.jsxs)(n.li,{children:["After handshake:\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Requests: ",(0,l.jsx)(n.code,{children:'{type:"req", id, method, params}'})," \u2192 ",(0,l.jsx)(n.code,{children:'{type:"res", id, ok, payload|error}'})]}),"\n",(0,l.jsxs)(n.li,{children:["Events: ",(0,l.jsx)(n.code,{children:'{type:"event", event, payload, seq?, stateVersion?}'})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["Structured presence entries: ",(0,l.jsx)(n.code,{children:"{host, ip, version, platform?, deviceFamily?, modelIdentifier?, mode, lastInputSeconds?, ts, reason?, tags?[], instanceId? }"})," (for WS clients, ",(0,l.jsx)(n.code,{children:"instanceId"})," comes from ",(0,l.jsx)(n.code,{children:"connect.client.instanceId"}),")."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"agent"})," responses are two-stage: first ",(0,l.jsx)(n.code,{children:"res"})," ack ",(0,l.jsx)(n.code,{children:'{runId,status:"accepted"}'}),", then a final ",(0,l.jsx)(n.code,{children:"res"})," ",(0,l.jsx)(n.code,{children:'{runId,status:"ok"|"error",summary}'})," after the run finishes; streamed output arrives as ",(0,l.jsx)(n.code,{children:'event:"agent"'}),"."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"methods-initial-set",children:"Methods (initial set)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"health"})," \u2014 full health snapshot (same shape as ",(0,l.jsx)(n.code,{children:"moltbot health --json"}),")."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"status"})," \u2014 short summary."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"system-presence"})," \u2014 current presence list."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"system-event"})," \u2014 post a presence/system note (structured)."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"send"})," \u2014 send a message via the active channel(s)."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"agent"})," \u2014 run an agent turn (streams events back on same connection)."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"node.list"})," \u2014 list paired + currently-connected nodes (includes ",(0,l.jsx)(n.code,{children:"caps"}),", ",(0,l.jsx)(n.code,{children:"deviceFamily"}),", ",(0,l.jsx)(n.code,{children:"modelIdentifier"}),", ",(0,l.jsx)(n.code,{children:"paired"}),", ",(0,l.jsx)(n.code,{children:"connected"}),", and advertised ",(0,l.jsx)(n.code,{children:"commands"}),")."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"node.describe"})," \u2014 describe a node (capabilities + supported ",(0,l.jsx)(n.code,{children:"node.invoke"})," commands; works for paired nodes and for currently-connected unpaired nodes)."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"node.invoke"})," \u2014 invoke a command on a node (e.g. ",(0,l.jsx)(n.code,{children:"canvas.*"}),", ",(0,l.jsx)(n.code,{children:"camera.*"}),")."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"node.pair.*"})," \u2014 pairing lifecycle (",(0,l.jsx)(n.code,{children:"request"}),", ",(0,l.jsx)(n.code,{children:"list"}),", ",(0,l.jsx)(n.code,{children:"approve"}),", ",(0,l.jsx)(n.code,{children:"reject"}),", ",(0,l.jsx)(n.code,{children:"verify"}),")."]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["See also: ",(0,l.jsx)(n.a,{href:"/concepts/presence",children:"Presence"})," for how presence is produced/deduped and why a stable ",(0,l.jsx)(n.code,{children:"client.instanceId"})," matters."]}),"\n",(0,l.jsx)(n.h2,{id:"events",children:"Events"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"agent"})," \u2014 streamed tool/output events from the agent run (seq-tagged)."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"presence"})," \u2014 presence updates (deltas with stateVersion) pushed to all connected clients."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"tick"})," \u2014 periodic keepalive/no-op to confirm liveness."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"shutdown"})," \u2014 Gateway is exiting; payload includes ",(0,l.jsx)(n.code,{children:"reason"})," and optional ",(0,l.jsx)(n.code,{children:"restartExpectedMs"}),". Clients should reconnect."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"webchat-integration",children:"WebChat integration"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"WebChat is a native SwiftUI UI that talks directly to the Gateway WebSocket for history, sends, abort, and events."}),"\n",(0,l.jsxs)(n.li,{children:["Remote use goes through the same SSH/Tailscale tunnel; if a gateway token is configured, the client includes it during ",(0,l.jsx)(n.code,{children:"connect"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["macOS app connects via a single WS (shared connection); it hydrates presence from the initial snapshot and listens for ",(0,l.jsx)(n.code,{children:"presence"})," events to update the UI."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"typing-and-validation",children:"Typing and validation"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Server validates every inbound frame with AJV against JSON Schema emitted from the protocol definitions."}),"\n",(0,l.jsx)(n.li,{children:"Clients (TS/Swift) consume generated types (TS directly; Swift via the repo\u2019s generator)."}),"\n",(0,l.jsxs)(n.li,{children:["Protocol definitions are the source of truth; regenerate schema/models with:\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"pnpm protocol:gen"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"pnpm protocol:gen:swift"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"connection-snapshot",children:"Connection snapshot"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"hello-ok"})," includes a ",(0,l.jsx)(n.code,{children:"snapshot"})," with ",(0,l.jsx)(n.code,{children:"presence"}),", ",(0,l.jsx)(n.code,{children:"health"}),", ",(0,l.jsx)(n.code,{children:"stateVersion"}),", and ",(0,l.jsx)(n.code,{children:"uptimeMs"})," plus ",(0,l.jsx)(n.code,{children:"policy {maxPayload,maxBufferedBytes,tickIntervalMs}"})," so clients can render immediately without extra requests."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"health"}),"/",(0,l.jsx)(n.code,{children:"system-presence"})," remain available for manual refresh, but are not required at connect time."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"error-codes-reserror-shape",children:"Error codes (res.error shape)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Errors use ",(0,l.jsx)(n.code,{children:"{ code, message, details?, retryable?, retryAfterMs? }"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["Standard codes:\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"NOT_LINKED"})," \u2014 WhatsApp not authenticated."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"AGENT_TIMEOUT"})," \u2014 agent did not respond within the configured deadline."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"INVALID_REQUEST"})," \u2014 schema/param validation failed."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"UNAVAILABLE"})," \u2014 Gateway is shutting down or a dependency is unavailable."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"keepalive-behavior",children:"Keepalive behavior"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"tick"})," events (or WS ping/pong) are emitted periodically so clients know the Gateway is alive even when no traffic occurs."]}),"\n",(0,l.jsx)(n.li,{children:"Send/agent acknowledgements remain separate responses; do not overload ticks for sends."}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"replay--gaps",children:"Replay / gaps"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Events are not replayed. Clients detect seq gaps and should refresh (",(0,l.jsx)(n.code,{children:"health"})," + ",(0,l.jsx)(n.code,{children:"system-presence"}),") before continuing. WebChat and macOS clients now auto-refresh on gap."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"supervision-macos-example",children:"Supervision (macOS example)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Use launchd to keep the service alive:\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Program: path to ",(0,l.jsx)(n.code,{children:"moltbot"})]}),"\n",(0,l.jsxs)(n.li,{children:["Arguments: ",(0,l.jsx)(n.code,{children:"gateway"})]}),"\n",(0,l.jsx)(n.li,{children:"KeepAlive: true"}),"\n",(0,l.jsxs)(n.li,{children:["StandardOut/Err: file paths or ",(0,l.jsx)(n.code,{children:"syslog"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"On failure, launchd restarts; fatal misconfig should keep exiting so the operator notices."}),"\n",(0,l.jsxs)(n.li,{children:["LaunchAgents are per-user and require a logged-in session; for headless setups use a custom LaunchDaemon (not shipped).\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"moltbot gateway install"})," writes ",(0,l.jsx)(n.code,{children:"~/Library/LaunchAgents/bot.molt.gateway.plist"}),"\n(or ",(0,l.jsx)(n.code,{children:"bot.molt.<profile>.plist"}),"; legacy ",(0,l.jsx)(n.code,{children:"com.clawdbot.*"})," is cleaned up)."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"moltbot doctor"})," audits the LaunchAgent config and can update it to current defaults."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"gateway-service-management-cli",children:"Gateway service management (CLI)"}),"\n",(0,l.jsx)(n.p,{children:"Use the Gateway CLI for install/start/stop/restart/status:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"moltbot gateway status\nmoltbot gateway install\nmoltbot gateway stop\nmoltbot gateway restart\nmoltbot logs --follow\n"})}),"\n",(0,l.jsx)(n.p,{children:"Notes:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"gateway status"})," probes the Gateway RPC by default using the service\u2019s resolved port/config (override with ",(0,l.jsx)(n.code,{children:"--url"}),")."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"gateway status --deep"})," adds system-level scans (LaunchDaemons/system units)."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"gateway status --no-probe"})," skips the RPC probe (useful when networking is down)."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"gateway status --json"})," is stable for scripts."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"gateway status"})," reports ",(0,l.jsx)(n.strong,{children:"supervisor runtime"})," (launchd/systemd running) separately from ",(0,l.jsx)(n.strong,{children:"RPC reachability"})," (WS connect + status RPC)."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"gateway status"})," prints config path + probe target to avoid \u201clocalhost vs LAN bind\u201d confusion and profile mismatches."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"gateway status"})," includes the last gateway error line when the service looks running but the port is closed."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"logs"})," tails the Gateway file log via RPC (no manual ",(0,l.jsx)(n.code,{children:"tail"}),"/",(0,l.jsx)(n.code,{children:"grep"})," needed)."]}),"\n",(0,l.jsxs)(n.li,{children:["If other gateway-like services are detected, the CLI warns unless they are Moltbot profile services.\nWe still recommend ",(0,l.jsx)(n.strong,{children:"one gateway per machine"})," for most setups; use isolated profiles/ports for redundancy or a rescue bot. See ",(0,l.jsx)(n.a,{href:"/gateway/multiple-gateways",children:"Multiple gateways"}),".\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Cleanup: ",(0,l.jsx)(n.code,{children:"moltbot gateway uninstall"})," (current service) and ",(0,l.jsx)(n.code,{children:"moltbot doctor"})," (legacy migrations)."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"gateway install"})," is a no-op when already installed; use ",(0,l.jsx)(n.code,{children:"moltbot gateway install --force"})," to reinstall (profile/env/path changes)."]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Bundled mac app:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Moltbot.app can bundle a Node-based gateway relay and install a per-user LaunchAgent labeled\n",(0,l.jsx)(n.code,{children:"bot.molt.gateway"})," (or ",(0,l.jsx)(n.code,{children:"bot.molt.<profile>"}),"; legacy ",(0,l.jsx)(n.code,{children:"com.clawdbot.*"})," labels still unload cleanly)."]}),"\n",(0,l.jsxs)(n.li,{children:["To stop it cleanly, use ",(0,l.jsx)(n.code,{children:"moltbot gateway stop"})," (or ",(0,l.jsx)(n.code,{children:"launchctl bootout gui/$UID/bot.molt.gateway"}),")."]}),"\n",(0,l.jsxs)(n.li,{children:["To restart, use ",(0,l.jsx)(n.code,{children:"moltbot gateway restart"})," (or ",(0,l.jsx)(n.code,{children:"launchctl kickstart -k gui/$UID/bot.molt.gateway"}),").\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"launchctl"})," only works if the LaunchAgent is installed; otherwise use ",(0,l.jsx)(n.code,{children:"moltbot gateway install"})," first."]}),"\n",(0,l.jsxs)(n.li,{children:["Replace the label with ",(0,l.jsx)(n.code,{children:"bot.molt.<profile>"})," when running a named profile."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"supervision-systemd-user-unit",children:"Supervision (systemd user unit)"}),"\n",(0,l.jsxs)(n.p,{children:["Moltbot installs a ",(0,l.jsx)(n.strong,{children:"systemd user service"})," by default on Linux/WSL2. We\nrecommend user services for single-user machines (simpler env, per-user config).\nUse a ",(0,l.jsx)(n.strong,{children:"system service"})," for multi-user or always-on servers (no lingering\nrequired, shared supervision)."]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"moltbot gateway install"})," writes the user unit. ",(0,l.jsx)(n.code,{children:"moltbot doctor"})," audits the\nunit and can update it to match the current recommended defaults."]}),"\n",(0,l.jsxs)(n.p,{children:["Create ",(0,l.jsx)(n.code,{children:"~/.config/systemd/user/moltbot-gateway[-<profile>].service"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"[Unit]\nDescription=Moltbot Gateway (profile: <profile>, v<version>)\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nExecStart=/usr/local/bin/moltbot gateway --port 18789\nRestart=always\nRestartSec=5\nEnvironment=CLAWDBOT_GATEWAY_TOKEN=\nWorkingDirectory=/home/youruser\n\n[Install]\nWantedBy=default.target\n"})}),"\n",(0,l.jsx)(n.p,{children:"Enable lingering (required so the user service survives logout/idle):"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"sudo loginctl enable-linger youruser\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Onboarding runs this on Linux/WSL2 (may prompt for sudo; writes ",(0,l.jsx)(n.code,{children:"/var/lib/systemd/linger"}),").\nThen enable the service:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"systemctl --user enable --now moltbot-gateway[-<profile>].service\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Alternative (system service)"})," - for always-on or multi-user servers, you can\ninstall a systemd ",(0,l.jsx)(n.strong,{children:"system"})," unit instead of a user unit (no lingering needed).\nCreate ",(0,l.jsx)(n.code,{children:"/etc/systemd/system/moltbot-gateway[-<profile>].service"})," (copy the unit above,\nswitch ",(0,l.jsx)(n.code,{children:"WantedBy=multi-user.target"}),", set ",(0,l.jsx)(n.code,{children:"User="})," + ",(0,l.jsx)(n.code,{children:"WorkingDirectory="}),"), then:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"sudo systemctl daemon-reload\nsudo systemctl enable --now moltbot-gateway[-<profile>].service\n"})}),"\n",(0,l.jsx)(n.h2,{id:"windows-wsl2",children:"Windows (WSL2)"}),"\n",(0,l.jsxs)(n.p,{children:["Windows installs should use ",(0,l.jsx)(n.strong,{children:"WSL2"})," and follow the Linux systemd section above."]}),"\n",(0,l.jsx)(n.h2,{id:"operational-checks",children:"Operational checks"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Liveness: open WS and send ",(0,l.jsx)(n.code,{children:"req:connect"})," \u2192 expect ",(0,l.jsx)(n.code,{children:"res"})," with ",(0,l.jsx)(n.code,{children:'payload.type="hello-ok"'})," (with snapshot)."]}),"\n",(0,l.jsxs)(n.li,{children:["Readiness: call ",(0,l.jsx)(n.code,{children:"health"})," \u2192 expect ",(0,l.jsx)(n.code,{children:"ok: true"})," and a linked channel in ",(0,l.jsx)(n.code,{children:"linkChannel"})," (when applicable)."]}),"\n",(0,l.jsxs)(n.li,{children:["Debug: subscribe to ",(0,l.jsx)(n.code,{children:"tick"})," and ",(0,l.jsx)(n.code,{children:"presence"})," events; ensure ",(0,l.jsx)(n.code,{children:"status"})," shows linked/auth age; presence entries show Gateway host and connected clients."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"safety-guarantees",children:"Safety guarantees"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Assume one Gateway per host by default; if you run multiple profiles, isolate ports/state and target the right instance."}),"\n",(0,l.jsx)(n.li,{children:"No fallback to direct Baileys connections; if the Gateway is down, sends fail fast."}),"\n",(0,l.jsx)(n.li,{children:"Non-connect first frames or malformed JSON are rejected and the socket is closed."}),"\n",(0,l.jsxs)(n.li,{children:["Graceful shutdown: emit ",(0,l.jsx)(n.code,{children:"shutdown"})," event before closing; clients must handle close + reconnect."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"cli-helpers",children:"CLI helpers"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"moltbot gateway health|status"})," \u2014 request health/status over the Gateway WS."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:'moltbot message send --target <num> --message "hi" [--media ...]'})," \u2014 send via Gateway (idempotent for WhatsApp)."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:'moltbot agent --message "hi" --to <num>'})," \u2014 run an agent turn (waits for final by default)."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:'moltbot gateway call <method> --params \'{"k":"v"}\''})," \u2014 raw method invoker for debugging."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"moltbot gateway stop|restart"})," \u2014 stop/restart the supervised gateway service (launchd/systemd)."]}),"\n",(0,l.jsxs)(n.li,{children:["Gateway helper subcommands assume a running gateway on ",(0,l.jsx)(n.code,{children:"--url"}),"; they no longer auto-spawn one."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"migration-guidance",children:"Migration guidance"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Retire uses of ",(0,l.jsx)(n.code,{children:"moltbot gateway"})," and the legacy TCP control port."]}),"\n",(0,l.jsx)(n.li,{children:"Update clients to speak the WS protocol with mandatory connect and structured presence."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}},28453(e,n,s){s.d(n,{R:()=>r,x:()=>o});var i=s(96540);const l={},t=i.createContext(l);function r(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:r(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);