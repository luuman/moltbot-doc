"use strict";(globalThis.webpackChunkdocs_workspace=globalThis.webpackChunkdocs_workspace||[]).push([[2896],{64239(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>l,toc:()=>a});const l=JSON.parse('{"id":"refactor/clawnet","title":"Clawnet refactor (protocol + auth unification)","description":"Hi","source":"@site/content/moltbot/docs/refactor/clawnet.md","sourceDirName":"refactor","slug":"/refactor/clawnet","permalink":"/moltbot-doc/docs/refactor/clawnet","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"summary":"Clawnet refactor: unify network protocol, roles, auth, approvals, identity","read_when":["Planning a unified network protocol for nodes + operator clients","Reworking approvals, pairing, TLS, and presence across devices"]}}');var s=i(74848),r=i(28453);const o={summary:"Clawnet refactor: unify network protocol, roles, auth, approvals, identity",read_when:["Planning a unified network protocol for nodes + operator clients","Reworking approvals, pairing, TLS, and presence across devices"]},d="Clawnet refactor (protocol + auth unification)",c={},a=[{value:"Hi",id:"hi",level:2},{value:"Purpose",id:"purpose",level:2},{value:"Goals (from discussion)",id:"goals-from-discussion",level:2},{value:"Non\u2011goals (explicit)",id:"nongoals-explicit",level:2},{value:"Two protocols",id:"two-protocols",level:2},{value:"1) Gateway WebSocket (control plane)",id:"1-gateway-websocket-control-plane",level:3},{value:"2) Bridge (node transport)",id:"2-bridge-node-transport",level:3},{value:"Control plane clients today",id:"control-plane-clients-today",level:2},{value:"Nodes today",id:"nodes-today",level:2},{value:"Current approval flow (exec)",id:"current-approval-flow-exec",level:2},{value:"Presence + identity today",id:"presence--identity-today",level:2},{value:"One protocol, two roles",id:"one-protocol-two-roles",level:2},{value:"Role behaviors",id:"role-behaviors",level:3},{value:"Key rule",id:"key-rule",level:3},{value:"Client identity",id:"client-identity",level:2},{value:"Pairing flow (unified)",id:"pairing-flow-unified",level:2},{value:"Device\u2011bound auth (avoid bearer token replay)",id:"devicebound-auth-avoid-bearer-token-replay",level:2},{value:"Silent approval (SSH heuristic)",id:"silent-approval-ssh-heuristic",level:2},{value:"Reuse existing bridge TLS",id:"reuse-existing-bridge-tls",level:2},{value:"Apply to WS",id:"apply-to-ws",level:2},{value:"Why",id:"why",level:2},{value:"Current",id:"current",level:2},{value:"Proposed",id:"proposed",level:2},{value:"New flow",id:"new-flow",level:3},{value:"Approval semantics (hardening)",id:"approval-semantics-hardening",level:3},{value:"Benefits",id:"benefits",level:2},{value:"iPhone app",id:"iphone-app",level:2},{value:"macOS app",id:"macos-app",level:2},{value:"CLI",id:"cli",level:2},{value:"Stable ID",id:"stable-id",level:2},{value:"Cute slug (lobster\u2011themed)",id:"cute-slug-lobsterthemed",level:2},{value:"UI grouping",id:"ui-grouping",level:2},{value:"Phase 0: Document + align",id:"phase-0-document--align",level:2},{value:"Phase 1: Add roles/scopes to WS",id:"phase-1-add-rolesscopes-to-ws",level:2},{value:"Phase 2: Bridge compatibility",id:"phase-2-bridge-compatibility",level:2},{value:"Phase 3: Central approvals",id:"phase-3-central-approvals",level:2},{value:"Phase 4: TLS unification",id:"phase-4-tls-unification",level:2},{value:"Phase 5: Deprecate bridge",id:"phase-5-deprecate-bridge",level:2},{value:"Phase 6: Device\u2011bound auth",id:"phase-6-devicebound-auth",level:2}];function t(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"clawnet-refactor-protocol--auth-unification",children:"Clawnet refactor (protocol + auth unification)"})}),"\n",(0,s.jsx)(n.h2,{id:"hi",children:"Hi"}),"\n",(0,s.jsx)(n.p,{children:"Hi Peter \u2014 great direction; this unlocks simpler UX + stronger security."}),"\n",(0,s.jsx)(n.h2,{id:"purpose",children:"Purpose"}),"\n",(0,s.jsx)(n.p,{children:"Single, rigorous document for:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Current state: protocols, flows, trust boundaries."}),"\n",(0,s.jsx)(n.li,{children:"Pain points: approvals, multi\u2011hop routing, UI duplication."}),"\n",(0,s.jsx)(n.li,{children:"Proposed new state: one protocol, scoped roles, unified auth/pairing, TLS pinning."}),"\n",(0,s.jsx)(n.li,{children:"Identity model: stable IDs + cute slugs."}),"\n",(0,s.jsx)(n.li,{children:"Migration plan, risks, open questions."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"goals-from-discussion",children:"Goals (from discussion)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"One protocol for all clients (mac app, CLI, iOS, Android, headless node)."}),"\n",(0,s.jsx)(n.li,{children:"Every network participant authenticated + paired."}),"\n",(0,s.jsx)(n.li,{children:"Role clarity: nodes vs operators."}),"\n",(0,s.jsx)(n.li,{children:"Central approvals routed to where the user is."}),"\n",(0,s.jsx)(n.li,{children:"TLS encryption + optional pinning for all remote traffic."}),"\n",(0,s.jsx)(n.li,{children:"Minimal code duplication."}),"\n",(0,s.jsx)(n.li,{children:"Single machine should appear once (no UI/node duplicate entry)."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"nongoals-explicit",children:"Non\u2011goals (explicit)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Remove capability separation (still need least\u2011privilege)."}),"\n",(0,s.jsx)(n.li,{children:"Expose full gateway control plane without scope checks."}),"\n",(0,s.jsx)(n.li,{children:"Make auth depend on human labels (slugs remain non\u2011security)."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"current-state-asis",children:"Current state (as\u2011is)"}),"\n",(0,s.jsx)(n.h2,{id:"two-protocols",children:"Two protocols"}),"\n",(0,s.jsx)(n.h3,{id:"1-gateway-websocket-control-plane",children:"1) Gateway WebSocket (control plane)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Full API surface: config, channels, models, sessions, agent runs, logs, nodes, etc."}),"\n",(0,s.jsx)(n.li,{children:"Default bind: loopback. Remote access via SSH/Tailscale."}),"\n",(0,s.jsxs)(n.li,{children:["Auth: token/password via ",(0,s.jsx)(n.code,{children:"connect"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"No TLS pinning (relies on loopback/tunnel)."}),"\n",(0,s.jsxs)(n.li,{children:["Code:\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"src/gateway/server/ws-connection/message-handler.ts"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"src/gateway/client.ts"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"docs/gateway/protocol.md"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"2-bridge-node-transport",children:"2) Bridge (node transport)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Narrow allowlist surface, node identity + pairing."}),"\n",(0,s.jsx)(n.li,{children:"JSONL over TCP; optional TLS + cert fingerprint pinning."}),"\n",(0,s.jsx)(n.li,{children:"TLS advertises fingerprint in discovery TXT."}),"\n",(0,s.jsxs)(n.li,{children:["Code:\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"src/infra/bridge/server/connection.ts"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"src/gateway/server-bridge.ts"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"src/node-host/bridge-client.ts"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"docs/gateway/bridge-protocol.md"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"control-plane-clients-today",children:"Control plane clients today"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["CLI \u2192 Gateway WS via ",(0,s.jsx)(n.code,{children:"callGateway"})," (",(0,s.jsx)(n.code,{children:"src/gateway/call.ts"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["macOS app UI \u2192 Gateway WS (",(0,s.jsx)(n.code,{children:"GatewayConnection"}),")."]}),"\n",(0,s.jsx)(n.li,{children:"Web Control UI \u2192 Gateway WS."}),"\n",(0,s.jsx)(n.li,{children:"ACP \u2192 Gateway WS."}),"\n",(0,s.jsx)(n.li,{children:"Browser control uses its own HTTP control server."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"nodes-today",children:"Nodes today"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["macOS app in node mode connects to Gateway bridge (",(0,s.jsx)(n.code,{children:"MacNodeBridgeSession"}),")."]}),"\n",(0,s.jsx)(n.li,{children:"iOS/Android apps connect to Gateway bridge."}),"\n",(0,s.jsx)(n.li,{children:"Pairing + per\u2011node token stored on gateway."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"current-approval-flow-exec",children:"Current approval flow (exec)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Agent uses ",(0,s.jsx)(n.code,{children:"system.run"})," via Gateway."]}),"\n",(0,s.jsx)(n.li,{children:"Gateway invokes node over bridge."}),"\n",(0,s.jsx)(n.li,{children:"Node runtime decides approval."}),"\n",(0,s.jsx)(n.li,{children:"UI prompt shown by mac app (when node == mac app)."}),"\n",(0,s.jsxs)(n.li,{children:["Node returns ",(0,s.jsx)(n.code,{children:"invoke-res"})," to Gateway."]}),"\n",(0,s.jsx)(n.li,{children:"Multi\u2011hop, UI tied to node host."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"presence--identity-today",children:"Presence + identity today"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Gateway presence entries from WS clients."}),"\n",(0,s.jsx)(n.li,{children:"Node presence entries from bridge."}),"\n",(0,s.jsx)(n.li,{children:"mac app can show two entries for same machine (UI + node)."}),"\n",(0,s.jsx)(n.li,{children:"Node identity stored in pairing store; UI identity separate."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"problems--pain-points",children:"Problems / pain points"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Two protocol stacks to maintain (WS + Bridge)."}),"\n",(0,s.jsx)(n.li,{children:"Approvals on remote nodes: prompt appears on node host, not where user is."}),"\n",(0,s.jsx)(n.li,{children:"TLS pinning only exists for bridge; WS depends on SSH/Tailscale."}),"\n",(0,s.jsx)(n.li,{children:"Identity duplication: same machine shows as multiple instances."}),"\n",(0,s.jsx)(n.li,{children:"Ambiguous roles: UI + node + CLI capabilities not clearly separated."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"proposed-new-state-clawnet",children:"Proposed new state (Clawnet)"}),"\n",(0,s.jsx)(n.h2,{id:"one-protocol-two-roles",children:"One protocol, two roles"}),"\n",(0,s.jsx)(n.p,{children:"Single WS protocol with role + scope."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Role: node"})," (capability host)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Role: operator"})," (control plane)"]}),"\n",(0,s.jsxs)(n.li,{children:["Optional ",(0,s.jsx)(n.strong,{children:"scope"})," for operator:\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"operator.read"})," (status + viewing)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"operator.write"})," (agent run, sends)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"operator.admin"})," (config, channels, models)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"role-behaviors",children:"Role behaviors"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Node"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Can register capabilities (",(0,s.jsx)(n.code,{children:"caps"}),", ",(0,s.jsx)(n.code,{children:"commands"}),", permissions)."]}),"\n",(0,s.jsxs)(n.li,{children:["Can receive ",(0,s.jsx)(n.code,{children:"invoke"})," commands (",(0,s.jsx)(n.code,{children:"system.run"}),", ",(0,s.jsx)(n.code,{children:"camera.*"}),", ",(0,s.jsx)(n.code,{children:"canvas.*"}),", ",(0,s.jsx)(n.code,{children:"screen.record"}),", etc)."]}),"\n",(0,s.jsxs)(n.li,{children:["Can send events: ",(0,s.jsx)(n.code,{children:"voice.transcript"}),", ",(0,s.jsx)(n.code,{children:"agent.request"}),", ",(0,s.jsx)(n.code,{children:"chat.subscribe"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Cannot call config/models/channels/sessions/agent control plane APIs."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Operator"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Full control plane API, gated by scope."}),"\n",(0,s.jsx)(n.li,{children:"Receives all approvals."}),"\n",(0,s.jsx)(n.li,{children:"Does not directly execute OS actions; routes to nodes."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"key-rule",children:"Key rule"}),"\n",(0,s.jsx)(n.p,{children:"Role is per\u2011connection, not per device. A device may open both roles, separately."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"unified-authentication--pairing",children:"Unified authentication + pairing"}),"\n",(0,s.jsx)(n.h2,{id:"client-identity",children:"Client identity"}),"\n",(0,s.jsx)(n.p,{children:"Every client provides:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"deviceId"})," (stable, derived from device key)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"displayName"})," (human name)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"role"})," + ",(0,s.jsx)(n.code,{children:"scope"})," + ",(0,s.jsx)(n.code,{children:"caps"})," + ",(0,s.jsx)(n.code,{children:"commands"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"pairing-flow-unified",children:"Pairing flow (unified)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Client connects unauthenticated."}),"\n",(0,s.jsxs)(n.li,{children:["Gateway creates a ",(0,s.jsx)(n.strong,{children:"pairing request"})," for that ",(0,s.jsx)(n.code,{children:"deviceId"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Operator receives prompt; approves/denies."}),"\n",(0,s.jsxs)(n.li,{children:["Gateway issues credentials bound to:\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"device public key"}),"\n",(0,s.jsx)(n.li,{children:"role(s)"}),"\n",(0,s.jsx)(n.li,{children:"scope(s)"}),"\n",(0,s.jsx)(n.li,{children:"capabilities/commands"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"Client persists token, reconnects authenticated."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"devicebound-auth-avoid-bearer-token-replay",children:"Device\u2011bound auth (avoid bearer token replay)"}),"\n",(0,s.jsx)(n.p,{children:"Preferred: device keypairs."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Device generates keypair once."}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"deviceId = fingerprint(publicKey)"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Gateway sends nonce; device signs; gateway verifies."}),"\n",(0,s.jsx)(n.li,{children:"Tokens are issued to a public key (proof\u2011of\u2011possession), not a string."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Alternatives:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"mTLS (client certs): strongest, more ops complexity."}),"\n",(0,s.jsx)(n.li,{children:"Short\u2011lived bearer tokens only as a temporary phase (rotate + revoke early)."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"silent-approval-ssh-heuristic",children:"Silent approval (SSH heuristic)"}),"\n",(0,s.jsx)(n.p,{children:"Define it precisely to avoid a weak link. Prefer one:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Local\u2011only"}),": auto\u2011pair when client connects via loopback/Unix socket."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Challenge via SSH"}),": gateway issues nonce; client proves SSH by fetching it."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Physical presence window"}),": after a local approval on gateway host UI, allow auto\u2011pair for a short window (e.g. 10 minutes)."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Always log + record auto\u2011approvals."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"tls-everywhere-dev--prod",children:"TLS everywhere (dev + prod)"}),"\n",(0,s.jsx)(n.h2,{id:"reuse-existing-bridge-tls",children:"Reuse existing bridge TLS"}),"\n",(0,s.jsx)(n.p,{children:"Use current TLS runtime + fingerprint pinning:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"src/infra/bridge/server/tls.ts"})}),"\n",(0,s.jsxs)(n.li,{children:["fingerprint verification logic in ",(0,s.jsx)(n.code,{children:"src/node-host/bridge-client.ts"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"apply-to-ws",children:"Apply to WS"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"WS server supports TLS with same cert/key + fingerprint."}),"\n",(0,s.jsx)(n.li,{children:"WS clients can pin fingerprint (optional)."}),"\n",(0,s.jsxs)(n.li,{children:["Discovery advertises TLS + fingerprint for all endpoints.\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Discovery is locator hints only; never a trust anchor."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"why",children:"Why"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Reduce reliance on SSH/Tailscale for confidentiality."}),"\n",(0,s.jsx)(n.li,{children:"Make remote mobile connections safe by default."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"approvals-redesign-centralized",children:"Approvals redesign (centralized)"}),"\n",(0,s.jsx)(n.h2,{id:"current",children:"Current"}),"\n",(0,s.jsx)(n.p,{children:"Approval happens on node host (mac app node runtime). Prompt appears where node runs."}),"\n",(0,s.jsx)(n.h2,{id:"proposed",children:"Proposed"}),"\n",(0,s.jsxs)(n.p,{children:["Approval is ",(0,s.jsx)(n.strong,{children:"gateway\u2011hosted"}),", UI delivered to operator clients."]}),"\n",(0,s.jsx)(n.h3,{id:"new-flow",children:"New flow"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Gateway receives ",(0,s.jsx)(n.code,{children:"system.run"})," intent (agent)."]}),"\n",(0,s.jsxs)(n.li,{children:["Gateway creates approval record: ",(0,s.jsx)(n.code,{children:"approval.requested"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Operator UI(s) show prompt."}),"\n",(0,s.jsxs)(n.li,{children:["Approval decision sent to gateway: ",(0,s.jsx)(n.code,{children:"approval.resolve"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Gateway invokes node command if approved."}),"\n",(0,s.jsxs)(n.li,{children:["Node executes, returns ",(0,s.jsx)(n.code,{children:"invoke-res"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"approval-semantics-hardening",children:"Approval semantics (hardening)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Broadcast to all operators; only the active UI shows a modal (others get a toast)."}),"\n",(0,s.jsx)(n.li,{children:"First resolution wins; gateway rejects subsequent resolves as already settled."}),"\n",(0,s.jsx)(n.li,{children:"Default timeout: deny after N seconds (e.g. 60s), log reason."}),"\n",(0,s.jsxs)(n.li,{children:["Resolution requires ",(0,s.jsx)(n.code,{children:"operator.approvals"})," scope."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"benefits",children:"Benefits"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Prompt appears where user is (mac/phone)."}),"\n",(0,s.jsx)(n.li,{children:"Consistent approvals for remote nodes."}),"\n",(0,s.jsx)(n.li,{children:"Node runtime stays headless; no UI dependency."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"role-clarity-examples",children:"Role clarity examples"}),"\n",(0,s.jsx)(n.h2,{id:"iphone-app",children:"iPhone app"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Node role"})," for: mic, camera, voice chat, location, push\u2011to\u2011talk."]}),"\n",(0,s.jsxs)(n.li,{children:["Optional ",(0,s.jsx)(n.strong,{children:"operator.read"})," for status and chat view."]}),"\n",(0,s.jsxs)(n.li,{children:["Optional ",(0,s.jsx)(n.strong,{children:"operator.write/admin"})," only when explicitly enabled."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"macos-app",children:"macOS app"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Operator role by default (control UI)."}),"\n",(0,s.jsx)(n.li,{children:"Node role when \u201cMac node\u201d enabled (system.run, screen, camera)."}),"\n",(0,s.jsx)(n.li,{children:"Same deviceId for both connections \u2192 merged UI entry."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"cli",children:"CLI"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Operator role always."}),"\n",(0,s.jsxs)(n.li,{children:["Scope derived by subcommand:\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"status"}),", ",(0,s.jsx)(n.code,{children:"logs"})," \u2192 read"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"agent"}),", ",(0,s.jsx)(n.code,{children:"message"})," \u2192 write"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"config"}),", ",(0,s.jsx)(n.code,{children:"channels"})," \u2192 admin"]}),"\n",(0,s.jsxs)(n.li,{children:["approvals + pairing \u2192 ",(0,s.jsx)(n.code,{children:"operator.approvals"})," / ",(0,s.jsx)(n.code,{children:"operator.pairing"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"identity--slugs",children:"Identity + slugs"}),"\n",(0,s.jsx)(n.h2,{id:"stable-id",children:"Stable ID"}),"\n",(0,s.jsx)(n.p,{children:"Required for auth; never changes.\nPreferred:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Keypair fingerprint (public key hash)."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"cute-slug-lobsterthemed",children:"Cute slug (lobster\u2011themed)"}),"\n",(0,s.jsx)(n.p,{children:"Human label only."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Example: ",(0,s.jsx)(n.code,{children:"scarlet-claw"}),", ",(0,s.jsx)(n.code,{children:"saltwave"}),", ",(0,s.jsx)(n.code,{children:"mantis-pinch"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Stored in gateway registry, editable."}),"\n",(0,s.jsxs)(n.li,{children:["Collision handling: ",(0,s.jsx)(n.code,{children:"-2"}),", ",(0,s.jsx)(n.code,{children:"-3"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"ui-grouping",children:"UI grouping"}),"\n",(0,s.jsxs)(n.p,{children:["Same ",(0,s.jsx)(n.code,{children:"deviceId"})," across roles \u2192 single \u201cInstance\u201d row:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Badge: ",(0,s.jsx)(n.code,{children:"operator"}),", ",(0,s.jsx)(n.code,{children:"node"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Shows capabilities + last seen."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"migration-strategy",children:"Migration strategy"}),"\n",(0,s.jsx)(n.h2,{id:"phase-0-document--align",children:"Phase 0: Document + align"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Publish this doc."}),"\n",(0,s.jsx)(n.li,{children:"Inventory all protocol calls + approval flows."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"phase-1-add-rolesscopes-to-ws",children:"Phase 1: Add roles/scopes to WS"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Extend ",(0,s.jsx)(n.code,{children:"connect"})," params with ",(0,s.jsx)(n.code,{children:"role"}),", ",(0,s.jsx)(n.code,{children:"scope"}),", ",(0,s.jsx)(n.code,{children:"deviceId"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Add allowlist gating for node role."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"phase-2-bridge-compatibility",children:"Phase 2: Bridge compatibility"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Keep bridge running."}),"\n",(0,s.jsx)(n.li,{children:"Add WS node support in parallel."}),"\n",(0,s.jsx)(n.li,{children:"Gate features behind config flag."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"phase-3-central-approvals",children:"Phase 3: Central approvals"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Add approval request + resolve events in WS."}),"\n",(0,s.jsx)(n.li,{children:"Update mac app UI to prompt + respond."}),"\n",(0,s.jsx)(n.li,{children:"Node runtime stops prompting UI."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"phase-4-tls-unification",children:"Phase 4: TLS unification"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Add TLS config for WS using bridge TLS runtime."}),"\n",(0,s.jsx)(n.li,{children:"Add pinning to clients."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"phase-5-deprecate-bridge",children:"Phase 5: Deprecate bridge"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Migrate iOS/Android/mac node to WS."}),"\n",(0,s.jsx)(n.li,{children:"Keep bridge as fallback; remove once stable."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"phase-6-devicebound-auth",children:"Phase 6: Device\u2011bound auth"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Require key\u2011based identity for all non\u2011local connections."}),"\n",(0,s.jsx)(n.li,{children:"Add revocation + rotation UI."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"security-notes",children:"Security notes"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Role/allowlist enforced at gateway boundary."}),"\n",(0,s.jsx)(n.li,{children:"No client gets \u201cfull\u201d API without operator scope."}),"\n",(0,s.jsxs)(n.li,{children:["Pairing required for ",(0,s.jsx)(n.em,{children:"all"})," connections."]}),"\n",(0,s.jsx)(n.li,{children:"TLS + pinning reduces MITM risk for mobile."}),"\n",(0,s.jsx)(n.li,{children:"SSH silent approval is a convenience; still recorded + revocable."}),"\n",(0,s.jsx)(n.li,{children:"Discovery is never a trust anchor."}),"\n",(0,s.jsx)(n.li,{children:"Capability claims are verified against server allowlists by platform/type."}),"\n"]}),"\n",(0,s.jsx)(n.h1,{id:"streaming--large-payloads-node-media",children:"Streaming + large payloads (node media)"}),"\n",(0,s.jsx)(n.p,{children:"WS control plane is fine for small messages, but nodes also do:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"camera clips"}),"\n",(0,s.jsx)(n.li,{children:"screen recordings"}),"\n",(0,s.jsx)(n.li,{children:"audio streams"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Options:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"WS binary frames + chunking + backpressure rules."}),"\n",(0,s.jsx)(n.li,{children:"Separate streaming endpoint (still TLS + auth)."}),"\n",(0,s.jsx)(n.li,{children:"Keep bridge longer for media\u2011heavy commands, migrate last."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Pick one before implementation to avoid drift."}),"\n",(0,s.jsx)(n.h1,{id:"capability--command-policy",children:"Capability + command policy"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Node\u2011reported caps/commands are treated as ",(0,s.jsx)(n.strong,{children:"claims"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Gateway enforces per\u2011platform allowlists."}),"\n",(0,s.jsx)(n.li,{children:"Any new command requires operator approval or explicit allowlist change."}),"\n",(0,s.jsx)(n.li,{children:"Audit changes with timestamps."}),"\n"]}),"\n",(0,s.jsx)(n.h1,{id:"audit--rate-limiting",children:"Audit + rate limiting"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Log: pairing requests, approvals/denials, token issuance/rotation/revocation."}),"\n",(0,s.jsx)(n.li,{children:"Rate\u2011limit pairing spam and approval prompts."}),"\n"]}),"\n",(0,s.jsx)(n.h1,{id:"protocol-hygiene",children:"Protocol hygiene"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Explicit protocol version + error codes."}),"\n",(0,s.jsx)(n.li,{children:"Reconnect rules + heartbeat policy."}),"\n",(0,s.jsx)(n.li,{children:"Presence TTL and last\u2011seen semantics."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"open-questions",children:"Open questions"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Single device running both roles: token model"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Recommend separate tokens per role (node vs operator)."}),"\n",(0,s.jsx)(n.li,{children:"Same deviceId; different scopes; clearer revocation."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Operator scope granularity"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"read/write/admin + approvals + pairing (minimum viable)."}),"\n",(0,s.jsx)(n.li,{children:"Consider per\u2011feature scopes later."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Token rotation + revocation UX"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Auto\u2011rotate on role change."}),"\n",(0,s.jsx)(n.li,{children:"UI to revoke by deviceId + role."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Discovery"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Extend current Bonjour TXT to include WS TLS fingerprint + role hints."}),"\n",(0,s.jsx)(n.li,{children:"Treat as locator hints only."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Cross\u2011network approval"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Broadcast to all operator clients; active UI shows modal."}),"\n",(0,s.jsx)(n.li,{children:"First response wins; gateway enforces atomicity."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h1,{id:"summary-tldr",children:"Summary (TL;DR)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Today: WS control plane + Bridge node transport."}),"\n",(0,s.jsx)(n.li,{children:"Pain: approvals + duplication + two stacks."}),"\n",(0,s.jsx)(n.li,{children:"Proposal: one WS protocol with explicit roles + scopes, unified pairing + TLS pinning, gateway\u2011hosted approvals, stable device IDs + cute slugs."}),"\n",(0,s.jsx)(n.li,{children:"Outcome: simpler UX, stronger security, less duplication, better mobile routing."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(t,{...e})}):t(e)}},28453(e,n,i){i.d(n,{R:()=>o,x:()=>d});var l=i(96540);const s={},r=l.createContext(s);function o(e){const n=l.useContext(r);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),l.createElement(r.Provider,{value:n},e.children)}}}]);