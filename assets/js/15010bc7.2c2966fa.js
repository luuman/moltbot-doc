"use strict";(globalThis.webpackChunkdocs_workspace=globalThis.webpackChunkdocs_workspace||[]).push([[1464],{98275(e,n,s){s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>l,toc:()=>t});const l=JSON.parse('{"id":"refactor/exec-host","title":"Exec host refactor plan","description":"Goals","source":"@site/content/moltbot/docs/refactor/exec-host.md","sourceDirName":"refactor","slug":"/refactor/exec-host","permalink":"/moltbot-doc/docs/refactor/exec-host","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"summary":"Refactor plan: exec host routing, node approvals, and headless runner","read_when":["Designing exec host routing or exec approvals","Implementing node runner + UI IPC","Adding exec host security modes and slash commands"]}}');var i=s(74848),o=s(28453);const d={summary:"Refactor plan: exec host routing, node approvals, and headless runner",read_when:["Designing exec host routing or exec approvals","Implementing node runner + UI IPC","Adding exec host security modes and slash commands"]},c="Exec host refactor plan",r={},t=[{value:"Goals",id:"goals",level:2},{value:"Non-goals",id:"non-goals",level:2},{value:"Decisions (locked)",id:"decisions-locked",level:2},{value:"Key concepts",id:"key-concepts",level:2},{value:"Host",id:"host",level:3},{value:"Security mode",id:"security-mode",level:3},{value:"Ask mode",id:"ask-mode",level:3},{value:"Policy resolution (per exec)",id:"policy-resolution-per-exec",level:3},{value:"Default safety",id:"default-safety",level:2},{value:"Config surface",id:"config-surface",level:2},{value:"Tool parameters",id:"tool-parameters",level:3},{value:"Config keys (global)",id:"config-keys-global",level:3},{value:"Config keys (per agent)",id:"config-keys-per-agent",level:3},{value:"Alias",id:"alias",level:3},{value:"Approvals store (JSON)",id:"approvals-store-json",level:2},{value:"Runner service (headless)",id:"runner-service-headless",level:2},{value:"Role",id:"role",level:3},{value:"Service lifecycle",id:"service-lifecycle",level:3},{value:"UI integration (macOS app)",id:"ui-integration-macos-app",level:2},{value:"IPC",id:"ipc",level:3},{value:"Ask flow (macOS app exec host)",id:"ask-flow-macos-app-exec-host",level:3},{value:"Diagram (SCI)",id:"diagram-sci",level:3},{value:"Node identity + binding",id:"node-identity--binding",level:2},{value:"Eventing",id:"eventing",level:2},{value:"Who sees events",id:"who-sees-events",level:3},{value:"Event text",id:"event-text",level:3},{value:"Transport",id:"transport",level:3},{value:"Exec flows",id:"exec-flows",level:2},{value:"Sandbox host",id:"sandbox-host",level:3},{value:"Gateway host",id:"gateway-host",level:3},{value:"Node host",id:"node-host",level:3},{value:"Output caps",id:"output-caps",level:2},{value:"Slash commands",id:"slash-commands",level:2},{value:"Cross-platform story",id:"cross-platform-story",level:2},{value:"Implementation phases",id:"implementation-phases",level:2},{value:"Phase 1: config + exec routing",id:"phase-1-config--exec-routing",level:3},{value:"Phase 2: approvals store + gateway enforcement",id:"phase-2-approvals-store--gateway-enforcement",level:3},{value:"Phase 3: node runner enforcement",id:"phase-3-node-runner-enforcement",level:3},{value:"Phase 4: events",id:"phase-4-events",level:3},{value:"Phase 5: UI polish",id:"phase-5-ui-polish",level:3},{value:"Testing plan",id:"testing-plan",level:2},{value:"Open risks",id:"open-risks",level:2},{value:"Related docs",id:"related-docs",level:2}];function a(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"exec-host-refactor-plan",children:"Exec host refactor plan"})}),"\n",(0,i.jsx)(n.h2,{id:"goals",children:"Goals"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Add ",(0,i.jsx)(n.code,{children:"exec.host"})," + ",(0,i.jsx)(n.code,{children:"exec.security"})," to route execution across ",(0,i.jsx)(n.strong,{children:"sandbox"}),", ",(0,i.jsx)(n.strong,{children:"gateway"}),", and ",(0,i.jsx)(n.strong,{children:"node"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Keep defaults ",(0,i.jsx)(n.strong,{children:"safe"}),": no cross-host execution unless explicitly enabled."]}),"\n",(0,i.jsxs)(n.li,{children:["Split execution into a ",(0,i.jsx)(n.strong,{children:"headless runner service"})," with optional UI (macOS app) via local IPC."]}),"\n",(0,i.jsxs)(n.li,{children:["Provide ",(0,i.jsx)(n.strong,{children:"per-agent"})," policy, allowlist, ask mode, and node binding."]}),"\n",(0,i.jsxs)(n.li,{children:["Support ",(0,i.jsx)(n.strong,{children:"ask modes"})," that work ",(0,i.jsx)(n.em,{children:"with"})," or ",(0,i.jsx)(n.em,{children:"without"})," allowlists."]}),"\n",(0,i.jsx)(n.li,{children:"Cross-platform: Unix socket + token auth (macOS/Linux/Windows parity)."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"non-goals",children:"Non-goals"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"No legacy allowlist migration or legacy schema support."}),"\n",(0,i.jsx)(n.li,{children:"No PTY/streaming for node exec (aggregated output only)."}),"\n",(0,i.jsx)(n.li,{children:"No new network layer beyond the existing Bridge + Gateway."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"decisions-locked",children:"Decisions (locked)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Config keys:"})," ",(0,i.jsx)(n.code,{children:"exec.host"})," + ",(0,i.jsx)(n.code,{children:"exec.security"})," (per-agent override allowed)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Elevation:"})," keep ",(0,i.jsx)(n.code,{children:"/elevated"})," as an alias for gateway full access."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Ask default:"})," ",(0,i.jsx)(n.code,{children:"on-miss"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Approvals store:"})," ",(0,i.jsx)(n.code,{children:"~/.clawdbot/exec-approvals.json"})," (JSON, no legacy migration)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Runner:"})," headless system service; UI app hosts a Unix socket for approvals."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Node identity:"})," use existing ",(0,i.jsx)(n.code,{children:"nodeId"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Socket auth:"})," Unix socket + token (cross-platform); split later if needed."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Node host state:"})," ",(0,i.jsx)(n.code,{children:"~/.clawdbot/node.json"})," (node id + pairing token)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"macOS exec host:"})," run ",(0,i.jsx)(n.code,{children:"system.run"})," inside the macOS app; node host service forwards requests over local IPC."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"No XPC helper:"})," stick to Unix socket + token + peer checks."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"key-concepts",children:"Key concepts"}),"\n",(0,i.jsx)(n.h3,{id:"host",children:"Host"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"sandbox"}),": Docker exec (current behavior)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"gateway"}),": exec on gateway host."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"node"}),": exec on node runner via Bridge (",(0,i.jsx)(n.code,{children:"system.run"}),")."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"security-mode",children:"Security mode"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"deny"}),": always block."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"allowlist"}),": allow only matches."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"full"}),": allow everything (equivalent to elevated)."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"ask-mode",children:"Ask mode"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"off"}),": never ask."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"on-miss"}),": ask only when allowlist does not match."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"always"}),": ask every time."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Ask is ",(0,i.jsx)(n.strong,{children:"independent"})," of allowlist; allowlist can be used with ",(0,i.jsx)(n.code,{children:"always"})," or ",(0,i.jsx)(n.code,{children:"on-miss"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"policy-resolution-per-exec",children:"Policy resolution (per exec)"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Resolve ",(0,i.jsx)(n.code,{children:"exec.host"})," (tool param \u2192 agent override \u2192 global default)."]}),"\n",(0,i.jsxs)(n.li,{children:["Resolve ",(0,i.jsx)(n.code,{children:"exec.security"})," and ",(0,i.jsx)(n.code,{children:"exec.ask"})," (same precedence)."]}),"\n",(0,i.jsxs)(n.li,{children:["If host is ",(0,i.jsx)(n.code,{children:"sandbox"}),", proceed with local sandbox exec."]}),"\n",(0,i.jsxs)(n.li,{children:["If host is ",(0,i.jsx)(n.code,{children:"gateway"})," or ",(0,i.jsx)(n.code,{children:"node"}),", apply security + ask policy on that host."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"default-safety",children:"Default safety"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Default ",(0,i.jsx)(n.code,{children:"exec.host = sandbox"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Default ",(0,i.jsx)(n.code,{children:"exec.security = deny"})," for ",(0,i.jsx)(n.code,{children:"gateway"})," and ",(0,i.jsx)(n.code,{children:"node"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Default ",(0,i.jsx)(n.code,{children:"exec.ask = on-miss"})," (only relevant if security allows)."]}),"\n",(0,i.jsxs)(n.li,{children:["If no node binding is set, ",(0,i.jsx)(n.strong,{children:"agent may target any node"}),", but only if policy allows it."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"config-surface",children:"Config surface"}),"\n",(0,i.jsx)(n.h3,{id:"tool-parameters",children:"Tool parameters"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"exec.host"})," (optional): ",(0,i.jsx)(n.code,{children:"sandbox | gateway | node"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"exec.security"})," (optional): ",(0,i.jsx)(n.code,{children:"deny | allowlist | full"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"exec.ask"})," (optional): ",(0,i.jsx)(n.code,{children:"off | on-miss | always"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"exec.node"})," (optional): node id/name to use when ",(0,i.jsx)(n.code,{children:"host=node"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"config-keys-global",children:"Config keys (global)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"tools.exec.host"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"tools.exec.security"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"tools.exec.ask"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"tools.exec.node"})," (default node binding)"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"config-keys-per-agent",children:"Config keys (per agent)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"agents.list[].tools.exec.host"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"agents.list[].tools.exec.security"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"agents.list[].tools.exec.ask"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"agents.list[].tools.exec.node"})}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"alias",children:"Alias"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"/elevated on"})," = set ",(0,i.jsx)(n.code,{children:"tools.exec.host=gateway"}),", ",(0,i.jsx)(n.code,{children:"tools.exec.security=full"})," for the agent session."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"/elevated off"})," = restore previous exec settings for the agent session."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"approvals-store-json",children:"Approvals store (JSON)"}),"\n",(0,i.jsxs)(n.p,{children:["Path: ",(0,i.jsx)(n.code,{children:"~/.clawdbot/exec-approvals.json"})]}),"\n",(0,i.jsx)(n.p,{children:"Purpose:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Local policy + allowlists for the ",(0,i.jsx)(n.strong,{children:"execution host"})," (gateway or node runner)."]}),"\n",(0,i.jsx)(n.li,{children:"Ask fallback when no UI is available."}),"\n",(0,i.jsx)(n.li,{children:"IPC credentials for UI clients."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Proposed schema (v1):"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "version": 1,\n  "socket": {\n    "path": "~/.clawdbot/exec-approvals.sock",\n    "token": "base64-opaque-token"\n  },\n  "defaults": {\n    "security": "deny",\n    "ask": "on-miss",\n    "askFallback": "deny"\n  },\n  "agents": {\n    "agent-id-1": {\n      "security": "allowlist",\n      "ask": "on-miss",\n      "allowlist": [\n        {\n          "pattern": "~/Projects/**/bin/rg",\n          "lastUsedAt": 0,\n          "lastUsedCommand": "rg -n TODO",\n          "lastResolvedPath": "/Users/user/Projects/.../bin/rg"\n        }\n      ]\n    }\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Notes:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"No legacy allowlist formats."}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"askFallback"})," applies only when ",(0,i.jsx)(n.code,{children:"ask"})," is required and no UI is reachable."]}),"\n",(0,i.jsxs)(n.li,{children:["File permissions: ",(0,i.jsx)(n.code,{children:"0600"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"runner-service-headless",children:"Runner service (headless)"}),"\n",(0,i.jsx)(n.h3,{id:"role",children:"Role"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Enforce ",(0,i.jsx)(n.code,{children:"exec.security"})," + ",(0,i.jsx)(n.code,{children:"exec.ask"})," locally."]}),"\n",(0,i.jsx)(n.li,{children:"Execute system commands and return output."}),"\n",(0,i.jsx)(n.li,{children:"Emit Bridge events for exec lifecycle (optional but recommended)."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"service-lifecycle",children:"Service lifecycle"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Launchd/daemon on macOS; system service on Linux/Windows."}),"\n",(0,i.jsx)(n.li,{children:"Approvals JSON is local to the execution host."}),"\n",(0,i.jsx)(n.li,{children:"UI hosts a local Unix socket; runners connect on demand."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"ui-integration-macos-app",children:"UI integration (macOS app)"}),"\n",(0,i.jsx)(n.h3,{id:"ipc",children:"IPC"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Unix socket at ",(0,i.jsx)(n.code,{children:"~/.clawdbot/exec-approvals.sock"})," (0600)."]}),"\n",(0,i.jsxs)(n.li,{children:["Token stored in ",(0,i.jsx)(n.code,{children:"exec-approvals.json"})," (0600)."]}),"\n",(0,i.jsx)(n.li,{children:"Peer checks: same-UID only."}),"\n",(0,i.jsx)(n.li,{children:"Challenge/response: nonce + HMAC(token, request-hash) to prevent replay."}),"\n",(0,i.jsx)(n.li,{children:"Short TTL (e.g., 10s) + max payload + rate limit."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"ask-flow-macos-app-exec-host",children:"Ask flow (macOS app exec host)"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Node service receives ",(0,i.jsx)(n.code,{children:"system.run"})," from gateway."]}),"\n",(0,i.jsx)(n.li,{children:"Node service connects to the local socket and sends the prompt/exec request."}),"\n",(0,i.jsx)(n.li,{children:"App validates peer + token + HMAC + TTL, then shows dialog if needed."}),"\n",(0,i.jsx)(n.li,{children:"App executes the command in UI context and returns output."}),"\n",(0,i.jsx)(n.li,{children:"Node service returns output to gateway."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"If UI missing:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Apply ",(0,i.jsx)(n.code,{children:"askFallback"})," (",(0,i.jsx)(n.code,{children:"deny|allowlist|full"}),")."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"diagram-sci",children:"Diagram (SCI)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Agent -> Gateway -> Bridge -> Node Service (TS)\n                         |  IPC (UDS + token + HMAC + TTL)\n                         v\n                     Mac App (UI + TCC + system.run)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"node-identity--binding",children:"Node identity + binding"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Use existing ",(0,i.jsx)(n.code,{children:"nodeId"})," from Bridge pairing."]}),"\n",(0,i.jsxs)(n.li,{children:["Binding model:\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"tools.exec.node"})," restricts the agent to a specific node."]}),"\n",(0,i.jsx)(n.li,{children:"If unset, agent can pick any node (policy still enforces defaults)."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Node selection resolution:\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"nodeId"})," exact match"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"displayName"})," (normalized)"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"remoteIp"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"nodeId"})," prefix (>= 6 chars)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"eventing",children:"Eventing"}),"\n",(0,i.jsx)(n.h3,{id:"who-sees-events",children:"Who sees events"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["System events are ",(0,i.jsx)(n.strong,{children:"per session"})," and shown to the agent on the next prompt."]}),"\n",(0,i.jsxs)(n.li,{children:["Stored in the gateway in-memory queue (",(0,i.jsx)(n.code,{children:"enqueueSystemEvent"}),")."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"event-text",children:"Event text"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"Exec started (node=<id>, id=<runId>)"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Exec finished (node=<id>, id=<runId>, code=<code>)"})," + optional output tail"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"Exec denied (node=<id>, id=<runId>, <reason>)"})}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"transport",children:"Transport"}),"\n",(0,i.jsx)(n.p,{children:"Option A (recommended):"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Runner sends Bridge ",(0,i.jsx)(n.code,{children:"event"})," frames ",(0,i.jsx)(n.code,{children:"exec.started"})," / ",(0,i.jsx)(n.code,{children:"exec.finished"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Gateway ",(0,i.jsx)(n.code,{children:"handleBridgeEvent"})," maps these into ",(0,i.jsx)(n.code,{children:"enqueueSystemEvent"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Option B:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Gateway ",(0,i.jsx)(n.code,{children:"exec"})," tool handles lifecycle directly (synchronous only)."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"exec-flows",children:"Exec flows"}),"\n",(0,i.jsx)(n.h3,{id:"sandbox-host",children:"Sandbox host"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Existing ",(0,i.jsx)(n.code,{children:"exec"})," behavior (Docker or host when unsandboxed)."]}),"\n",(0,i.jsx)(n.li,{children:"PTY supported in non-sandbox mode only."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"gateway-host",children:"Gateway host"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Gateway process executes on its own machine."}),"\n",(0,i.jsxs)(n.li,{children:["Enforces local ",(0,i.jsx)(n.code,{children:"exec-approvals.json"})," (security/ask/allowlist)."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"node-host",children:"Node host"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Gateway calls ",(0,i.jsx)(n.code,{children:"node.invoke"})," with ",(0,i.jsx)(n.code,{children:"system.run"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Runner enforces local approvals."}),"\n",(0,i.jsx)(n.li,{children:"Runner returns aggregated stdout/stderr."}),"\n",(0,i.jsx)(n.li,{children:"Optional Bridge events for start/finish/deny."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"output-caps",children:"Output caps"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Cap combined stdout+stderr at ",(0,i.jsx)(n.strong,{children:"200k"}),"; keep ",(0,i.jsx)(n.strong,{children:"tail 20k"})," for events."]}),"\n",(0,i.jsxs)(n.li,{children:["Truncate with a clear suffix (e.g., ",(0,i.jsx)(n.code,{children:'"\u2026 (truncated)"'}),")."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"slash-commands",children:"Slash commands"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"/exec host=<sandbox|gateway|node> security=<deny|allowlist|full> ask=<off|on-miss|always> node=<id>"})}),"\n",(0,i.jsx)(n.li,{children:"Per-agent, per-session overrides; non-persistent unless saved via config."}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"/elevated on|off|ask|full"})," remains a shortcut for ",(0,i.jsx)(n.code,{children:"host=gateway security=full"})," (with ",(0,i.jsx)(n.code,{children:"full"})," skipping approvals)."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"cross-platform-story",children:"Cross-platform story"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The runner service is the portable execution target."}),"\n",(0,i.jsxs)(n.li,{children:["UI is optional; if missing, ",(0,i.jsx)(n.code,{children:"askFallback"})," applies."]}),"\n",(0,i.jsx)(n.li,{children:"Windows/Linux support the same approvals JSON + socket protocol."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"implementation-phases",children:"Implementation phases"}),"\n",(0,i.jsx)(n.h3,{id:"phase-1-config--exec-routing",children:"Phase 1: config + exec routing"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Add config schema for ",(0,i.jsx)(n.code,{children:"exec.host"}),", ",(0,i.jsx)(n.code,{children:"exec.security"}),", ",(0,i.jsx)(n.code,{children:"exec.ask"}),", ",(0,i.jsx)(n.code,{children:"exec.node"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Update tool plumbing to respect ",(0,i.jsx)(n.code,{children:"exec.host"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Add ",(0,i.jsx)(n.code,{children:"/exec"})," slash command and keep ",(0,i.jsx)(n.code,{children:"/elevated"})," alias."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"phase-2-approvals-store--gateway-enforcement",children:"Phase 2: approvals store + gateway enforcement"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Implement ",(0,i.jsx)(n.code,{children:"exec-approvals.json"})," reader/writer."]}),"\n",(0,i.jsxs)(n.li,{children:["Enforce allowlist + ask modes for ",(0,i.jsx)(n.code,{children:"gateway"})," host."]}),"\n",(0,i.jsx)(n.li,{children:"Add output caps."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"phase-3-node-runner-enforcement",children:"Phase 3: node runner enforcement"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Update node runner to enforce allowlist + ask."}),"\n",(0,i.jsx)(n.li,{children:"Add Unix socket prompt bridge to macOS app UI."}),"\n",(0,i.jsxs)(n.li,{children:["Wire ",(0,i.jsx)(n.code,{children:"askFallback"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"phase-4-events",children:"Phase 4: events"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Add node \u2192 gateway Bridge events for exec lifecycle."}),"\n",(0,i.jsxs)(n.li,{children:["Map to ",(0,i.jsx)(n.code,{children:"enqueueSystemEvent"})," for agent prompts."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"phase-5-ui-polish",children:"Phase 5: UI polish"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Mac app: allowlist editor, per-agent switcher, ask policy UI."}),"\n",(0,i.jsx)(n.li,{children:"Node binding controls (optional)."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"testing-plan",children:"Testing plan"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Unit tests: allowlist matching (glob + case-insensitive)."}),"\n",(0,i.jsx)(n.li,{children:"Unit tests: policy resolution precedence (tool param \u2192 agent override \u2192 global)."}),"\n",(0,i.jsx)(n.li,{children:"Integration tests: node runner deny/allow/ask flows."}),"\n",(0,i.jsx)(n.li,{children:"Bridge event tests: node event \u2192 system event routing."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"open-risks",children:"Open risks"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["UI unavailability: ensure ",(0,i.jsx)(n.code,{children:"askFallback"})," is respected."]}),"\n",(0,i.jsx)(n.li,{children:"Long-running commands: rely on timeout + output caps."}),"\n",(0,i.jsx)(n.li,{children:"Multi-node ambiguity: error unless node binding or explicit node param."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"related-docs",children:"Related docs"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/tools/exec",children:"Exec tool"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/tools/exec-approvals",children:"Exec approvals"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/nodes",children:"Nodes"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/tools/elevated",children:"Elevated mode"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},28453(e,n,s){s.d(n,{R:()=>d,x:()=>c});var l=s(96540);const i={},o=l.createContext(i);function d(e){const n=l.useContext(o);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),l.createElement(o.Provider,{value:n},e.children)}}}]);